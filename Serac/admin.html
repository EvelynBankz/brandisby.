<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sérac Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:"Be Vietnam Pro", sans-serif; background:#0a0a0a; color:#fff; line-height:1.6; }
  a { text-decoration:none; color:inherit; }

  header {
    position: sticky;
    top:0;
    z-index:1000;
    background:transparent;
    transition: background 0.3s ease;
    color:#fff;
    padding:1rem 2rem;
    font-size:1.8rem;
    font-weight:700;
    letter-spacing:1px;
    text-align:center;
  }
  header.scrolled { background:#000; }

  .container {
    max-width:1000px;
    margin:2rem auto;
    padding:2rem;
    background:#1a1a1a; /* same as customization.html form background */
    border-radius:12px;
    box-shadow:0 4px 16px rgba(0,0,0,0.7);
  }

  h2 { font-weight:700; margin-bottom:1rem; color:#fff; letter-spacing:0.5px; }
  h3 { font-weight:600; color:#fff; margin-top:1rem; }

  label { display:block; margin-top:1rem; font-weight:600; }
  input, textarea, select { width:100%; padding:0.6rem; margin-top:0.5rem; border:1px solid #444; border-radius:6px; font-size:1rem; background:#0a0a0a; color:#fff; }
  button { margin-top:1rem; padding:0.75rem 1.2rem; background:#8A4D2B; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700; transition:0.3s; } /* button color same as customization */
  button:hover { background:#a35d39; }

  .message { margin-top:1rem; font-weight:500; font-size:1rem; text-align:center; }

  table { width:100%; border-collapse:collapse; margin-top:1.5rem; background:#111; border:1px solid #333; border-radius:12px; overflow:hidden; }
  th, td { padding:0.75rem; border-bottom:1px solid #222; text-align:left; font-size:0.95rem; vertical-align:top; }
  th { background:#222; color:#fff; font-weight:700; }
  td img { width:60px; border-radius:6px; }

  .actions button { margin-right:0.5rem; padding:0.4rem 0.6rem; font-size:0.9rem; background:#8A4D2B; color:#fff; }
  .actions button:hover { background:#a35d39; }

  .small-note { font-size:0.9rem; color:#bbb; margin-top:8px; }

  .dashboard-nav { display:flex; gap:10px; margin-bottom:1.5rem; }
  .dashboard-nav button { flex:1; background:#8A4D2B; color:#fff; border:1px solid #8A4D2B; transition:0.3s; }
  .dashboard-nav button:hover { background:#a35d39; }

  .section { display:none; margin-top:1rem; }
  .section.active { display:block; }

  .details-row { background:#111; }
  .details-row td { padding:12px; }

  .order-filters { display:flex; gap:10px; margin-bottom:1rem; flex-wrap:wrap; }
  .order-filters input, .order-filters select { flex:1; max-width:320px; }

  .quote-item { border:1px solid #444; padding:8px; margin-top:8px; background:#111; border-radius:6px; }

  .copy-btn { background:none; border:none; cursor:pointer; margin-left:6px; font-size:1rem; color:#fff; }
  .copy-btn:hover { opacity:0.7; }

  .add-item-panel { border:1px dashed #444; padding:12px; margin-top:8px; background:#1a1a1a; border-radius:8px; } /* form panel same as customization */
  .inline-grid { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; }
  .repeatable { margin-top:8px; }
  .repeatable .row { display:flex; gap:8px; margin-top:8px; }
  .repeatable .row input { flex:1; }
  .repeatable .row button { flex-shrink:0; padding:0.4rem 0.6rem; background:#8A4D2B; color:#fff; border:none; border-radius:6px; }
  .repeatable .row button:hover { background:#a35d39; }

  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; z-index:9999; }
  .modal { background:#1a1a1a; color:#fff; padding:16px; border-radius:10px; max-width:800px; width:95%; max-height:90vh; overflow:auto; } /* modal bg same as customization */
  .modal .modal-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .modal .modal-body { margin-top:12px; }
  .modal .close { background:#8A4D2B; border:none; color:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; }
  .modal .close:hover { background:#a35d39; }

  @media(max-width:600px){
    .container { padding:1rem; }
    table, th, td { font-size:0.85rem; }
    th, td { padding:0.5rem; }
    .dashboard-nav { flex-direction:column; }
    .order-filters { flex-direction:column; }
    .inline-grid { grid-template-columns:1fr; }
  }
</style>
</head>
<body>

<header>Sérac Admin Dashboard</header>

<!-- LOGIN FORM -->
<div class="container" id="loginContainer">
  <h2>Admin Login</h2>
  <form id="loginForm">
    <label for="loginEmail">Email</label>
    <input type="email" id="loginEmail" required>
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" required>
    <button type="submit">Login</button>
    <div class="message" id="loginMessage"></div>
  </form>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboardContainer" style="display:none;">
  <div class="dashboard-nav">
    <button type="button" data-target="productsSection">📦 Products</button>
    <button type="button" data-target="quotesSection">💳 Quotes</button>
    <button type="button" data-target="ordersSection">🧾 Orders</button>
  </div>

  <!-- PRODUCTS -->
  <div class="section" id="productsSection">
    <h2>Manage Products</h2>
    <form id="productForm">
      <label>Name</label>
      <input type="text" id="productName" required>
      
      <label>Price (NGN)</label>
      <input type="number" id="productPriceNGN" step="0.01" inputmode="decimal" required>
      <label>Price (USD)</label>
      <input type="number" id="productPriceUSD" step="0.01" inputmode="decimal">
      <label>Price (EUR)</label>
      <input type="number" id="productPriceEUR" step="0.01" inputmode="decimal">
      <label>Price (GBP)</label>
      <input type="number" id="productPriceGBP" step="0.01" inputmode="decimal">
      
      <label>Description</label>
      <textarea id="productDesc"></textarea>

      <label>Sizes</label>
      <div id="sizesRepeat" class="repeatable"></div>
      <button type="button" id="addSizeBtn">+ Add Size</button>

      <label>Colors</label>
      <div id="colorsRepeat" class="repeatable"></div>
      <button type="button" id="addColorBtn">+ Add Color</button>

      <label>Images (URLs)</label>
      <div id="imagesRepeat" class="repeatable"></div>
      <button type="button" id="addImageBtn">+ Add Image</button>
      <div class="small-note">Add multiple image URLs. First image will be used as thumbnail.</div>
      
      <label>Customization Available</label>
      <select id="productCustom">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>

      <label>Published</label>
      <select id="productPublished">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>

      <button type="submit">Add Product</button>
    </form>
    <div id="productMessage" class="message"></div>

    <label>Table Currency:</label>
    <select id="tableCurrency">
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
    </select>

    <table id="productsTable">
      <thead>
        <tr><th>Name</th><th>Price</th><th>Image</th><th>Customization</th><th>Published</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- QUOTES -->
  <div class="section" id="quotesSection">
    <h2>Generate Quote</h2>
    <form id="quoteForm">
      <label>Customer Name</label>
      <input type="text" id="quoteCustomer" required>
      <label>Customer Email</label>
      <input type="email" id="quoteEmail" required>

      <h3>Quote Items</h3>
      <div id="addItemPanel" class="add-item-panel" style="display:none;">
        <label>Item Name</label>
        <input type="text" id="ai_name" placeholder="Item name">
        <label>Quantity</label>
        <input type="number" id="ai_qty" min="1" value="1">
        <label>Description</label>
        <input type="text" id="ai_desc" placeholder="Description (optional)">
        <div class="inline-grid" style="margin-top:8px;">
          <div><label>Price NGN</label><input type="number" id="ai_price_ngn" step="0.01" inputmode="decimal"></div>
          <div><label>Price USD</label><input type="number" id="ai_price_usd" step="0.01" inputmode="decimal"></div>
          <div><label>Price EUR</label><input type="number" id="ai_price_eur" step="0.01" inputmode="decimal"></div>
          <div><label>Price GBP</label><input type="number" id="ai_price_gbp" step="0.01" inputmode="decimal"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button type="button" id="ai_add">Add</button>
          <button type="button" id="ai_cancel">Cancel</button>
        </div>
      </div>

      <div id="quoteItems"></div>
      <button type="button" id="addQuoteItem">+ Add Item</button>

      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <button type="button" id="generateQuoteLinkBtn">Generate Link</button>
        <div id="generatedQuoteLink" style="margin-left:8px;"></div>
      </div>
    </form>
    <div id="quoteMessage" class="message"></div>

    <label>Display Currency for Quotes</label>
    <select id="quotesDisplayCurrency">
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
    </select>

    <table id="quotesTable">
      <thead>
        <tr><th>Customer</th><th>Email</th><th>Checkout Link</th><th>Total</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="quoteModalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="quoteModalTitle">
      <div class="modal-header">
        <h3 id="quoteModalTitle">Quote Details</h3>
        <div>
          <button id="openCheckoutBtn" class="close">Open Checkout</button>
          <button id="closeModalBtn" class="close">Close</button>
        </div>
      </div>
      <div class="modal-body" id="quoteModalBody"></div>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="section" id="ordersSection">
    <h2>Manage Orders</h2>
    <div class="order-filters">
      <input type="text" id="orderSearch" placeholder="Search by customer or email...">
      <select id="orderStatusFilter">
        <option value="">All Status</option>
        <option>Pending</option>
        <option>Paid</option>
        <option>Processing</option>
        <option>Shipped</option>
        <option>Completed</option>
        <option>Cancelled</option>
      </select>

      <label style="width:100%; margin-top:8px;">Export options</label>
      <select id="exportCurrency" style="max-width:200px;">
        <option value="NGN">NGN</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>
      <input type="date" id="exportFrom">
      <input type="date" id="exportTo">
      <button id="exportOrders">Export Orders CSV</button>
    </div>

    <table id="ordersTable">
      <thead>
        <tr><th>Order ID</th><th>Customer</th><th>Email</th><th>Total</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Allowed admins
const allowedAdmins = ["stonecold.serac@gmail.com"].map(e => e.toLowerCase().trim());

function productsCollection() { return collection(db, "brands","serac","products"); }
function quotesCollection() { return collection(db, "brands","serac","quotes"); }
function ordersCollection() { return collection(db, "brands","serac","orders"); }

/* ------------------ LOCAL STORAGE KEY ------------------ */
const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

/* ------------------ COMMON UTILS ------------------ */
function formatCurrency(value, currency){
  const localeMap = { NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
  const minFrac = currency==='NGN'?0:2;
  try { return new Intl.NumberFormat(localeMap[currency]||'en-US',{style:'currency',currency,minimumFractionDigits:minFrac}).format(value); }
  catch(e){return `${value} ${currency}`;}
}
function escapeHtml(str){ if (!str && str!==0) return ""; return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

/* ------------------ LOGIN / DASHBOARD ------------------ */
const loginForm = document.getElementById("loginForm");
const loginMessage = document.getElementById("loginMessage");
const loginContainer = document.getElementById("loginContainer");
const dashboardContainer = document.getElementById("dashboardContainer");

loginForm.addEventListener("submit", async e=>{
  e.preventDefault();
  loginMessage.textContent="";
  const email=document.getElementById("loginEmail").value;
  const password=document.getElementById("loginPassword").value;
  try{
    const userCred=await signInWithEmailAndPassword(auth,email,password);
    const normalized=(userCred.user.email||"").toLowerCase().trim();
    if(allowedAdmins.includes(normalized)){
      loginContainer.style.display="none";
      dashboardContainer.style.display="block";
      subscribeProducts(); subscribeQuotes(); subscribeOrders();
      showSection("productsSection");
    } else { loginMessage.textContent="❌ Not authorized."; loginMessage.style.color="red"; await signOut(auth);}
  } catch(err){ console.error(err); loginMessage.textContent=`❌ ${err.code||""}: ${err.message||err}`; loginMessage.style.color="red"; }
});

onAuthStateChanged(auth,user=>{
  if(user && allowedAdmins.includes((user.email||"").toLowerCase().trim())){
    loginContainer.style.display="none";
    dashboardContainer.style.display="block";
    subscribeProducts(); subscribeQuotes(); subscribeOrders();
    showSection("productsSection");
  } else { loginContainer.style.display="block"; dashboardContainer.style.display="none"; }
});

document.querySelectorAll(".dashboard-nav button").forEach(btn=>btn.addEventListener("click",()=>showSection(btn.dataset.target)));
function showSection(id){ document.querySelectorAll(".section").forEach(s=>s.classList.remove("active")); document.getElementById(id).classList.add("active"); }

/* ------------------ REPEATABLE INPUTS ------------------ */
const sizesRepeat=document.getElementById("sizesRepeat");
const colorsRepeat=document.getElementById("colorsRepeat");
const imagesRepeat=document.getElementById("imagesRepeat");
const addSizeBtn=document.getElementById("addSizeBtn");
const addColorBtn=document.getElementById("addColorBtn");
const addImageBtn=document.getElementById("addImageBtn");

function createRepeatRow(value='', placeholder=''){
  const row=document.createElement('div'); row.className='row';
  row.innerHTML=`<input type="text" value="${escapeHtml(value)}" placeholder="${escapeHtml(placeholder)}"/><button type="button" class="remove-row">Remove</button>`;
  row.querySelector('.remove-row').addEventListener('click',()=>row.remove());
  return row;
}
function addSizeInput(val=''){ sizesRepeat.appendChild(createRepeatRow(val,'Size e.g. S, M, L')); }
function addColorInput(val=''){ colorsRepeat.appendChild(createRepeatRow(val,'Color e.g. Olive')); }
function addImageInput(val=''){ imagesRepeat.appendChild(createRepeatRow(val,'https://.../image.jpg')); }
addSizeBtn.addEventListener('click',()=>addSizeInput());
addColorBtn.addEventListener('click',()=>addColorInput());
addImageBtn.addEventListener('click',()=>addImageInput());
addSizeInput(); addColorInput(); addImageInput();

/* ------------------ PRODUCTS FORM ------------------ */
const productForm=document.getElementById("productForm");
const productMessage=document.getElementById("productMessage");
const productsTableBody=document.querySelector("#productsTable tbody");
const tableCurrencySelect=document.getElementById("tableCurrency");
let currentEditingProductId=null;
let productsCache=[];

productForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const data={
    name: document.getElementById("productName").value,
    priceNGN: parseFloat(document.getElementById("productPriceNGN").value)||0,
    priceUSD: parseFloat(document.getElementById("productPriceUSD").value)||0,
    priceEUR: parseFloat(document.getElementById("productPriceEUR").value)||0,
    priceGBP: parseFloat(document.getElementById("productPriceGBP").value)||0,
    description: document.getElementById("productDesc").value||"",
    customizationAvailable: document.getElementById("productCustom").value==="true",
    published: document.getElementById("productPublished").value==="true",
    updatedAt: new Date().toISOString()
  };
  data.sizes=Array.from(sizesRepeat.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
  data.colors=Array.from(colorsRepeat.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
  data.images=Array.from(imagesRepeat.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
  try{
    if(currentEditingProductId){ await updateDoc(doc(db,"brands","serac","products",currentEditingProductId),data); productMessage.textContent="✅ Product updated."; currentEditingProductId=null; productForm.querySelector("button[type='submit']").textContent="Add Product"; }
    else{ await addDoc(collection(db,"brands","serac","products"),data); productMessage.textContent="✅ Product added."; }
    productMessage.style.color="green"; productForm.reset(); sizesRepeat.innerHTML=''; colorsRepeat.innerHTML=''; imagesRepeat.innerHTML=''; addSizeInput(); addColorInput(); addImageInput();
  } catch(err){ console.error(err); productMessage.textContent="❌ Error saving product."; productMessage.style.color="red"; }
});

function subscribeProducts(){ onSnapshot(collection(db,"brands","serac","products"),snap=>{ productsCache=[]; snap.forEach(d=>productsCache.push({id:d.id,data:d.data()})); renderProductsTable(); },err=>{ console.error(err); productMessage.textContent=`❌ ${err.code||""}: ${err.message||err}`; productMessage.style.color="red"; }); }

function renderProductsTable(){
  const currency=tableCurrencySelect.value||'NGN';
  productsTableBody.innerHTML="";
  productsCache.forEach(pObj=>{
    const p=pObj.data;
    let priceVal=(currency==="NGN"?p.priceNGN:currency==="USD"?p.priceUSD:currency==="EUR"?p.priceEUR:p.priceGBP)||0;
    const firstImg=(p.images&&p.images.length)?p.images[0]:"";
    const row=document.createElement("tr");
    row.innerHTML=`<td>${escapeHtml(p.name)}</td><td>${formatCurrency(priceVal,currency)}</td><td>${firstImg?`<img src="${firstImg}" alt="${escapeHtml(p.name)}"> (${p.images.length})`:''}</td><td>${p.customizationAvailable?"Yes":"No"}</td><td>${p.published?"Yes":"No"}</td><td class="actions"><button onclick="deleteProduct('${pObj.id}')">Delete</button><button onclick="editProduct('${pObj.id}')">Edit</button></td>`;
    productsTableBody.appendChild(row);
  });
}

tableCurrencySelect.addEventListener("change",()=>renderProductsTable());

window.deleteProduct=async id=>{ if(!confirm("Delete this product?")) return; try{ await deleteDoc(doc(db,"brands","serac","products",id)); }catch(err){console.error(err); alert("Error deleting product");} }
window.editProduct=async id=>{ const d=await getDoc(doc(db,"brands","serac","products",id)); if(!d.exists()) return alert("Product not found"); const p=d.data(); document.getElementById("productName").value=p.name||""; document.getElementById("productPriceNGN").value=p.priceNGN!=null?p.priceNGN:""; document.getElementById("productPriceUSD").value=p.priceUSD!=null?p.priceUSD:""; document.getElementById("productPriceEUR").value=p.priceEUR!=null?p.priceEUR:""; document.getElementById("productPriceGBP").value=p.priceGBP!=null?p.priceGBP:""; document.getElementById("productDesc").value=p.description||""; document.getElementById("productCustom").value=p.customizationAvailable?"true":"false"; document.getElementById("productPublished").value=p.published?"true":"false"; sizesRepeat.innerHTML=""; (p.sizes||[]).forEach(s=>addSizeInput(s)); if(!(p.sizes||[]).length) addSizeInput(); colorsRepeat.innerHTML=""; (p.colors||[]).forEach(c=>addColorInput(c)); if(!(p.colors||[]).length) addColorInput(); imagesRepeat.innerHTML=""; (p.images||[]).forEach(i=>addImageInput(i)); if(!(p.images||[]).length) addImageInput(); currentEditingProductId=id; productForm.querySelector("button[type='submit']").textContent="Save Product"; }

const header = document.getElementById('mainHeader');
window.addEventListener('scroll', () => {
  if(window.scrollY > 20) header.classList.add('scrolled');
  else header.classList.remove('scrolled');
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Fleur De Vie</title>
  <style>
    /* ====== General Styles ====== */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    h2 { margin-top: 0; }
    .hidden { display: none; }

    /* ====== Containers ====== */
    #loginContainer, #dashboardContainer { padding: 20px; }
    #dashboardContainer { display: none; }

    /* ====== Dashboard Sections ====== */
    .section { display: none; margin-top: 20px; }
    .section.active { display: block; }

    /* ====== Forms ====== */
    form { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    form input, form select { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
    form button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    form button:hover { background: #0056b3; }

    /* ====== Tables ====== */
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #fff; border-radius: 8px; overflow: hidden; }
    table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
    table th { background: #f0f0f0; }
    table tr:hover { background: #f9f9f9; }

    /* ====== Quote Item Inputs ====== */
    .quote-item { display: flex; gap: 10px; margin-bottom: 5px; }
    .quote-item input { flex: 1; }

    /* ====== Navigation ====== */
    .dashboard-nav { display: flex; gap: 10px; margin-bottom: 20px; }
    .dashboard-nav button { padding: 8px 12px; border: 1px solid #007bff; background: white; color: #007bff; border-radius: 4px; cursor: pointer; }
    .dashboard-nav button:hover { background: #007bff; color: white; }

    /* ====== Action Buttons ====== */
    .btn { padding: 5px 8px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-edit { background: #ffc107; color: white; }
    .btn-delete { background: #dc3545; color: white; }
  </style>
</head>
<body>

  <!-- ====== LOGIN ====== -->
  <div id="loginContainer">
    <h2>Admin Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button type="submit">Login</button>
      <p id="loginMessage"></p>
    </form>
  </div>

  <!-- ====== DASHBOARD ====== -->
  <div id="dashboardContainer">

    <div class="dashboard-nav">
      <button data-target="productsSection">Products</button>
      <button data-target="quotesSection">Quotes</button>
      <button data-target="ordersSection">Orders</button>
    </div>

    <!-- ====== PRODUCTS SECTION ====== -->
    <div class="section" id="productsSection">
      <h2>Products</h2>
      <form id="productForm">
        <input type="text" id="productName" placeholder="Product Name" required>
        <input type="number" id="productPrice" placeholder="Price" required>
        <button type="submit">Add / Update Product</button>
        <p id="productMessage"></p>
      </form>
      <table id="productsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ====== QUOTES SECTION ====== -->
    <div class="section" id="quotesSection">
      <h2>Quotes</h2>
      <form id="quoteForm">
        <div id="quoteItems"></div>
        <button type="button" id="addQuoteItem">Add Item</button>
        <select id="quoteCurrency">
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
        <button type="submit">Save Quote</button>
        <p id="quoteMessage"></p>
      </form>
      <button id="generateQuoteLinkBtn">Generate Quote Link</button>
      <p><a href="#" id="generatedQuoteLink" target="_blank"></a></p>
      <table id="quotesTable">
        <thead>
          <tr>
            <th>Items</th>
            <th>Currency</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ====== ORDERS SECTION ====== -->
    <div class="section" id="ordersSection">
      <h2>Orders</h2>
      <input type="text" id="orderSearch" placeholder="Search orders">
      <select id="orderStatusFilter">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>
      <button id="exportBtn">Export Orders</button>
      <select id="exportCurrency">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
      </select>
      <input type="date" id="exportFrom">
      <input type="date" id="exportTo">
      <table id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Total</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- ====== FIREBASE & DASHBOARD SCRIPT ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
      authDomain: "brandisby.firebaseapp.com",
      projectId: "brandisby",
      storageBucket: "brandisby.firebasestorage.app",
      messagingSenderId: "87213267039",
      appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const allowedAdmins = ["yourstruly.fleurdevie@gmail.com"].map(e => e.toLowerCase().trim());

    /* --- UI refs --- */
    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");
    const loginContainer = document.getElementById("loginContainer");
    const dashboardContainer = document.getElementById("dashboardContainer");
    const productForm = document.getElementById("productForm");
    const productMessage = document.getElementById("productMessage");
    const productsTableBody = document.querySelector("#productsTable tbody");
    const quoteForm = document.getElementById("quoteForm");
    const quoteItemsDiv = document.getElementById("quoteItems");
    const addQuoteItemBtn = document.getElementById("addQuoteItem");
    const quotesTableBody = document.querySelector("#quotesTable tbody");
    const quoteMessage = document.getElementById("quoteMessage");
    const quoteCurrencySelect = document.getElementById("quoteCurrency");
    const generateQuoteLinkBtn = document.getElementById("generateQuoteLinkBtn");
    const generatedQuoteLink = document.getElementById("generatedQuoteLink");
    const ordersTableBody = document.querySelector("#ordersTable tbody");

    let currentEditingProductId = null;

    /* ---------------- AUTH (UNCHANGED) ---------------- */
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginMessage.textContent = "";
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const normalized = (userCred.user.email || "").toLowerCase().trim();
        if (allowedAdmins.includes(normalized)) {
          loginContainer.style.display = "none";
          dashboardContainer.style.display = "block";
          subscribeProducts();
          subscribeQuotes();
          showSection("productsSection");
        } else {
          loginMessage.textContent = "❌ Not authorized.";
          loginMessage.style.color = "red";
          await signOut(auth);
        }
      } catch (err) {
        console.error("Login error:", err);
        loginMessage.textContent = `❌ ${err.code || ""}: ${err.message || err}`;
        loginMessage.style.color = "red";
      }
    });

    onAuthStateChanged(auth, user => {
      if (user && allowedAdmins.includes((user.email || "").toLowerCase().trim())) {
        loginContainer.style.display = "none";
        dashboardContainer.style.display = "block";
        subscribeProducts();
        subscribeQuotes();
        showSection("productsSection");
      } else {
        loginContainer.style.display = "block";
        dashboardContainer.style.display = "none";
      }
    });

    document.querySelectorAll(".dashboard-nav button").forEach(btn => {
      btn.addEventListener("click", () => showSection(btn.dataset.target));
    });

    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    /* ================= PRODUCTS ================= */
    function subscribeProducts() {
      const productsCol = collection(db, "products");
      onSnapshot(productsCol, snapshot => {
        productsTableBody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name}</td>
            <td>${data.price}</td>
            <td>
              <button class="btn btn-edit" data-id="${docSnap.id}">Edit</button>
              <button class="btn btn-delete" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          productsTableBody.appendChild(tr);
        });

        document.querySelectorAll(".btn-edit").forEach(btn => {
          btn.addEventListener("click", async () => {
            const docSnap = await getDoc(doc(db, "products", btn.dataset.id));
            const data = docSnap.data();
            document.getElementById("productName").value = data.name;
            document.getElementById("productPrice").value = data.price;
            currentEditingProductId = btn.dataset.id;
          });
        });

        document.querySelectorAll(".btn-delete").forEach(btn => {
          btn.addEventListener("click", async () => {
            if(confirm("Delete product?")) await deleteDoc(doc(db, "products", btn.dataset.id));
          });
        });
      });
    }

    productForm.addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("productName").value;
      const price = Number(document.getElementById("productPrice").value);
      if(currentEditingProductId) {
        await updateDoc(doc(db, "products", currentEditingProductId), { name, price });
        currentEditingProductId = null;
      } else {
        await addDoc(collection(db, "products"), { name, price });
      }
      productForm.reset();
    });

    /* ================= QUOTES ================= */
    function addQuoteItem(name="", price="") {
      const div = document.createElement("div");
      div.className = "quote-item";
      div.innerHTML = `
        <input type="text" placeholder="Item Name" value="${name}" required>
        <input type="number" placeholder="Price" value="${price}" required>
        <button type="button">❌</button>
      `;
      const removeBtn = div.querySelector("button");
      removeBtn.addEventListener("click", () => div.remove());
      quoteItemsDiv.appendChild(div);
    }

    addQuoteItemBtn.addEventListener("click", () => addQuoteItem());

    function subscribeQuotes() {
      const quotesCol = collection(db, "quotes");
      onSnapshot(quotesCol, snapshot => {
        quotesTableBody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.items.map(i=>i.name+" ($"+i.price+")").join(", ")}</td>
            <td>${data.currency}</td>
            <td>
              <button class="btn btn-delete" data-id="${docSnap.id}">Delete</button>
            </td>
          `;
          quotesTableBody.appendChild(tr);
        });

        document.querySelectorAll(".btn-delete").forEach(btn => {
          btn.addEventListener("click", async () => {
            if(confirm("Delete quote?")) await deleteDoc(doc(db, "quotes", btn.dataset.id));
          });
        });
      });
    }

    quoteForm.addEventListener("submit", async e => {
      e.preventDefault();
      const items = Array.from(quoteItemsDiv.querySelectorAll(".quote-item")).map(div => {
        const inputs = div.querySelectorAll("input");
        return { name: inputs[0].value, price: Number(inputs[1].value) };
      });
      const currency = quoteCurrencySelect.value;
      await addDoc(collection(db, "quotes"), { items, currency });
      quoteItemsDiv.innerHTML = "";
    });

    generateQuoteLinkBtn.addEventListener("click", () => {
      generatedQuoteLink.href = "/quotes.html"; // customize to your frontend quotes page
      generatedQuoteLink.textContent = "View Generated Quote Link";
    });

  </script>
</body>
</html>

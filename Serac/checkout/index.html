<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sérac - Checkout</title>

<!-- Fonts + Icons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{font-family:"Montserrat",sans-serif;background:var(--bg-dark);color:#e6e6e6;line-height:1.6}
a{color:inherit;text-decoration:none;transition:color var(--transition)}

/* HEADER */
.site-header{background:transparent;transition:background .3s,border-bottom .3s;color:#f5f5f5;display:flex;justify-content:space-between;align-items:center;padding:16px 28px;position:fixed;top:0;left:0;right:0;z-index:1000;border-bottom:1px solid rgba(255,255,255,0.04)}
.site-header.scrolled{background:var(--bg-dark);border-bottom:1px solid rgba(255,255,255,0.06)}
.header-left{display:flex;align-items:center;gap:14px}
.brand-logo{height:56px;object-fit:contain}
.brand-title{font-family:"Playfair Display",serif;font-size:22px;font-weight:700;color:var(--gold)}
.header-right{display:flex;gap:20px;align-items:center}
.header-right a{font-weight:500;color:var(--muted);padding:6px 8px;border-radius:8px;transition:all var(--transition)}
.header-right a:hover{color:#fff;transform:translateY(-2px)}
.cart-count{background:var(--gold);color:#141517;font-size:12px;font-weight:700;border-radius:50%;padding:3px 7px;margin-left:6px;box-shadow:0 4px 10px rgba(182,110,65,0.12)}
.hamburger{display:none;background:none;border:none;cursor:pointer;width:38px;height:32px;position:relative;z-index:1200}
.hamburger span{display:block;width:100%;height:3px;background:var(--gold);border-radius:2px;position:absolute;left:0;transition:.3s}
.hamburger span:nth-child(1){top:6px} .hamburger span:nth-child(2){top:14px} .hamburger span:nth-child(3){top:22px}
.hamburger.open span:nth-child(1){transform:rotate(45deg);top:14px} .hamburger.open span:nth-child(2){opacity:0} .hamburger.open span:nth-child(3){transform:rotate(-45deg);top:14px}

/* HERO */
.hero{position:relative;height:90vh;display:flex;justify-content:center;align-items:center;text-align:center;padding-top:72px;border-bottom-left-radius:12px;border-bottom-right-radius:12px;overflow:hidden}
.hero::after{content:"";position:absolute;inset:0;background:var(--hero-bg,url('asset/bg25.jpg')) center/cover no-repeat;transform:scale(1.06);z-index:-1;border-radius:12px;box-shadow:inset 0 0 0 2000px rgba(20,21,23,0.55)}
.hero-text{position:relative;display:inline-block;z-index:1}
.hero-text h1{font-family:"Playfair Display",serif;font-size:clamp(28px,5vw,48px);margin-bottom:12px;color:var(--gold)}
.hero-text p{font-size:clamp(14px,2vw,18px);max-width:900px;color:#F5F5F3}

/* Paid state */
.hero.paid{background:url('../asset/bg25.jpg') center/cover no-repeat}
#payBtn.paid-state{background-color:#1faa59 !important;cursor:default;pointer-events:none}

/* LAYOUT */
section.checkout{padding:56px 18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0))}
.checkout-inner{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1.4fr;gap:28px;align-items:start}
@media(max-width:980px){.checkout-inner{grid-template-columns:1fr;padding:0 12px}.hero{height:30vh}}
.card{border-radius:16px;background:var(--card-bg);padding:22px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(0,0,0,0.55)}
.checkout-form h2,.order-summary h2{font-family:"Playfair Display",serif;color:#fff;margin-bottom:12px;font-size:22px}
label{display:block;margin-bottom:6px;color:#e9e9e9;font-weight:600}
input[type="text"],input[type="email"],input[type="tel"],textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6e6e6;font-family:inherit;margin-bottom:12px}
textarea{min-height:120px;resize:vertical}
.order-summary ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px}
.order-item{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);transition:all var(--transition)}
.order-item .left{display:flex;gap:12px;align-items:center;flex:1;min-width:0;padding-left:0}
.order-item img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
.order-item .meta,.order-item .title{font-size:0.95rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}
.order-item .title{font-weight:700;color:#fff}
.order-item .price{font-weight:700;color:var(--gold);min-width:110px;text-align:right}
.show-variants-btn{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:6px 8px;cursor:pointer;font-weight:700;transition:all var(--transition);font-size:13px;margin-top:8px}
.variants-container{display:none;flex-direction:column;gap:8px;margin-top:8px;padding-left:0;border-left:2px dashed rgba(255,255,255,0.03)}
.variant-line{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-size:0.95rem}
.currency-selector{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-bottom:12px}
.totals{margin-top:12px;text-align:right;font-weight:700;color:#fff;font-size:18px}
.pay-btn{display:block;width:100%;margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--gold),#a55a36);color:#fff;border:none;font-weight:800;cursor:pointer;transition:transform var(--transition)}
.pay-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.error-banner{display:none;margin-bottom:12px;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,50,50,0.12), rgba(255,30,30,0.06));color:#ffd6d6;border:1px solid rgba(255,30,30,0.12)}
.spinner-backdrop{display:none;position:fixed;top:20px;right:20px;z-index:9999;pointer-events:none;display:flex;align-items:center;justify-content:center}
.spinner{display:flex;gap:6px;padding:6px;background:rgba(0,0,0,0.6);border-radius:24px;box-shadow:0 4px 12px rgba(0,0,0,0.5);align-items:center;justify-content:center}
.spinner .dot{width:8px;height:8px;border-radius:50%;background:var(--gold);animation:bounce 1s infinite ease-in-out}
.spinner .dot:nth-child(2){animation-delay:0.2s}.spinner .dot:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:scale(0.8);opacity:0.6}40%{transform:scale(1.3);opacity:1}}
.note{font-size:0.95rem;color:var(--muted);margin-top:8px}
footer{text-align:center;padding:22px;background:transparent;color:var(--muted);margin-top:36px;border-top:1px solid rgba(255,255,255,0.02)}
.order-item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
.show-details-btn{background:none;border:none;color:#ccc;cursor:pointer;font-size:0.95rem;padding:6px 0;text-align:left}
.details-container{flex-direction:column;padding-left:0;padding-right:0;margin-bottom:8px;border-left:2px solid rgba(255,255,255,0.03);display:none}
.details-container.show{display:flex}
.details-container div{display:flex;justify-content:space-between;font-size:0.95rem;color:#bbb;padding:6px 0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
@media(max-width:680px){.order-item img{width:48px;height:48px}.brand-logo{height:48px}.hero{height:40vh}.checkout-inner{grid-template-columns:1fr;gap:20px;padding:12px}.order-item .meta{font-size:0.92rem}.order-item .price{min-width:60px;font-size:0.95rem}textarea{min-height:100px}}
@media(max-width:900px){.hamburger{display:block}.header-right{display:none;position:absolute;top:64px;right:12px;background:rgba(20,20,20,0.98);flex-direction:column;padding:18px;gap:10px;border-radius:10px;width:220px;z-index:1100;border:1px solid rgba(255,255,255,0.03)}.header-right.open{display:flex}}
.small-note{color:var(--muted);padding:8px;text-align:center}
</style>
</head>
<body>

<header class="site-header" id="siteHeader">
  <div class="header-left">
    <img src="../asset/logo.png" alt="Sérac Logo" class="brand-logo">
    <div class="brand-title">Sérac</div>
  </div>
  <nav class="header-right" id="headerRight">
    <a href="../index.html">Home</a>
    <a href="../shop.html">Shop</a>
    <a href="../about.html">About</a>
    <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="../contact.html">Contact</a>
  </nav>
  <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
</header>

<section class="hero" id="heroSection" style="--hero-bg: url('../asset/bg25.jpg');">
  <div class="hero-text">
    <h1 id="heroH1">Checkout</h1>
    <p id="heroP">Complete your order — secure payment and quick processing</p>
  </div>
</section>

<section class="checkout">
  <div class="checkout-inner">
    <div class="card checkout-form" id="checkoutCard">
      <h2>Billing Details</h2>
      <div class="error-banner" id="errorBanner" role="alert"></div>
      <form id="checkoutForm" autocomplete="off" onsubmit="return false;">
        <label for="name">Full Name</label>
        <input id="name" name="fullname" type="text" placeholder="Jane Doe" required>

        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>

        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="tel" placeholder="+2348000000000" required>

        <label for="address">Address</label>
        <textarea id="address" name="address" placeholder="Street, City, Country" required></textarea>
      </form>
    </div>

    <aside class="card order-summary" id="orderCard">
      <h2 id="orderCardTitle">Order Summary</h2>

      <div class="currency-selector" id="currencySelector" style="display:none">
        <label for="currency">Currency</label>
        <select id="currency" aria-label="Currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>

      <ul id="orderItems" aria-live="polite"></ul>

      <div class="totals" id="totalsText">Subtotal: —</div>
      <div class="note" id="feesNote">Fees does not include shipping</div>
      <div class="note">You will be redirected to payment after clicking Proceed to Payment.</div>

      <button id="payBtn" class="pay-btn" type="button">Proceed to Payment</button>
    </aside>
  </div>
</section>

<footer><p>© 2025 Sérac</p></footer>

<div class="spinner-backdrop" id="spinnerBackdrop" role="status" aria-hidden="true">
  <div class="spinner" id="spinnerBox">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
</div>

<!-- Flutterwave -->
<script src="https://checkout.flutterwave.com/v3.js"></script>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* helpers to safely parse localStorage */
function safeParseJSON(val, fallback) {
  try { return JSON.parse(val || 'null') || fallback; } catch(e){ return fallback; }
}

/* DOM */
const cartCountElem = document.getElementById('cartCount');
const orderItemsEl = document.getElementById('orderItems');
const totalsText = document.getElementById('totalsText');
const payBtn = document.getElementById('payBtn');
const currencySelect = document.getElementById('currency');
const currencySelector = document.getElementById('currencySelector');
const spinnerBackdrop = document.getElementById('spinnerBackdrop');
const errorBanner = document.getElementById('errorBanner');

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');

const hero = document.getElementById('heroSection');
const heroH1 = document.getElementById('heroH1');
const heroP = document.getElementById('heroP');

/* state */
const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

let cart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []);
let selectedCurrency = localStorage.getItem(CURRENCY_KEY) || 'NGN';
let productCache = {};

const urlParams = new URLSearchParams(window.location.search);
const quoteId = urlParams.get("quoteId") || null;
const orderId = urlParams.get("orderId") || null;

let activeQuoteRaw = null;
let activeOrderRaw = null;
let isPaidOrder = false;
let quote = null;

/* utility UI functions */
function showSpinner(show = true) {
  if (!spinnerBackdrop) return;
  spinnerBackdrop.style.display = show ? 'flex' : 'none';
  spinnerBackdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
}
function showError(msg) {
  if (!errorBanner) { if(msg) alert(msg); return; }
  if (!msg) { errorBanner.style.display = 'none'; errorBanner.textContent = ''; return; }
  errorBanner.style.display = 'block';
  errorBanner.textContent = msg;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function formatPrice(value, currency) {
  const localeMap = { USD:'en-US', EUR:'de-DE', GBP:'en-GB', NGN:'en-NG' };
  const minFrac = currency === 'NGN' ? 0 : 2;
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style:'currency', currency, minimumFractionDigits: minFrac }).format(Number(value || 0));
  } catch(e) {
    return `${currency} ${Number(value || 0).toFixed(minFrac)}`;
  }
}
function escapeHtml(str) { if(!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

/* Firestore product fetch */
async function fetchProductData(productId) {
  try {
    if (productCache[productId]) return productCache[productId];
    const dref = doc(db, "brands", "serac", "products", productId);
    const snap = await getDoc(dref);
    if (snap.exists()) { productCache[productId] = snap.data(); return productCache[productId]; }
  } catch (e) {
    console.warn("Fetch product failed", productId, e);
  }
  return null;
}

/* merge cart items */
function mergeCartItems(cartArray){
  const merged = [];
  (cartArray || []).forEach(item=>{
    const idx = merged.findIndex(i => i.id === item.id && (i.color||'') === (item.color||'') && (i.size||'') === (item.size||''));
    if (idx === -1) merged.push({...item});
    else merged[idx].quantity = Number(merged[idx].quantity || 0) + Number(item.quantity || 0);
  });
  return merged;
}

/* Build quote from client cart */
async function buildQuoteFromCart(){
  cart = mergeCartItems(cart || []);
  const byProduct = new Map();
  cart.forEach(row => {
    if (!byProduct.has(row.id)) byProduct.set(row.id, []);
    byProduct.get(row.id).push(row);
  });
  const productIds = Array.from(byProduct.keys());
  const productsData = await Promise.all(productIds.map(pid => fetchProductData(pid).then(d => [pid, d])));
  const productsMap = Object.fromEntries(productsData.map(([id, doc]) => [id, doc]));

  const items = [];
  for (const pid of productIds) {
    const rows = byProduct.get(pid) || [];
    const productDoc = productsMap[pid] || null;
    const image = (productDoc && productDoc.images && productDoc.images.length) ? productDoc.images[0] : (productDoc && productDoc.imageUrl) ? productDoc.imageUrl : null;
    const name = productDoc?.name || rows[0]?.name || 'Product';
    const variantDetails = rows.map(r => {
      const unitPrices = {
        NGN: (productDoc && productDoc.priceNGN != null) ? Number(productDoc.priceNGN) : (r.price || 0),
        USD: (productDoc && productDoc.priceUSD != null) ? Number(productDoc.priceUSD) : null,
        EUR: (productDoc && productDoc.priceEUR != null) ? Number(productDoc.priceEUR) : null,
        GBP: (productDoc && productDoc.priceGBP != null) ? Number(productDoc.priceGBP) : null
      };
      const quantity = Number(r.quantity) || 0;
      const linePrices = {
        NGN: (unitPrices.NGN || 0) * quantity,
        USD: (unitPrices.USD || 0) * quantity,
        EUR: (unitPrices.EUR || 0) * quantity,
        GBP: (unitPrices.GBP || 0) * quantity
      };
      return { id: r.id || pid, color: r.color||'', size: r.size||'', quantity, unitPrices, linePrices };
    });

    const totalQty = variantDetails.reduce((s,a) => s + a.quantity, 0);
    const totalPrices = { NGN:0, USD:0, EUR:0, GBP:0 };
    variantDetails.forEach(v => {
      totalPrices.NGN += (v.linePrices.NGN||0);
      totalPrices.USD += (v.linePrices.USD||0);
      totalPrices.EUR += (v.linePrices.EUR||0);
      totalPrices.GBP += (v.linePrices.GBP||0);
    });

    items.push({ productId: pid, name, image, totalQuantity: totalQty, totalPrices, variants: variantDetails, description: productDoc?.description || '' });
  }

  return { items };
}

/* normalizeQuoteItems (server -> UI) */
function normalizeQuoteItems(rawQuote){
  const arr = Array.isArray(rawQuote.items) ? rawQuote.items : [];
  const items = arr.map(ci => {
    if (Array.isArray(ci.variants) && ci.variants.length) {
      const variants = ci.variants.map(v => {
        const qty = Number(v.qty || v.quantity) || 0;
        const unitPrices = {
          NGN: Number(v.priceNGN) || Number(v.price) || 0,
          USD: Number(v.priceUSD) || 0,
          EUR: Number(v.priceEUR) || 0,
          GBP: Number(v.priceGBP) || 0
        };
        return {
          id: v.id || ci.id || '',
          color: v.color || '',
          size: v.size || '',
          quantity: qty,
          unitPrices,
          linePrices: {
            NGN: (unitPrices.NGN || 0) * qty,
            USD: (unitPrices.USD || 0) * qty,
            EUR: (unitPrices.EUR || 0) * qty,
            GBP: (unitPrices.GBP || 0) * qty
          }
        };
      });
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: variants.reduce((s,a) => s + a.quantity, 0),
        totalPrices: {
          NGN: variants.reduce((s,a) => s + (a.linePrices.NGN||0), 0),
          USD: variants.reduce((s,a) => s + (a.linePrices.USD||0), 0),
          EUR: variants.reduce((s,a) => s + (a.linePrices.EUR||0), 0),
          GBP: variants.reduce((s,a) => s + (a.linePrices.GBP||0), 0)
        },
        variants,
        description: ci.desc || ci.description || ''
      };
    } else {
      const qty = Number(ci.qty || ci.quantity) || 1;
      const unitPrices = {
        NGN: Number(ci.priceNGN) || Number(ci.price) || 0,
        USD: Number(ci.priceUSD) || 0,
        EUR: Number(ci.priceEUR) || 0,
        GBP: Number(ci.priceGBP) || 0
      };
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: qty,
        totalPrices: {
          NGN: (unitPrices.NGN || 0) * qty,
          USD: (unitPrices.USD || 0) * qty,
          EUR: (unitPrices.EUR || 0) * qty,
          GBP: (unitPrices.GBP || 0) * qty
        },
        variants: [{
          id: ci.id || '',
          color: '',
          size: '',
          quantity: qty,
          unitPrices,
          linePrices: {
            NGN: (unitPrices.NGN || 0) * qty,
            USD: (unitPrices.USD || 0) * qty,
            EUR: (unitPrices.EUR || 0) * qty,
            GBP: (unitPrices.GBP || 0) * qty
          }
        }],
        description: ci.desc || ci.description || ''
      };
    }
  });

  return { items };
}

/* render UI from normalized quote */
function renderOrderFromQuoteNormalized(quoteNormalized, currency = 'NGN', paid = false) {
  orderItemsEl.innerHTML = '';
  if (!quoteNormalized || !Array.isArray(quoteNormalized.items)) {
    orderItemsEl.innerHTML = '<li class="small-note">No items</li>';
    totalsText.textContent = `Subtotal: —`;
    return;
  }

  let subtotal = 0;

  quoteNormalized.items.forEach((item, idx) => {
    const value = (item.totalPrices && (item.totalPrices[currency] ?? 0)) || 0;
    subtotal += value;

    const li = document.createElement('li');
    li.className = 'order-item';
    li.dataset.idx = idx.toString();

    const imageHtml = item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}">` : '';

    if (paid) {
      li.innerHTML = `
        <div class="left" style="flex-direction:row;align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            <button class="show-details-btn" data-idx="${idx}">Show Details ▾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>
      `;
      orderItemsEl.appendChild(li);

      const detailsContainer = document.createElement('div');
      detailsContainer.className = 'details-container';
      detailsContainer.setAttribute('data-for-idx', String(idx));
      detailsContainer.style.display = 'none';
      const desc = item.description || '';
      detailsContainer.innerHTML = `<div style="padding:8px;display:flex;flex-direction:column;gap:8px;"><div style="color:var(--muted);">${escapeHtml(desc)}</div><div style="display:flex;justify-content:flex-end;color:var(--muted)">${escapeHtml(String(item.totalQuantity))} ×</div></div>`;
      li.insertAdjacentElement('afterend', detailsContainer);

    } else {
      li.innerHTML = `
        <div class="left" style="flex-direction:row;align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            ${ (Array.isArray(item.variants) && item.variants.length > 1) ? `<button class="show-variants-btn" data-idx="${idx}">Show Choices ▾</button>` : '' }
            <button class="show-details-btn" data-idx="${idx}" style="margin-top:6px;">Show Details ▾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>
      `;
      orderItemsEl.appendChild(li);

      if (Array.isArray(item.variants) && item.variants.length) {
        const variantsContainer = document.createElement('div');
        variantsContainer.className = 'variants-container';
        variantsContainer.setAttribute('data-for-idx', String(idx));

        item.variants.forEach(v => {
          const line = document.createElement('div');
          line.className = 'variant-line';
          let labelParts = [];
          if (v.color) labelParts.push(escapeHtml(v.color));
          if (v.size) labelParts.push(escapeHtml(v.size));
          const label = labelParts.length ? `${labelParts.join(' · ')} ×${v.quantity}` : `×${v.quantity}`;
          const linePrice = (v.linePrices && (v.linePrices[selectedCurrency] ?? 0)) || 0;
          line.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</div><div style="min-width:110px;text-align:right;color:var(--muted)">${formatPrice(linePrice, selectedCurrency)}</div>`;
          variantsContainer.appendChild(line);
        });

        li.insertAdjacentElement('afterend', variantsContainer);
      }

      const detailsContainer = document.createElement('div');
      detailsContainer.className = 'details-container';
      detailsContainer.setAttribute('data-for-idx', String(idx));
      detailsContainer.style.display = 'none';
      const desc = item.description || '';
      detailsContainer.innerHTML = `<div style="padding:8px;display:flex;flex-direction:column;gap:8px;"><div style="color:var(--muted);">${escapeHtml(desc)}</div></div>`;
      li.insertAdjacentElement('afterend', detailsContainer);
    }
  });

  // wire toggles (delegated approach is safer but we keep simple wiring)
  document.querySelectorAll('.show-variants-btn').forEach(btn=>{
    btn.removeEventListener('click', onShowVariants); // safe remove
    btn.addEventListener('click', onShowVariants);
  });
  document.querySelectorAll('.show-details-btn').forEach(btn=>{
    btn.removeEventListener('click', onShowDetails);
    btn.addEventListener('click', onShowDetails);
  });

  totalsText.textContent = `Subtotal: ${formatPrice(subtotal, selectedCurrency)}`;
  try { if (cartCountElem) cartCountElem.textContent = quote ? quote.items.reduce((s,a)=>s + (a.totalQuantity || 0), 0) : 0; } catch(e){}
}

/* toggle handlers */
function onShowVariants(ev){
  const idx = ev.currentTarget.dataset.idx;
  const container = document.querySelector(`.variants-container[data-for-idx="${idx}"]`);
  if (!container) return;
  const isShown = container.classList.toggle('show');
  container.style.display = isShown ? 'flex' : 'none';
  ev.currentTarget.textContent = isShown ? 'Hide Choices ▴' : 'Show Choices ▾';
}
function onShowDetails(ev){
  const idx = ev.currentTarget.dataset.idx;
  const container = document.querySelector(`.details-container[data-for-idx="${idx}"]`);
  if (!container) return;
  const isShown = container.classList.toggle('show');
  container.style.display = isShown ? 'flex' : 'none';
  ev.currentTarget.textContent = isShown ? 'Hide Details ▴' : 'Show Details ▾';
}

/* load checkout data (order -> quote -> cart) */
async function loadCheckoutData() {
  selectedCurrency = localStorage.getItem(CURRENCY_KEY) || selectedCurrency || 'NGN';
  try { if (currencySelect) currencySelect.value = selectedCurrency; } catch(e){}
  if (currencySelector) currencySelector.style.display = quoteId ? 'flex' : 'none';

  try {
    showSpinner(true);

    // CASE 1: orderId -> show paid order
    if (orderId) {
      const orderSnap = await getDoc(doc(db, "brands", "serac", "orders", orderId));
      if (orderSnap.exists()) {
        const data = orderSnap.data();
        isPaidOrder = true;
        fillBillingFields(data);
        quote = { items: normalizeOrderItems(data.items || []) };
        renderPaidOrderUI(quote);
        showSpinner(false);
        return;
      }
    }

    // CASE 2: quoteId
    if (quoteId) {
      const quoteRef = doc(db, "brands", "serac", "quotes", quoteId);
      const quoteSnap = await getDoc(quoteRef);
      if (!quoteSnap.exists()) {
        showSpinner(false);
        showError("Quote not found or deleted.");
        return;
      }
      activeQuoteRaw = quoteSnap.data();
      const qStatus = (activeQuoteRaw.status || "").toLowerCase();

      if (qStatus === "paid" && activeQuoteRaw.orderId) {
        const linkedOrderSnap = await getDoc(doc(db, "brands", "serac", "orders", activeQuoteRaw.orderId));
        if (linkedOrderSnap.exists()) {
          const orderData = linkedOrderSnap.data();
          isPaidOrder = true;
          fillBillingFields(orderData);
          quote = { items: normalizeOrderItems(orderData.items || []) };
          renderPaidOrderUI(quote);
          showSpinner(false);
          return;
        } else {
          // mark paid but order missing: still show quote as paid (disable pay)
          isPaidOrder = true;
        }
      }

      // show quote items for checkout
      if (activeQuoteRaw.customer && nameInput) nameInput.value = activeQuoteRaw.customer;
      if (activeQuoteRaw.email && emailInput) emailInput.value = activeQuoteRaw.email;
      quote = normalizeQuoteItems(activeQuoteRaw);
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      setCheckoutUI();
      showSpinner(false);
      return;
    }

    // CASE 3: cart
    cart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
    cart = mergeCartItems(cart);
    if (!cart.length) {
      quote = { items: [] };
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      showSpinner(false);
      showError("Your cart is empty.");
      return;
    }

    quote = await buildQuoteFromCart();
    renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
    showSpinner(false);
  } catch (err) {
    showSpinner(false);
    console.error("Failed to load checkout data:", err);
    showError("Failed to load checkout data. Please refresh and try again.");
  }
}

/* small helpers */
function fillBillingFields(data) {
  if (nameInput) nameInput.value = data.name || data.customer || "";
  if (emailInput) emailInput.value = data.email || data.customerEmail || "";
  if (phoneInput) phoneInput.value = data.phone || "";
  if (addressInput) addressInput.value = data.address || "";
}
function normalizeOrderItems(items) {
  return (items || []).map(it => ({
    productId: it.id || '',
    name: it.name || '',
    image: (it.image && it.image !== '../asset/placeholder.jpg') ? it.image : null,
    totalQuantity: Number(it.qty || it.quantity) || 1,
    description: it.description || '',
    totalPrices: it.totalPrices || {},
    variants: it.variants || [],
  }));
}
// -------------------- RENDER PAID QUOTE UI --------------------
// -------------------- RENDER PAID QUOTE UI --------------------
function renderPaidOrderUI(quoteData) {
  if (!quoteData) return;

  // Render the quote/order items
  renderOrderFromQuoteNormalized(quoteData, selectedCurrency, true);

  // Mark hero section as paid
  if (hero) hero.classList.add('paid');
  if (heroH1) heroH1.textContent = "Order Summary";
  if (heroP) heroP.textContent = "Your order has been paid successfully.";

  // Update pay button state
  if (payBtn) {
    payBtn.textContent = "Paid ✅";
    payBtn.disabled = true;
    payBtn.classList.add('paid-state');
  }

  // -------------------- LOCK CURRENCY SELECTOR --------------------
  const currencySelectorWrapper = document.querySelector("#currencySelector");
  const currencySelector = document.querySelector("#currency");
  if (currencySelectorWrapper && currencySelector) {
    currencySelector.value = quoteData.currency || selectedCurrency;
    currencySelector.disabled = true;
    currencySelectorWrapper.style.opacity = 0.6;
    currencySelectorWrapper.style.pointerEvents = "none";
  }

  // -------------------- LOCK BILLING DETAILS --------------------
  const billingFields = [nameInput, emailInput, phoneInput, addressInput];
  billingFields.forEach(field => {
    if (field) {
      field.value = quoteData[field.id] || field.value;
      field.disabled = true;
      field.style.backgroundColor = "#202223"; // match order item background
    }
  });

  // -------------------- DISPLAY TRACKING REFERENCE --------------------
  let trackingElem = document.querySelector("#trackingRefDisplay");
  if (!trackingElem) {
    trackingElem = document.createElement("p");
    trackingElem.id = "trackingRefDisplay";
    trackingElem.style.display = "block";
    trackingElem.style.marginTop = "10px";
    trackingElem.style.fontSize = "1rem";
    trackingElem.style.color = "var(--accent)";
    trackingElem.style.fontWeight = "600";

    if (heroP && heroP.parentNode) {
      heroP.parentNode.insertBefore(trackingElem, heroP.nextSibling);
    } else if (hero && hero.parentNode) {
      hero.appendChild(trackingElem);
    }
  }

  if (quoteData.trackingRef) {
    trackingElem.textContent = "Order Reference: " + quoteData.trackingRef;
  } else {
    trackingElem.textContent = "Fetching tracking reference...";
  }

  // -------------------- SYNC CART COUNT --------------------
  updateCartCount();

  // -------------------- STORE PAID QUOTE INFO --------------------
  localStorage.setItem("paidQuoteInfo", JSON.stringify({
    quoteId: quoteData.id,
    verified: true, // ✅ ensure verified flag is stored
    currency: quoteData.currency,
    billing: {
      name: quoteData.name,
      email: quoteData.email,
      phone: quoteData.phone,
      address: quoteData.address
    },
    trackingRef: quoteData.trackingRef
  }));
}

// -------------------- UPDATE CART COUNT FUNCTION --------------------
function updateCartCount() {
  const cartItems = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  const cartTotal = cartItems.reduce((acc, item) => acc + (item.quantity || 1), 0);
  if (cartCountElem) cartCountElem.textContent = cartTotal;
}

// -------------------- SYNC PAID QUOTE ON PAGE LOAD OR RETURN --------------------
async function syncPaidQuoteUI() {
  const paidQuoteInfo = JSON.parse(localStorage.getItem("paidQuoteInfo") || "null");
  if (!paidQuoteInfo) return;

  // --- Immediately render from localStorage to avoid empty flash ---
  const localQuoteData = {
    id: paidQuoteInfo.quoteId,
    trackingRef: paidQuoteInfo.trackingRef,
    currency: paidQuoteInfo.currency,
    name: paidQuoteInfo.billing?.name,
    email: paidQuoteInfo.billing?.email,
    phone: paidQuoteInfo.billing?.phone,
    address: paidQuoteInfo.billing?.address,
    items: []
  };
  renderPaidOrderUI(localQuoteData);

  // --- Fetch fresh data from Firestore ---
  try {
    const docRef = doc(db, "brands", "serac", "quotes", paidQuoteInfo.quoteId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) return;

    const quoteData = docSnap.data();
    quoteData.id = paidQuoteInfo.quoteId;
    quoteData.trackingRef = paidQuoteInfo.trackingRef;
    quoteData.currency = paidQuoteInfo.currency;

    renderPaidOrderUI(quoteData);
  } catch (err) {
    console.error("Failed to fetch quote for paid UI:", err);
  }
}

// -------------------- FIX: USE loadCheckoutData INSTEAD OF loadQuoteUI --------------------
document.addEventListener("DOMContentLoaded", () => {
  const paidQuoteInfo = JSON.parse(localStorage.getItem("paidQuoteInfo") || "null");

  if (paidQuoteInfo && paidQuoteInfo.verified) {
    syncPaidQuoteUI();
  } else {
    loadCheckoutData(); // ✅ correct fallback
  }
});

window.addEventListener("pageshow", () => {
  const paidQuoteInfo = JSON.parse(localStorage.getItem("paidQuoteInfo") || "null");

  if (paidQuoteInfo && paidQuoteInfo.verified) {
    syncPaidQuoteUI();
  } else {
    loadCheckoutData(); // ✅ correct fallback
  }
});

// -------------------- REALTIME CART UPDATE --------------------
window.addEventListener("storage", () => updateCartCount());


  
  
function setCheckoutUI() {
  if (hero) hero.classList.remove('paid');
  if (heroH1) heroH1.textContent = "Checkout";
  if (heroP) heroP.textContent = "Review your quote and proceed to payment.";
  if (payBtn) {
    payBtn.textContent = "Proceed to Payment";
    payBtn.disabled = false;
    payBtn.classList.remove('paid-state');
  }
}

/* Validation */
function validateForm(){
  showError('');
  const name = (nameInput && nameInput.value || '').trim();
  const email = (emailInput && emailInput.value || '').trim();
  const phone = (phoneInput && phoneInput.value || '').trim();
  const address = (addressInput && addressInput.value || '').trim();
  if(!name) return "Name is required.";
  if(!email) return "Email is required.";
  if(!/^\S+@\S+\.\S+$/.test(email)) return "Please provide a valid email.";
  if(!phone) return "Phone is required.";
  if(!address) return "Address is required.";
  if(!quote || !Array.isArray(quote.items) || quote.items.length === 0) return "Cart is empty.";
  return null;
}

/* fetch with retry */
async function fetchWithRetry(url, options = {}, retries = 1, backoff = 500) {
  try {
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    return res;
  } catch (err) {
    if (retries > 0) {
      await new Promise(r => setTimeout(r, backoff));
      return fetchWithRetry(url, options, retries - 1, Math.round(backoff * 1.5));
    } else throw err;
  }
}

/* serverless verify */
const FLW_PUBLIC_KEY = "FLWPUBK_TEST-07eb9d2da345c08dc4d54278c3bc86f7-X";
const SERVERLESS_VERIFY = `${window.location.origin}/api/verify`;

async function verifyPayment(payload) {
  try {
    const opts = {
      method: "POST",
      headers: { "Content-Type": "application/json", "Connection": "close" },
      body: JSON.stringify(payload),
      cache: "no-store",
      mode: "cors",
      credentials: "omit",
      keepalive: true
    };
    const res = await fetchWithRetry(SERVERLESS_VERIFY, opts, 1);
    return await res.json();
  } catch (err) {
    console.error("verifyPayment error:", err);
    throw err;
  }
}

// -------------------- ORDER REFERENCE GENERATOR --------------------
function generateOrderReference(email, orderId, txRef) {
  const rand = () => Math.random().toString(36).substring(2, 6).toUpperCase();
  const now = new Date();
  const day = String(now.getDate()).padStart(2, "0");
  const month = now.toLocaleString("en", { month: "short" }).toUpperCase();
  const year = String(now.getFullYear()).slice(-2);

  const emailPrefix = email ? email.split('@')[0].slice(0, 3).toUpperCase() : "SR";
  const shortTx = txRef ? txRef.slice(-4).toUpperCase() : rand();

  // Example: SRCHE-10OCT25-A1B2
  return `${emailPrefix}-${day}${month}${year}-${shortTx}`;
}


/* ✅ save verified order to Firestore */
async function processPaidOrder(orderData, txRef) {
  try {
    const trackingRef = generateOrderReference(orderData.email, orderData.id || "", txRef);

    const orderRef = await addDoc(collection(db, "brands", "serac", "orders"), {
      ...orderData,
      createdAt: serverTimestamp(),
      verifiedAt: serverTimestamp(),
      status: "paid",
      trackingRef: trackingRef, // ✅ added tracking ref
    });

    try {
      // ✅ If it’s a quote-based checkout, update the quote document too
      if (orderData.source && orderData.source.startsWith("quote:")) {
        const qid = orderData.source.split("quote:")[1];
        if (qid) {
          await updateDoc(doc(db, "brands", "serac", "quotes", qid), {
            status: "Paid",
            orderId: orderRef.id,
            paidAt: serverTimestamp(),
            trackingRef: trackingRef, // ✅ add same tracking ref here too
          });
        }
      }
    } catch (e) {
      console.warn("Failed to update quote status after saving order", e);
    }

    return orderRef.id;
  } catch (err) {
    console.error("Failed to save paid order:", err);
    return null;
  }
}



/* -------------------- PAYMENT FLOW -------------------- */
async function initiatePaymentFlow(ev) {
  if (ev && ev.preventDefault) ev.preventDefault();
  if (isPaidOrder) return;

  showError("");

  // -------------------- VALIDATE FORM --------------------
  const v = validateForm();
  if (v) { showError(v); return; }

  // -------------------- RESTORE CHECKOUT DATA --------------------
  const savedData = localStorage.getItem("checkout_user_data");
  if (savedData) {
    try {
      const { name, email, phone, address, selectedCurrency: savedCurrency } = JSON.parse(savedData);
      if (nameInput) nameInput.value = name || "";
      if (emailInput) emailInput.value = email || "";
      if (phoneInput) phoneInput.value = phone || "";
      if (addressInput) addressInput.value = address || "";
      if (savedCurrency && currencySelect) { selectedCurrency = savedCurrency; currencySelect.value = savedCurrency; }
    } catch (err) { console.warn("Failed to restore checkout data:", err); }
  }

  // -------------------- SAVE CURRENT USER DATA --------------------
  const userData = {
    name: (nameInput?.value || "").trim(),
    email: (emailInput?.value || "").trim(),
    phone: (phoneInput?.value || "").trim(),
    address: (addressInput?.value || "").trim(),
    selectedCurrency
  };
  localStorage.setItem("checkout_user_data", JSON.stringify(userData));

  // -------------------- CALCULATE SUBTOTAL --------------------
  let subtotal = 0;
  try { quote.items.forEach(it => { subtotal += (it.totalPrices?.[selectedCurrency] ?? 0); }); }
  catch (e) { subtotal = 0; }
  if (subtotal <= 0) { showError("Subtotal is zero. Cannot proceed."); return; }

  if (payBtn?.dataset.processing === "1") return;
  if (payBtn) { payBtn.dataset.processing = "1"; payBtn.disabled = true; }

  showSpinner(true);

  const baseOrder = {
    name: userData.name,
    email: userData.email,
    phone: userData.phone,
    address: userData.address,
    currency: selectedCurrency,
    items: quote.items,
    total: subtotal,
    status: "placed",
    source: quoteId ? `quote:${quoteId}` : "cart",
    createdAt: new Date().toISOString()
  };

  const txRef = "serac_" + Date.now();
  let paymentCallbackHandled = false;

  // -------------------- FINALIZE AFTER SUCCESS --------------------
  async function finalizeAfterSuccess(workerResp) {
    try {
      const orderId = await processPaidOrder(baseOrder, txRef);
      if (orderId) workerResp = { ...workerResp, orderId };

      // Clear only cart items if not quote checkout
      if (!quoteId) localStorage.removeItem(STORAGE_KEY);

      activeOrderRaw = workerResp.orderDoc || { ...baseOrder, status: "paid", trackingRef: generateOrderReference(baseOrder.email, orderId || "", txRef) };
      quote = { items: activeOrderRaw.items || baseOrder.items };
      isPaidOrder = true;

      // Render order summary
      renderPaidOrderUI(activeOrderRaw);

      // Store paid quote info for page sync
      localStorage.setItem("paidQuoteInfo", JSON.stringify({
        quoteId,
        currency: selectedCurrency,
        billing: { name: baseOrder.name, email: baseOrder.email, phone: baseOrder.phone, address: baseOrder.address },
        trackingRef: activeOrderRaw.trackingRef
      }));

      showSpinner(false);

      // Redirect to thank you page with order ID
      const qs = activeOrderRaw.orderId ? `?orderId=${encodeURIComponent(activeOrderRaw.orderId)}` : "";
      window.location.href = "../thankyou.html" + qs;

    } catch (err) {
      console.error("Finalize error:", err);
      showSpinner(false);
      showError("Payment verified but finalization failed. Contact support with tx_ref: " + txRef);
      if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }
    }
  }

  // -------------------- FLUTTERWAVE CONFIG --------------------
  const fwConfig = {
    public_key: FLW_PUBLIC_KEY,
    tx_ref: txRef,
    amount: Number(subtotal),
    currency: selectedCurrency,
    customer: { email: baseOrder.email, phonenumber: baseOrder.phone, name: baseOrder.name },
    customizations: { title: "Sérac", description: "Order Payment", logo: "../assets/logo.png" },

    callback: async function (data) {
      if (paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(true);

      try {
        const flwId = data?.data?.id || data.id || data.transaction_id || null;
        if (!flwId) throw new Error("Missing transaction ID from Flutterwave");

        const payload = { transaction_id: flwId, tx_ref: data.tx_ref || txRef, expectedAmount: subtotal, currency: selectedCurrency, orderData: baseOrder, quoteId: quoteId || null };
        const verifyResponse = await verifyPayment(payload);

        if (verifyResponse && (verifyResponse.status === "success" || verifyResponse.success === true) && ((verifyResponse.data?.status === "successful") || verifyResponse.verified === true)) {
          await finalizeAfterSuccess(verifyResponse);
        } else {
          showSpinner(false);
          showError("Payment verification failed. Contact support with tx_ref: " + txRef);
          if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }
        }

      } catch (err) {
        console.error("Verification error:", err);
        showSpinner(false);
        showError("Payment succeeded but could not be verified. Contact support.");
        if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }
      }
    },

    onclose: function () {
      if (paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(false);
      showError("Payment was cancelled. Please complete your checkout.");

      if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }

      // Restore checkout user data
      const saved = localStorage.getItem("checkout_user_data");
      if (saved) {
        try {
          const { name, email, phone, address, selectedCurrency: savedCurrency } = JSON.parse(saved);
          if (nameInput) nameInput.value = name || "";
          if (emailInput) emailInput.value = email || "";
          if (phoneInput) phoneInput.value = phone || "";
          if (addressInput) addressInput.value = address || "";
          if (savedCurrency && currencySelect) { selectedCurrency = savedCurrency; currencySelect.value = savedCurrency; }
        } catch (err) { console.warn("Failed to restore checkout data on cancel:", err); }
      }

      // Redirect back to checkout
      window.location.href = "../checkout/index.html";
    }
  };

  // -------------------- LAUNCH FLUTTERWAVE --------------------
  try { FlutterwaveCheckout(fwConfig); }
  catch (err) {
    showSpinner(false);
    if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }
    console.error("Flutterwave failed:", err);
    showError("Payment gateway unavailable. Try again later.");
  }

  // -------------------- POLL FOR VERIFICATION FALLBACK --------------------
  let attempts = 0;
  const maxAttempts = 6;
  const poll = setInterval(async () => {
    if (paymentCallbackHandled) return clearInterval(poll);
    attempts++;
    try {
      const res = await verifyPayment({ tx_ref: txRef, orderData: baseOrder, expectedAmount: subtotal, currency: selectedCurrency });
      if (res && (res.status === "success" || res.success === true) && ((res.data?.status === "successful") || res.verified === true)) {
        clearInterval(poll);
        paymentCallbackHandled = true;
        await finalizeAfterSuccess(res);
      }
    } catch (err) {
      if (attempts >= maxAttempts) {
        clearInterval(poll);
        showSpinner(false);
        showError("Automatic verification failed. Contact support with tx_ref: " + txRef);
        if (payBtn) { payBtn.disabled = false; payBtn.dataset.processing = "0"; }
      }
    }
  }, 3000);
}
    
/* currency change */
if (currencySelect) {
  currencySelect.addEventListener('change', () => {
    selectedCurrency = currencySelect.value;
    localStorage.setItem(CURRENCY_KEY, selectedCurrency);
    if (quote) renderOrderFromQuoteNormalized(quote, selectedCurrency, isPaidOrder);
  });
}

/* header & hamburger */
window.addEventListener('scroll', () => {
  const header = document.querySelector('.site-header');
  if (!header) return;
  if (window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
});
const hamburger = document.getElementById('hamburger');
const headerRight = document.getElementById('headerRight');
if (hamburger) hamburger.addEventListener('click', ()=> {
  hamburger.classList.toggle('open');
  if (headerRight) headerRight.classList.toggle('open');
});

/* bind pay button */
if (payBtn) payBtn.addEventListener('click', initiatePaymentFlow);

/* init */
(async function init(){
  try { if (currencySelect) currencySelect.value = selectedCurrency; } catch(e){}
  try { if (cartCountElem) cartCountElem.textContent = (safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || []).reduce((s,i)=>s + Number(i.quantity || 0), 0); } catch(e){ if (cartCountElem) cartCountElem.textContent = '0'; }
  await loadCheckoutData();
})();

/* suppress noisy FP/Flutterwave errors (only known noise) */
window.addEventListener('error', (e) => {
  try {
    const msg = (e && e.message) ? e.message.toLowerCase() : "";
    const file = (e && e.filename) ? e.filename.toLowerCase() : "";
    if (msg.includes('api key not found') || file.includes('metrics.flutterwave.com') || file.includes('loader_v') || file.includes('initfingerprint') || msg.includes('fpjs')) {
      console.warn("Suppressed Flutterwave/fingerprint error:", e.message || e.filename);
      e.preventDefault && e.preventDefault();
    }
  } catch(err) {}
});
</script>
</body>
</html>

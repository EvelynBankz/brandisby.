<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleur De Vie - Product</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: "Montserrat", sans-serif; background: #F5E6CC; color:#112e1f; line-height:1.6; }
a { text-decoration:none; color:inherit; }

/* HEADER */
.site-header { background: #112e1f; color: #F5E6CC; display:flex; justify-content:space-between; align-items:center; padding:16px 28px; position:fixed; top:0; left:0; right:0; z-index:1000; }
.header-left { display:flex; align-items:center; gap:12px; }
.brand-logo { height:60px; }
.brand-title { font-family:"Playfair Display", serif; font-size:24px; font-weight:700; }
.header-right { display:flex; gap:20px; align-items:center; }
.header-right a { font-weight:500; transition: color 0.3s; }
.header-right a:hover { color:#FFD6BA; }
.cart-count { background:#FFD6BA; color:#112e1f; font-size:12px; font-weight:600; border-radius:50%; padding:2px 6px; margin-left:4px; }

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
.hamburger span { display:block; width:100%; height:3px; background:#F5E6CC; border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; }

/* PRODUCT */
main { padding:120px 20px 40px; max-width:1000px; margin:auto; display:flex; gap:40px; flex-wrap:wrap; justify-content:center; }
.product-image { flex:1 1 300px; max-width:400px; display:flex; flex-direction:column; gap:10px; }
.product-image img { width:100%; object-fit:contain; border-radius:12px; background:#fff; cursor:pointer; }
.thumbnail-container { display:flex; gap:8px; overflow-x:auto; scroll-behavior:smooth; -webkit-overflow-scrolling: touch; padding-bottom:6px; }
.thumbnail-container img { width:60px; height:60px; object-fit:contain; border:1px solid #ccc; border-radius:6px; cursor:pointer; transition:0.2s; flex-shrink:0; }
.thumbnail-container img:hover, .thumbnail-container img.selected { border-color:#112e1f; }

.product-details { flex:1 1 300px; max-width:500px; display:flex; flex-direction:column; gap:12px; }
.product-details h1 { font-family:"Playfair Display", serif; font-size:2rem; }
.product-details .description { font-size:1rem; color:#112e1f; }
.product-details .price { font-weight:600; font-size:1.2rem; margin-bottom:12px; }
.options-container { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
.options-container button { padding:8px 12px; border-radius:6px; border:1px solid #112e1f; cursor:pointer; background:#fff; transition:0.2s; }
.options-container button:hover, .options-container button.selected { background:#112e1f; color:#FFD6BA; }

.quantity-controls { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
.quantity-controls button { background:#112e1f; color:#F5E6CC; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; transition:0.3s; }
.quantity-controls button:hover { background:#0a1d14; }
.quantity-badge { font-weight:600; min-width:24px; text-align:center; display:inline-block; }

.add-cart { background:#112e1f; color:#F5E6CC; border:none; border-radius:6px; padding:12px; cursor:pointer; font-size:1rem; transition:0.3s; }
.add-cart:hover { background:#0a1d14; }

.customize-btn { background:#FFD6BA; color:#112e1f; border:none; border-radius:6px; padding:12px; cursor:pointer; font-size:1rem; font-weight:600; text-align:center; margin-top:10px; transition:0.3s; }
.customize-btn:hover { background:#ffc999; }

/* Buttons row for desktop + sticky mobile container (mobile shows fixed bar) */
.buttons-row { display:flex; gap:10px; margin-top:16px; align-items:center; }
.back-btn { background:#112e1f; color:#F5E6CC; border:none; border-radius:6px; padding:12px; cursor:pointer; font-size:1rem; font-weight:500; text-align:center; }
.back-btn:hover { background:#0a1d14; }

/* mobile actions (hidden by default; shown and fixed on small screens) */
.mobile-actions { display:none; }

/* FOOTER */
footer { text-align:center; padding:20px; background:#112e1f; color:#F5E6CC; margin-top:60px; }

/* RESPONSIVE */
@media(max-width:800px){ main { flex-direction:column; align-items:center; } .product-image, .product-details { max-width:90%; } }
@media(max-width:600px){
  .header-right { display:none; flex-direction:column; background:#112e1f; position:absolute; top:70px; right:0; width:200px; padding:20px; }
  .header-right.open { display:flex; }
  .hamburger { display:block; }

  /* show mobile fixed bar */
  .mobile-actions {
    display:flex;
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    width:92%;
    max-width:540px;
    gap:10px;
    z-index:999;
  }
  /* hide original inline add button to avoid duplicates on small screens */
  .add-cart { display:none; }
  /* make back button in the mobile bar look prominent */
  .mobile-actions .back-btn { flex:1; text-align:center; }
  .mobile-actions .mobile-add { flex:1; text-align:center; border-radius:6px; padding:12px; background:#FFD6BA; color:#112e1f; font-weight:600; border:none; }
}
</style>
</head>
<body>

<header class="site-header">
  <div class="header-left">
    <img src="logo.png" alt="Fleur De Vie Logo" class="brand-logo">
    <div class="brand-title">Fleur De Vie</div>
  </div>
  <nav class="header-right">
    <a href="index.html">Home</a>
    <a href="shop.html">Shop</a>
    <a href="about.html">About</a>
    <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="customization.html">Customize</a>
    <a href="contact.html">Contact</a>
  </nav>
  <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
</header>

<main id="productContainer">
  <div class="product-image">
    <img id="productImg" src="" alt="Product Image">
    <div class="thumbnail-container" id="thumbnailContainer"></div>
  </div>
  <div class="product-details">
    <h1 id="productName">Product Name</h1>
    <div class="description" id="productDescription">Product description will appear here.</div>
    <div class="price" id="productPrice">₦0.00</div>

    <div class="options-container" id="colorOptions"></div>
    <div class="options-container" id="sizeOptions"></div>

    <div class="quantity-controls">
      <button id="minus">-</button>
      <span class="quantity-badge" id="quantityBadge">0</span>
      <button id="plus">+</button>
    </div>

    <button class="add-cart" id="addCartBtn">Add to Cart</button>

    <a href="customization.html" id="customizeBtn" class="customize-btn" style="display:none;">Customize this Product</a>

    <!-- Desktop buttons row (will appear as normal on desktop) -->
    <div class="buttons-row" style="margin-bottom:12px;">
      <a href="shop.html" class="back-btn" id="backBtnDesktop">← Back to Shop</a>
    </div>

    <!-- Mobile fixed actions: Back + Add (shown only on small screens) -->
    <div class="mobile-actions" id="mobileActions" aria-hidden="true">
      <a href="shop.html" class="back-btn">← Back to Shop</a>
      <button class="mobile-add" id="addCartMobileBtn">Add to Cart</button>
    </div>
  </div>
</main>

<footer>
  <p>© 2025 Fleur De Vie</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const productImg = document.getElementById('productImg');
const productName = document.getElementById('productName');
const productDescription = document.getElementById('productDescription');
const productPrice = document.getElementById('productPrice');
const quantityBadge = document.getElementById('quantityBadge');
const addCartBtn = document.getElementById('addCartBtn');
const addCartMobileBtn = document.getElementById('addCartMobileBtn');
const minusBtn = document.getElementById('minus');
const plusBtn = document.getElementById('plus');
const cartCountElem = document.getElementById('cartCount');
const customizeBtn = document.getElementById('customizeBtn');
const thumbnailContainer = document.getElementById('thumbnailContainer');
const colorOptions = document.getElementById('colorOptions');
const sizeOptions = document.getElementById('sizeOptions');

let currentProductData = null;

/* CART helpers */
function getCart(){ return JSON.parse(localStorage.getItem('cart')) || []; }
function setCart(cart){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartCount(); }
function updateCartCount(){
  const cart = getCart();
  cartCountElem.textContent = cart.reduce((sum,item)=>sum+Number(item.quantity||0),0);
}

/* update quantity UI for currently selected options */
function updateQuantityUI(productId){
  const cart = getCart();
  const sel = getSelectedOptions();
  const item = cart.find(i=>i.id===productId && (i.color || '') === (sel.color || '') && (i.size || '') === (sel.size || ''));
  quantityBadge.textContent = item ? item.quantity : 0;
  addCartBtn.style.display = item ? 'none' : 'block';
}

/* add one item instance (used by add button and plus button) */
function addToCart(product){
  let cart = getCart();
  const index = cart.findIndex(i=>i.id===product.id && (i.color||'')=== (product.color||'') && (i.size||'') === (product.size||''));
  if(index > -1){
    cart[index].quantity = Number(cart[index].quantity || 0) + 1;
  } else {
    cart.push({...product, quantity:1});
  }
  setCart(cart);
  // refresh the UI for this product variant
  try { updateQuantityUI(product.id); } catch(e){ /* ignore */ }
}

/* remove one instance (used by minus button) */
function removeFromCart(productId){
  let cart = getCart();
  const sel = getSelectedOptions();
  const index = cart.findIndex(i=>i.id===productId && (i.color||'')=== (sel.color||'') && (i.size||'') === (sel.size||''));
  if(index > -1){
    cart[index].quantity = Number(cart[index].quantity || 0) - 1;
    if(cart[index].quantity <= 0){
      cart.splice(index,1);
    }
    setCart(cart);
  }
  // ensure UI is refreshed immediately after removal
  try { updateQuantityUI(productId); } catch(e){ /* ignore */ }
}

/* Get productId, price, currency from URL */
const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get('productId');
const urlPrice = parseFloat(urlParams.get('price'));
const urlCurrency = urlParams.get('currency');

/* Load product, populate images, sizes, colors */
async function loadProduct(){
  if(!productId) return;
  try{
    const docRef = doc(db,"brands","fleurdevie","products",productId);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      currentProductData = data;

      // Images: prefer images array, fallback to imageUrl, ensure array and valid entries
      const images = Array.isArray(data.images) && data.images.length
        ? data.images.filter(Boolean)
        : (data.imageUrl ? [data.imageUrl] : []);
      // Use first image as main thumbnail
      productImg.src = images[0] || '';
      thumbnailContainer.innerHTML = '';
      images.forEach((imgUrl, idx)=>{
        if(!imgUrl) return;
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        if(idx===0) thumb.classList.add('selected');
        thumb.addEventListener('click', ()=>{
          productImg.src = imgUrl;
          thumbnailContainer.querySelectorAll('img').forEach(i=>i.classList.remove('selected'));
          thumb.classList.add('selected');
        });
        thumbnailContainer.appendChild(thumb);
      });

      // Basic product info
      productName.textContent = data.name || '';
      productDescription.textContent = data.description || '';

      // Display price: prefer URL-provided price/currency, else product data
      const displayPrice = !isNaN(urlPrice) ? urlPrice : (data.price || 0);
      const displayCurrency = urlCurrency || data.currency || 'NGN';
      const localeMap = { NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
      const minFrac = displayCurrency === 'NGN' ? 0 : 2;
      try {
        productPrice.textContent = new Intl.NumberFormat(localeMap[displayCurrency] || 'en-US', { style:'currency', currency: displayCurrency, minimumFractionDigits: minFrac }).format(displayPrice);
      } catch(e) {
        productPrice.textContent = `${displayCurrency} ${displayPrice}`;
      }

      // store for cart usage
      currentProductData.price = displayPrice;
      currentProductData.currency = displayCurrency;

      // customization
      if(data.customizationAvailable){
        customizeBtn.style.display='block';
        customizeBtn.href=`customization.html?productId=${productId}`;
      } else {
        customizeBtn.style.display='none';
      }

      // color options
      colorOptions.innerHTML='';
      if(Array.isArray(data.colors) && data.colors.length){
        data.colors.forEach(c=>{
          const btn = document.createElement('button'); btn.textContent=c;
          btn.addEventListener('click',()=>{
            Array.from(colorOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateQuantityUI(productId);
          });
          colorOptions.appendChild(btn);
        });
      }

      // size options
      sizeOptions.innerHTML='';
      if(Array.isArray(data.sizes) && data.sizes.length){
        data.sizes.forEach(s=>{
          const btn = document.createElement('button'); btn.textContent=s;
          btn.addEventListener('click',()=>{
            Array.from(sizeOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateQuantityUI(productId);
          });
          sizeOptions.appendChild(btn);
        });
      }

      updateQuantityUI(productId);

    } else {
      document.getElementById('productContainer').innerHTML='<p style="text-align:center; color:red;">Product not found.</p>';
    }
  } catch(err){
    console.error(err);
    document.getElementById('productContainer').innerHTML='<p style="text-align:center; color:red;">Failed to load product.</p>';
  }
}

/* returns currently selected color and size */
function getSelectedOptions(){
  return {
    color: colorOptions.querySelector('.selected')?.textContent || '',
    size: sizeOptions.querySelector('.selected')?.textContent || ''
  };
}

/* Cart button handlers */
addCartBtn.addEventListener('click', ()=> {
  if(!currentProductData) return;
  const sel = getSelectedOptions();
  addToCart({
    id: productId,
    name: currentProductData.name,
    price: currentProductData.price,
    currency: currentProductData.currency,
    imageUrl: productImg.src,
    color: sel.color,
    size: sel.size
  });
  // UI refresh after adding (redundant but safe)
  updateQuantityUI(productId);
});
plusBtn.addEventListener('click', ()=> {
  if(!currentProductData) return;
  const sel = getSelectedOptions();
  addToCart({
    id: productId,
    name: currentProductData.name,
    price: currentProductData.price,
    currency: currentProductData.currency,
    imageUrl: productImg.src,
    color: sel.color,
    size: sel.size
  });
  updateQuantityUI(productId);
});
minusBtn.addEventListener('click', ()=> {
  removeFromCart(productId);
  // updateQuantityUI is already called inside removeFromCart, so this is optional
});

/* Mobile add button (reuses same addToCart logic) */
if (addCartMobileBtn) {
  addCartMobileBtn.addEventListener('click', () => {
    if(!currentProductData) return;
    const sel = getSelectedOptions();
    addToCart({
      id: productId,
      name: currentProductData.name,
      price: currentProductData.price,
      currency: currentProductData.currency,
      imageUrl: productImg.src,
      color: sel.color,
      size: sel.size
    });
    updateQuantityUI(productId);
  });
}

/* Hamburger toggle */
document.getElementById('hamburger').addEventListener('click', ()=>{
  document.querySelector('.header-right').classList.toggle('open');
  document.getElementById('hamburger').classList.toggle('open');
});

/* Mobile swipe for thumbnails */
let isDown=false, startX, scrollLeft;
thumbnailContainer.addEventListener('mousedown', e=>{
  isDown=true; startX=e.pageX - thumbnailContainer.offsetLeft; scrollLeft=thumbnailContainer.scrollLeft;
});
thumbnailContainer.addEventListener('mouseleave', ()=>isDown=false);
thumbnailContainer.addEventListener('mouseup', ()=>isDown=false);
thumbnailContainer.addEventListener('mousemove', e=>{
  if(!isDown) return;
  e.preventDefault();
  const x=e.pageX - thumbnailContainer.offsetLeft;
  const walk=(x-startX)*2;
  thumbnailContainer.scrollLeft=scrollLeft - walk;
});
thumbnailContainer.addEventListener('touchstart', e=>{
  startX=e.touches[0].pageX - thumbnailContainer.offsetLeft;
  scrollLeft=thumbnailContainer.scrollLeft;
});
thumbnailContainer.addEventListener('touchmove', e=>{
  const x=e.touches[0].pageX - thumbnailContainer.offsetLeft;
  const walk=(x-startX)*2;
  thumbnailContainer.scrollLeft=scrollLeft - walk;
});

/* sync UI when cart changes in other tabs */
window.addEventListener('storage', ()=>{
  // update cart count + this page's quantity indicator
  updateCartCount();
  try { updateQuantityUI(productId); } catch(e){ /* ignore */ }
});

/* init */
updateCartCount();
loadProduct();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#333; color:#fff; padding:10px; text-align:center; }
    .container { display:flex; min-height:100vh; }
    nav { width:200px; background:#444; color:#fff; padding:20px; }
    nav button { display:block; width:100%; margin:5px 0; padding:10px; background:#555; border:none; color:#fff; cursor:pointer; }
    nav button:hover { background:#666; }
    main { flex:1; padding:20px; }
    .section { display:none; }
    .section.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#eee; }
    .message { margin:10px 0; font-weight:bold; }
    .quote-item { border:1px solid #ddd; padding:8px; margin:5px 0; }
    .collapsible { margin:10px 0; }
    .hidden { display:none; }
    .copy-btn { cursor:pointer; margin-left:5px; }
  </style>
</head>
<body>
  <header><h1>Admin Dashboard</h1></header>
  <div class="container">
    <nav class="dashboard-nav">
      <button data-target="productsSection">Products</button>
      <button data-target="quotesSection">Quotes</button>
      <button data-target="ordersSection">Orders</button>
    </nav>
    <main>
      <!-- LOGIN -->
      <div id="loginContainer">
        <h2>Login</h2>
        <form id="loginForm">
          <input type="email" id="loginEmail" placeholder="Email" required><br>
          <input type="password" id="loginPassword" placeholder="Password" required><br>
          <button type="submit">Login</button>
        </form>
        <div id="loginMessage" class="message"></div>
      </div>

      <div id="dashboardContainer" style="display:none;">
        <!-- PRODUCTS -->
        <div id="productsSection" class="section">
          <h2>Products</h2>
          <form id="productForm">
            <input type="text" id="productName" placeholder="Name" required>
            <input type="text" id="productDescription" placeholder="Description" required>
            <input type="number" id="priceNGN" placeholder="Price (NGN)" required>
            <input type="number" id="priceUSD" placeholder="Price (USD)" required>
            <input type="number" id="priceEUR" placeholder="Price (EUR)" required>
            <input type="number" id="priceGBP" placeholder="Price (GBP)" required>
            <button type="submit">Save Product</button>
          </form>
          <div id="productMessage" class="message"></div>
          <label>Currency: 
            <select id="tableCurrency">
              <option value="NGN">NGN</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </label>
          <table id="productsTable">
            <thead>
              <tr><th>Name</th><th>Description</th><th>Price</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- QUOTES -->
        <div id="quotesSection" class="section">
          <h2>Quotes</h2>
          <form id="quoteForm">
            <input type="text" id="customerName" placeholder="Customer Name" required>
            <input type="email" id="customerEmail" placeholder="Customer Email" required>

            <div class="collapsible">
              <button type="button" id="addQuoteItem">Add Item</button>
              <div id="quoteItemForm" class="hidden">
                <input type="text" id="itemName" placeholder="Item Name" required>
                <input type="number" id="itemQty" placeholder="Quantity" required>
                <input type="text" id="itemDesc" placeholder="Description" required>
                <input type="number" id="itemPriceNGN" placeholder="Price (NGN)" required>
                <input type="number" id="itemPriceUSD" placeholder="Price (USD)" required>
                <input type="number" id="itemPriceEUR" placeholder="Price (EUR)" required>
                <input type="number" id="itemPriceGBP" placeholder="Price (GBP)" required>
                <button type="button" id="pushQuoteItem">Add</button>
              </div>
            </div>

            <div id="quoteItems"></div>
            <button type="submit">Save Quote</button>
          </form>
          <div id="quoteMessage" class="message"></div>

          <label>View Totals In:
            <select id="quoteCurrencySelect">
              <option value="NGN">NGN</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </label>

          <table id="quotesTable">
            <thead>
              <tr>
                <th>Customer Name</th>
                <th>Email</th>
                <th>Checkout Link</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- ORDERS -->
        <div id="ordersSection" class="section">
          <h2>Orders</h2>
          <input type="text" id="orderSearch" placeholder="Search by email or ID">
          <select id="orderStatusFilter">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="shipped">Shipped</option>
          </select>
          <button id="exportOrders">Export</button>
          <input type="date" id="exportFrom">
          <input type="date" id="exportTo">
          <label>Currency: 
            <select id="exportCurrency">
              <option value="NGN">NGN</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </label>
          <table id="ordersTable">
            <thead>
              <tr><th>ID</th><th>Email</th><th>Items</th><th>Total</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- FIREBASE + APP LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
      authDomain: "brandisby.firebaseapp.com",
      projectId: "brandisby",
      storageBucket: "brandisby.firebasestorage.app",
      messagingSenderId: "87213267039",
      appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const allowedAdmins = ["yourstruly.fleurdevie@gmail.com"].map(e => e.toLowerCase().trim());

    /* --- UI refs --- */
    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");
    const loginContainer = document.getElementById("loginContainer");
    const dashboardContainer = document.getElementById("dashboardContainer");
    const productForm = document.getElementById("productForm");
    const productMessage = document.getElementById("productMessage");
    const productsTableBody = document.querySelector("#productsTable tbody");
    const tableCurrencySelect = document.getElementById("tableCurrency");

    const quoteForm = document.getElementById("quoteForm");
    const quoteItemsDiv = document.getElementById("quoteItems");
    const addQuoteItemBtn = document.getElementById("addQuoteItem");
    const quoteItemForm = document.getElementById("quoteItemForm");
    const pushQuoteItemBtn = document.getElementById("pushQuoteItem");
    const quotesTableBody = document.querySelector("#quotesTable tbody");
    const quoteMessage = document.getElementById("quoteMessage");
    const quoteCurrencySelect = document.getElementById("quoteCurrencySelect");

    const ordersTableBody = document.querySelector("#ordersTable tbody");
    const orderSearch = document.getElementById("orderSearch");
    const orderStatusFilter = document.getElementById("orderStatusFilter");
    const exportBtn = document.getElementById("exportOrders");
    const exportCurrency = document.getElementById("exportCurrency");
    const exportFrom = document.getElementById("exportFrom");
    const exportTo = document.getElementById("exportTo");

    let currentEditingProductId = null;
    let allOrders = [];
    let allQuotes = [];

    /* ---------------- AUTH ---------------- */
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginMessage.textContent = "";
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const normalized = (userCred.user.email || "").toLowerCase().trim();
        if (allowedAdmins.includes(normalized)) {
          loginContainer.style.display = "none";
          dashboardContainer.style.display = "block";
          subscribeProducts();
          subscribeQuotes();
          subscribeOrders();
          showSection("productsSection");
        } else {
          loginMessage.textContent = "âŒ Not authorized.";
          loginMessage.style.color = "red";
          await signOut(auth);
        }
      } catch (err) {
        console.error("Login error:", err);
        loginMessage.textContent = `âŒ ${err.code || ""}: ${err.message || err}`;
        loginMessage.style.color = "red";
      }
    });

    onAuthStateChanged(auth, user => {
      if (user && allowedAdmins.includes((user.email || "").toLowerCase().trim())) {
        loginContainer.style.display = "none";
        dashboardContainer.style.display = "block";
        subscribeProducts();
        subscribeQuotes();
        subscribeOrders();
        showSection("productsSection");
      } else {
        loginContainer.style.display = "block";
        dashboardContainer.style.display = "none";
      }
    });

    /* Navigation */
    document.querySelectorAll(".dashboard-nav button").forEach(btn => {
      btn.addEventListener("click", () => showSection(btn.dataset.target));
    });
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    /* ---------------- QUOTES LOGIC ---------------- */
    let tempQuoteItems = [];

    addQuoteItemBtn.addEventListener("click", () => {
      quoteItemForm.classList.toggle("hidden");
    });

    pushQuoteItemBtn.addEventListener("click", () => {
      const item = {
        name: document.getElementById("itemName").value,
        qty: parseInt(document.getElementById("itemQty").value),
        desc: document.getElementById("itemDesc").value,
        priceNGN: parseFloat(document.getElementById("itemPriceNGN").value),
        priceUSD: parseFloat(document.getElementById("itemPriceUSD").value),
        priceEUR: parseFloat(document.getElementById("itemPriceEUR").value),
        priceGBP: parseFloat(document.getElementById("itemPriceGBP").value)
      };
      tempQuoteItems.push(item);
      renderTempQuoteItems();
      quoteItemForm.classList.add("hidden");
    });

    function renderTempQuoteItems() {
      quoteItemsDiv.innerHTML = "";
      tempQuoteItems.forEach((it, idx) => {
        const div = document.createElement("div");
        div.className = "quote-item";
        div.innerHTML = `${it.name} (${it.qty}) - ${it.desc}
          [NGN:${it.priceNGN} | USD:${it.priceUSD} | EUR:${it.priceEUR} | GBP:${it.priceGBP}]
          <button data-idx="${idx}">Remove</button>`;
        div.querySelector("button").addEventListener("click", () => {
          tempQuoteItems.splice(idx,1);
          renderTempQuoteItems();
        });
        quoteItemsDiv.appendChild(div);
      });
    }

    quoteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const customerName = document.getElementById("customerName").value;
      const customerEmail = document.getElementById("customerEmail").value;
      const docRef = await addDoc(collection(db, "brands/fleurdevie/quotes"), {
        customerName, customerEmail, items: tempQuoteItems,
        status:"draft", createdAt: Date.now()
      });
      quoteMessage.textContent = "âœ… Quote saved!";
      tempQuoteItems = [];
      quoteItemsDiv.innerHTML = "";
    });

    function subscribeQuotes() {
      const q = collection(db, "brands/fleurdevie/quotes");
      onSnapshot(q, snap => {
        allQuotes = [];
        snap.forEach(doc => {
          allQuotes.push({id:doc.id, ...doc.data()});
        });
        renderQuotes();
      }, err => console.error("Quotes snapshot error:", err));
    }

    function renderQuotes() {
      quotesTableBody.innerHTML = "";
      const currency = quoteCurrencySelect.value;
      allQuotes.forEach(q => {
        let total = 0;
        q.items.forEach(it => {
          if (currency === "NGN") total += it.priceNGN * it.qty;
          if (currency === "USD") total += it.priceUSD * it.qty;
          if (currency === "EUR") total += it.priceEUR * it.qty;
          if (currency === "GBP") total += it.priceGBP * it.qty;
        });
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${q.customerName}</td>
          <td>${q.customerEmail}</td>
          <td>
            <a href="checkout.html?quoteId=${q.id}" target="_blank">Link</a>
            <span class="copy-btn" data-link="checkout.html?quoteId=${q.id}">ðŸ“‹</span>
          </td>
          <td>${currency} ${total.toFixed(2)}</td>
          <td>${q.status}</td>
          <td>
            <button data-id="${q.id}" class="deleteQuote">Delete</button>
          </td>`;
        quotesTableBody.appendChild(tr);
      });
      document.querySelectorAll(".copy-btn").forEach(btn=>{
        btn.addEventListener("click",()=>{
          navigator.clipboard.writeText(btn.dataset.link);
          alert("Link copied!");
        });
      });
      document.querySelectorAll(".deleteQuote").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          await deleteDoc(doc(db,"brands/fleurdevie/quotes",btn.dataset.id));
        });
      });
    }
    quoteCurrencySelect.addEventListener("change", renderQuotes);

    /* ---------------- PRODUCTS + ORDERS (unchanged for brevity) ---------------- */
    function subscribeProducts() {/* ... your existing logic ... */}
    function subscribeOrders() {/* ... your existing logic ... */}

  </script>
</body>
</html>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // -----------------------------
  // Firebase Configuration
  // -----------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
    authDomain: "brandisby.firebaseapp.com",
    projectId: "brandisby",
    storageBucket: "brandisby.firebasestorage.app",
    messagingSenderId: "87213267039",
    appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // -----------------------------
  // Elements
  // -----------------------------
  const form = document.getElementById('trackOrderForm');
  const statusBox = document.getElementById('orderStatus');
  const detailsList = document.getElementById('orderDetails');
  const overlay = document.getElementById('serac-overlay');

  function showSpinner(show) {
    if (overlay) overlay.style.display = show ? 'flex' : 'none';
  }

  // -----------------------------
  // Handle Order Tracking
  // -----------------------------
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const ref = document.getElementById('orderRef').value.trim();
    if (!ref) return alert('Please enter your order reference.');

    showSpinner(true);
    detailsList.innerHTML = '';
    statusBox.style.display = 'none';

    try {
      // ðŸ”¥ Query only inside brands/serac/orders, filtered by trackingRef
      const q = query(
        collection(db, "brands", "serac", "orders"),
        where("trackingRef", "==", ref)
      );

      const snap = await getDocs(q);
      showSpinner(false);

      if (snap.empty) {
        statusBox.style.display = 'block';
        detailsList.innerHTML = '<li><strong>Notice:</strong> No order found for that reference.</li>';
        return;
      }

      const doc = snap.docs[0].data();
      const date = doc.date ? new Date(doc.date).toLocaleString() : 'â€”';
      const amount = doc.total ? `${doc.currency || 'â‚¦'}${doc.total.toLocaleString()}` : 'â€”';
      const items = (doc.items || []).map(i => `${i.name} (${i.qty})`).join('<br>');

      detailsList.innerHTML = `
        <li><strong>Status:</strong> ${doc.status || 'Processing'}</li>
        <li><strong>Date:</strong> ${date}</li>
        <li><strong>Amount:</strong> ${amount}</li>
        <li><strong>Items:</strong><br>${items || 'â€”'}</li>
      `;
      statusBox.style.display = 'block';

    } catch (err) {
      console.error(err);
      showSpinner(false);
      detailsList.innerHTML = '<li><strong>Error:</strong> Unable to fetch order details. Try again later.</li>';
      statusBox.style.display = 'block';
    }
  });
</script>

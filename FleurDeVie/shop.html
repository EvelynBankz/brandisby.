<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleur De Vie - Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* RESET */
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:"Montserrat", sans-serif;
  background:#F5E6CC;
  color:#112e1f;
  line-height:1.6;
}
a { text-decoration:none; color:inherit; }

/* HEADER */
.site-header {
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:1000;
  display:flex;
  justify-content:space-between;
  align-items:center;
  height:60px;
  padding:8px 20px;
  background:rgba(8,30,20,0.6); /* deep green tint */
  color:#F5E6CC;
  backdrop-filter:blur(8px);
  transition:opacity 0.4s ease, background 0.3s ease;
  opacity:1;
}
.site-header:hover { background:#112e1f; }
.site-header.hidden { opacity:0; pointer-events:none; }

.header-left { display:flex; align-items:center; gap:10px; }
.brand-logo { height:60px; transition:height 0.3s ease; }
.brand-title {
  font-family:"Playfair Display", serif;
  font-size:22px;
  font-weight:700;
}
.header-right { display:flex; gap:20px; align-items:center; }
.header-right a { font-weight:500; transition: color 0.3s; }
.header-right a:hover { color:#FFD6BA; }
.cart-count {
  background:#FFD6BA;
  color:#112e1f;
  font-size:12px;
  font-weight:600;
  border-radius:50%;
  padding:2px 6px;
  margin-left:4px;
}
.hamburger {
  display:none;
  background:none;
  border:none;
  cursor:pointer;
  width:30px;
  height:24px;
  position:relative;
}
.hamburger span {
  display:block;
  width:100%;
  height:3px;
  background:#F5E6CC;
  border-radius:2px;
  position:absolute;
  left:0;
  transition:0.3s;
}
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; }

/* HERO */
.hero {
  position:relative;
  height:90vh;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  margin-top:60px;
  overflow:hidden;
}
.hero::after {
  content:"";
  position:absolute;
  inset:0;
  background:url('asset/bg12.jpg') center/cover no-repeat;
  transform:scale(1.1);
  z-index:-1;
  border-radius:12px;
  box-shadow: inset 0 0 0 2000px rgba(17,46,31,0.3);
}
.hero-text {
  position:relative;
  color:#FFD6BA;
  text-shadow:0 2px 6px rgba(0,0,0,0.4);
}
.hero-text h1 {
  font-family:"Playfair Display", serif;
  font-size:clamp(36px,5vw,64px);
  margin-bottom:12px;
}
.hero-text p {
  font-size:clamp(16px,2vw,24px);
  max-width:700px;
}

/* SHOP */
section.shop {
  padding:80px 20px;
  background:#F5E6CC;
}
.container { max-width:1100px; margin:auto; }
h2 {
  text-align:center;
  font-size:24px;
  font-family:"Playfair Display", serif;
  margin-bottom:40px;
}

/* PRODUCT GRID */
.product-grid {
  display:grid;
  gap:20px;
  grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
}
.product-card {
  background:#FFD6BA;
  padding:16px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  display:flex;
  flex-direction:column;
  transition:transform 0.2s;
  position:relative;
  color:inherit;
}
.product-card:hover { transform:translateY(-5px); }
.product-card img {
  width:100%;
  height:180px;
  object-fit:contain;
  border-radius:8px;
  margin-bottom:12px;
  background:#fff;
}
.product-card h3 {
  font-family:"Playfair Display", serif;
  font-size:1.1rem;
  margin-bottom:6px;
}
.product-card .description {
  font-size:0.9rem;
  color:#112e1f;
  margin-bottom:8px;
}
.product-card .price { font-weight:600; margin-bottom:12px; }
.product-card button {
  background:#112e1f;
  color:#F5E6CC;
  border:none;
  border-radius:6px;
  padding:10px;
  cursor:pointer;
  transition:0.3s;
}
.product-card button:hover { background:#0a1d14; }

/* FOOTER */
footer {
  text-align:center;
  padding:20px;
  background:transparent;
  color:#112e1f;
  margin-top:60px;
}

/* MEDIA */
@media(max-width:900px){
  .product-grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
}
@media(max-width:600px){
  .product-grid{grid-template-columns:repeat(2,1fr);}
  .product-card img{height:140px;}
  .header-right{
    display:none;
    flex-direction:column;
    background:#112e1f;
    position:absolute;
    top:70px;
    right:0;
    width:200px;
    padding:20px;
  }
  .header-right.open{display:flex;}
  .hamburger{display:block;}
  .mobile-cart{
    display:flex;
    align-items:center;
    margin-right:10px;
  }
  .mobile-cart a{
    color:#FFD6BA;
    font-size:20px;
    position:relative;
  }
  .mobile-cart .cart-count{
    position:absolute;
    top:-8px;
    right:-8px;
  }
  .hero{
    height:40vh;
    margin-top:20px;
    padding-top:80px;
  }
  .hero-text h1{
    font-size:clamp(24px,5vw,32px);
    line-height:1.2;
    margin:0;
  }
  .hero-text p{
    font-size:clamp(14px,2.5vw,18px);
    margin:0 auto;
  }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-left">
    <img src="asset/logo.png" alt="Fleur De Vie Logo" class="brand-logo">
    <div class="brand-title">Fleur De Vie</div>
  </div>
  <div class="mobile-cart" style="display:none;">
    <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>
  <nav class="header-right">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="customization.html">Customize</a>
    <a href="contact.html">Contact</a>
  </nav>
  <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-text">
    <h1>Shop</h1>
    <p>Explore our collection of products</p>
  </div>
</section>

<!-- SHOP -->
<section class="shop">
  <div class="container">
    <h2>Our Products</h2>
    <div class="shop-controls">
      <input type="text" id="searchInput" placeholder="Search products...">
      <div class="currency-filter-group">
        <select id="currencySelect">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
        <select id="sortSelect">
          <option value="">Filter / Sort</option>
          <option value="alphabet">Alphabet</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
    </div>
    <div class="product-grid" id="productGrid"></div>
  </div>
</section>

<!-- FOOTER -->
<footer>
  <p>© 2025 Fleur De Vie</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const productGrid = document.getElementById('productGrid');
const cartCountElem = document.getElementById('cartCount');
const cartCountMobileElem = document.getElementById('cartCountMobile');
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const currencySelect = document.getElementById('currencySelect');

let cart = JSON.parse(localStorage.getItem('cart')) || [];
let productsData = {};

if(localStorage.getItem('currency')) currencySelect.value = localStorage.getItem('currency');
currencySelect.addEventListener('change', ()=>{ localStorage.setItem('currency', currencySelect.value); loadProducts(); });

function getCart(){ return JSON.parse(localStorage.getItem('cart')) || []; }
function setCart(cartArray){ 
  cart = mergeCartItems(cartArray); 
  localStorage.setItem('cart', JSON.stringify(cart)); 
  updateCartCount(); 
}

function updateCartCount(){ 
  const total = cart.reduce((sum,i)=>sum+(i.quantity||0),0); 
  cartCountElem.textContent=total; 
  cartCountMobileElem.textContent=total;
}

// Merge cart items by id + variant
function mergeCartItems(cartArray){
  const merged = [];
  cartArray.forEach(item=>{
    const idx = merged.findIndex(i=>i.id===item.id && (i.color||'')=== (item.color||'') && (i.size||'')=== (item.size||''));
    if(idx===-1) merged.push({...item});
    else merged[idx].quantity = (merged[idx].quantity||0) + (item.quantity||0);
  });
  return merged;
}

// Calculate total quantity for product across all variants
function getTotalQuantity(productId){
  return cart.filter(i=>i.id===productId).reduce((sum,i)=>sum+(i.quantity||0),0);
}

function addToCart(product){
  let currentCart = getCart();
  const idx = currentCart.findIndex(i=>i.id===product.id && (i.color||'')===(product.color||'') && (i.size||'')===(product.size||''));
  if(idx>-1) currentCart[idx].quantity +=1;
  else currentCart.push({...product,quantity:1});
  setCart(currentCart);
  updateProductUI(product.id);
}

function removeFromCart(productId){
  let currentCart = getCart();
  const idx = currentCart.findIndex(i=>i.id===productId);
  if(idx>-1){ currentCart[idx].quantity-=1; if(currentCart[idx].quantity<=0) currentCart.splice(idx,1); }
  setCart(currentCart);
  updateProductUI(productId);
}

// Update product card UI based on total quantity across all variants
function updateProductUI(productId){
  const card = document.getElementById(`product-${productId}`);
  if(!card) return;
  const addBtn = card.querySelector('.add-cart');
  const badge = card.querySelector('.quantity-badge');
  const totalQty = getTotalQuantity(productId);
  if(totalQty>0){ addBtn.style.display='none'; badge.textContent=totalQty; } 
  else { addBtn.style.display='block'; badge.textContent=''; }
}

function formatPrice(product, currency){
  if(!product) return '';
  const price = currency==='NGN'?product.priceNGN:currency==='USD'?product.priceUSD:currency==='EUR'?product.priceEUR:currency==='GBP'?product.priceGBP:product.priceNGN;
  const localeMap={ NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
  return new Intl.NumberFormat(localeMap[currency],{style:'currency',currency,minimumFractionDigits:currency==='NGN'?0:2}).format(price);
}

async function loadProducts(){
  try{
    const q = query(collection(db,"brands","fleurdevie","products"), where("published","==",true));
    const snapshot = await getDocs(q);
    const products=[];
    snapshot.forEach(doc=>{
      const data=doc.data();
      if(!data.name || !data.imageUrl) return;
      products.push({id:doc.id,...data});
      productsData[doc.id]=data;
    });
    displayProducts(products);
  }catch(e){ console.error(e); productGrid.innerHTML='<p style="text-align:center;color:red;">Failed to load products.</p>'; }
}

function displayProducts(products){
  const term = searchInput.value.toLowerCase();
  let filtered = products.filter(p=>p.name.toLowerCase().includes(term));
  const sortVal = sortSelect.value;
  const currency = currencySelect.value;
  function getPriceForCurrency(product){ return currency==='NGN'?product.priceNGN:currency==='USD'?product.priceUSD:currency==='EUR'?product.priceEUR:currency==='GBP'?product.priceGBP:product.priceNGN; }
  if(sortVal==='alphabet') filtered.sort((a,b)=>a.name.localeCompare(b.name));
  if(sortVal==='price-asc') filtered.sort((a,b)=>getPriceForCurrency(a)-getPriceForCurrency(b));
  if(sortVal==='price-desc') filtered.sort((a,b)=>getPriceForCurrency(b)-getPriceForCurrency(a));

  productGrid.innerHTML='';
  for(const p of filtered){
    const quantity = getTotalQuantity(p.id);
    const priceForCurrency = getPriceForCurrency(p);

    const div = document.createElement('div');
    div.className='product-card';
    div.id=`product-${p.id}`;

    div.innerHTML=`
      ${p.customizationAvailable?`<a href="customization.html?productId=${p.id}" class="customize-badge" onclick="event.stopPropagation()"><i class="fa-solid fa-wand-magic-sparkles"></i> Customize</a>`:''}
      <a href="product.html?productId=${p.id}&price=${priceForCurrency}&currency=${currency}">
        <img src="${p.imageUrl}" alt="${p.name}">
      </a>
      <h3>${p.name}</h3>
      <div class="description">${truncateText(p.description||'',15)}</div>
      <div class="price">${formatPrice(p,currency)}</div>
      <div class="quantity-controls">
        <button class="minus">-</button>
        <span class="quantity-badge">${quantity>0?quantity:''}</span>
        <button class="plus">+</button>
      </div>
      <button class="add-cart" style="display:${quantity>0?'none':'block'};">Add to Cart</button>
    `;

    div.querySelector('.plus').addEventListener('click', e=>{ e.stopPropagation(); addToCart(p); });
    div.querySelector('.minus').addEventListener('click', e=>{ e.stopPropagation(); removeFromCart(p.id); });
    div.querySelector('.add-cart').addEventListener('click', e=>{ e.stopPropagation(); addToCart(p); });

    productGrid.appendChild(div);
  }
}

function truncateText(text, wordLimit){ return text.split(' ').slice(0,wordLimit).join(' '); }

searchInput.addEventListener('input', loadProducts);
sortSelect.addEventListener('change', loadProducts);

document.getElementById('hamburger').addEventListener('click', ()=>{
  document.querySelector('.header-right').classList.toggle('open');
  document.getElementById('hamburger').classList.toggle('open');
});

function handleMobileCart(){ document.querySelector('.mobile-cart').style.display=window.innerWidth<=600?'flex':'none'; }
window.addEventListener('resize', handleMobileCart);
handleMobileCart();

updateCartCount();
loadProducts();
window.addEventListener('storage', ()=>{ 
  cart = JSON.parse(localStorage.getItem('cart')) || [];
  cart = mergeCartItems(cart);
  updateCartCount();
  loadProducts();
});

/*-----NEW HEADER SCROLL SETTINGS----*/

const header = document.querySelector('.site-header');
const hero = document.querySelector('.hero');
let pastHero = false;

// Track scroll position
window.addEventListener('scroll', () => {
  const heroBottom = hero.offsetTop + hero.offsetHeight;
  pastHero = window.scrollY > heroBottom;
  if (!pastHero) {
    header.classList.remove('hidden');
  } else {
    header.classList.add('hidden');
  }
});

// Show header on hover when past hero
document.addEventListener('mousemove', (e) => {
  if (pastHero) {
    if (e.clientY < 90) header.classList.remove('hidden');
    else header.classList.add('hidden');
  }
});

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleur De Vie - Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:"Montserrat",sans-serif;background:#F5E6CC;color:#112e1f;line-height:1.6;}
    a{text-decoration:none;color:inherit;}
    .site-header{background:#112e1f;color:#F5E6CC;display:flex;justify-content:space-between;align-items:center;padding:16px 28px;position:fixed;top:0;left:0;right:0;z-index:1000;}
    .header-left{display:flex;align-items:center;gap:12px;}
    .brand-logo{height:60px;}
    .brand-title{font-family:"Playfair Display",serif;font-size:24px;font-weight:700;}
    .header-right{display:flex;gap:20px;align-items:center;}
    .header-right a{font-weight:500;transition:color 0.3s;}
    .header-right a:hover{color:#FFD6BA;}
    .cart-count{background:#FFD6BA;color:#112e1f;font-size:12px;font-weight:600;border-radius:50%;padding:2px 6px;margin-left:4px;}
    .hamburger{display:none;background:none;border:none;cursor:pointer;width:30px;height:24px;position:relative;}
    .hamburger span{display:block;width:100%;height:3px;background:#F5E6CC;border-radius:2px;position:absolute;left:0;transition:0.3s;}
    .hamburger span:nth-child(1){top:0;}
    .hamburger span:nth-child(2){top:10px;}
    .hamburger span:nth-child(3){top:20px;}
    .hamburger.open span:nth-child(1){transform:rotate(45deg);top:10px;}
    .hamburger.open span:nth-child(2){opacity:0;}
    .hamburger.open span:nth-child(3){transform:rotate(-45deg);top:10px;}
    .hero{position:relative;height:40vh;display:flex;justify-content:center;align-items:center;text-align:center;margin-top:80px;overflow:hidden;}
    .hero::after{content:"";position:absolute;inset:0;background:url('../bg.jpg') center/cover no-repeat;transform:scale(1.1);z-index:-1;border-radius:12px;box-shadow:inset 0 0 0 2000px rgba(17,46,31,0.3);}
    .hero-text{position:relative;display:inline-block;color:#FFD6BA;}
    .hero-text h1{font-family:"Playfair Display",serif;font-size:clamp(32px,5vw,56px);}
    section.checkout{padding:60px 20px;}
    .container{max-width:1100px;margin:auto;display:grid;grid-template-columns:2fr 1fr;gap:30px;}
    .checkout-form{background:#FFD6BA;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .order-summary{background:#C9E4FF;padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    h2{font-family:"Playfair Display",serif;margin-bottom:16px;font-size:22px;}
    label{display:block;margin-bottom:6px;font-weight:500;}
    input,textarea,select{width:100%;padding:10px;margin-bottom:14px;border-radius:6px;border:1px solid #112e1f;font-family:"Montserrat",sans-serif;}
    textarea{resize:vertical;min-height:80px;}
    .order-summary ul{list-style:none;margin:0;padding:0;}
    .order-summary li{display:flex;justify-content:space-between;margin-bottom:10px;}
    .order-summary .subtotal{font-weight:600;margin-top:10px;text-align:right;}
    .currency-selector{text-align:right;margin-bottom:10px;}
    .currency-selector select{padding:5px 10px;border-radius:6px;border:1px solid #112e1f;}
    .checkout-btn{display:block;width:100%;background:#112e1f;color:#F5E6CC;text-align:center;padding:14px;font-weight:600;border-radius:6px;cursor:pointer;transition:0.3s;border:none;}
    .checkout-btn:hover{background:#0a1d14;}
    footer{text-align:center;padding:20px;background:#112e1f;color:#F5E6CC;margin-top:60px;}
    @media(max-width:800px){
      .container{grid-template-columns:1fr;}
      .header-right{display:none;flex-direction:column;position:absolute;top:70px;right:0;background:#112e1f;width:200px;padding:20px;}
      .header-right.open{display:flex;}
      .hamburger{display:block;}
    }
    @media(max-width:600px){
      .hero{height:30vh;margin-top:0;padding-top:80px;display:flex;justify-content:center;align-items:center;text-align:center;}
      .hero-text h1{font-size:clamp(24px,5vw,32px);line-height:1.2;margin:0;}
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="header-left">
    <img src="../logo.png" alt="Fleur De Vie Logo" class="brand-logo">
    <div class="brand-title">Fleur De Vie</div>
  </div>
  <nav class="header-right">
    <a href="../index.html">Home</a>
    <a href="../shop.html">Shop</a>
    <a href="../about.html">About</a>
    <a href="../contact.html">Contact</a>
    <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
  </nav>
  <button class="hamburger" id="hamburger"><span></span><span></span><span></span></button>
</header>

<section class="hero">
  <div class="hero-text"><h1>Checkout</h1></div>
</section>

<section class="checkout">
  <div class="container">
    <!-- Billing Form -->
    <div class="checkout-form">
      <h2>Billing Details</h2>
      <form id="checkoutForm">
        <label for="name">Full Name</label>
        <input type="text" id="name" required>
        <label for="email">Email</label>
        <input type="email" id="email" required>
        <label for="phone">Phone</label>
        <input type="tel" id="phone" required>
        <label for="address">Address</label>
        <textarea id="address" required></textarea>
      </form>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
      <h2>Order Summary</h2>
      <div class="currency-selector" id="currencySelectorWrapper">
        <label for="currency">Currency:</label>
        <select id="currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
      <ul id="orderItems"></ul>
      <div class="subtotal" id="orderSubtotal"></div>
      <button class="checkout-btn" id="payBtn">Proceed to Payment</button>
    </div>
  </div>
</section>

<footer><p>Â© 2025 Fleur De Vie</p></footer>

<script src="https://checkout.flutterwave.com/v3.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM elements
const cartCountElem = document.getElementById('cartCount');
const orderItems = document.getElementById('orderItems');
const orderSubtotal = document.getElementById('orderSubtotal');
const currencySelect = document.getElementById('currency');
const currencyWrapper = document.getElementById('currencySelectorWrapper');
const payBtn = document.getElementById('payBtn');

let cart = JSON.parse(localStorage.getItem('cart')) || [];
let quote = null;
let selectedCurrency = 'NGN';

// Format price helper
function formatPrice(value, currency){
  const localeMap = { USD:'en-US', EUR:'de-DE', GBP:'en-GB', NGN:'en-NG' };
  return new Intl.NumberFormat(localeMap[currency]||'en-US',{ style:'currency', currency, minimumFractionDigits: currency==='NGN'?0:2 }).format(value);
}

// Update cart count
function updateCartCount(){
  const total = cart.reduce((sum,i)=>sum+i.quantity,0);
  cartCountElem.textContent = total;
}

// Render order summary
function renderOrder() {
  orderItems.innerHTML = '';
  let subtotal = 0;

  if (quote && Array.isArray(quote.items)) {
    quote.items.forEach(item => {
      subtotal += item.price * item.quantity;
      const li = document.createElement('li');
      li.innerHTML = `${item.name} (x${item.quantity}) <span>${formatPrice(item.price * item.quantity, selectedCurrency)}</span>`;
      orderItems.appendChild(li);
    });
  } else {
    orderItems.innerHTML = '<li>No items found in this quote.</li>';
  }

  orderSubtotal.textContent = `Subtotal: ${formatPrice(subtotal, selectedCurrency)}`;
}


// Load quote if exists
const urlParams = new URLSearchParams(window.location.search);
const quoteId = urlParams.get("quoteId");

async function loadQuote() {
  if (quoteId) {
    try {
      const docRef = doc(db, "brands", "fleurdevie", "quotes", quoteId);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const rawQuote = docSnap.data();

        // Pre-fill customer details
        if (rawQuote.customer) document.getElementById('name').value = rawQuote.customer;
        if (rawQuote.email) document.getElementById('email').value = rawQuote.email;

        selectedCurrency = localStorage.getItem('currency') || rawQuote.currency || 'NGN';
        currencySelect.value = selectedCurrency;
        currencyWrapper.style.display = 'block';

        // Normalize items for rendering
        quote = rawQuote;
        if (Array.isArray(rawQuote.items)) {
          quote.items = rawQuote.items.map(item => ({
            name: item.name,
            desc: item.desc,
            quantity: item.qty,
            prices: {
              NGN: item.priceNGN ?? 0,
              USD: item.priceUSD ?? 0,
              EUR: item.priceEUR ?? 0,
              GBP: item.priceGBP ?? 0
            }
          }));
        } else {
          quote.items = [];
        }

        renderOrder();
      } else {
        alert("Quote not found.");
      }
    } catch (err) {
      console.error("Failed to fetch quote", err);
      alert("Error loading quote. Please try again.");
    }
  }
}



// Proceed to payment
payBtn.addEventListener('click', async ()=>{
  const name=document.getElementById('name').value;
  const email=document.getElementById('email').value;
  const phone=document.getElementById('phone').value;
  const address=document.getElementById('address').value;
  if(!name||!email||!phone||!address){ alert("Please fill in all billing details."); return; }

  let subtotal=0, items=[];
  if(quote){
    items = quote.items;
    items.forEach(item=> subtotal += (item.prices[selectedCurrency] ?? 0) * item.quantity );
  }else{
    items = cart;
    items.forEach(item=> subtotal += (item.prices[selectedCurrency] ?? 0) * item.quantity );
  }

  FlutterwaveCheckout({
    public_key:"FLWPUBK_TEST-xxxxxxxxxxxxxxxxxxxxx-X",
    tx_ref:"fleurdevie-"+Date.now(),
    amount: subtotal.toFixed(2),
    currency: selectedCurrency,
    customer:{ email, phonenumber:phone, name },
    customizations:{ title:"Fleur De Vie", description:"Order Payment", logo:"../fleurdevie/logo.png" },
    callback: async function(data){
      try{
        await addDoc(collection(db,"orders"),{
          name,email,phone,address,
          currency:selectedCurrency,
          items, total:subtotal.toFixed(2),
          paymentRef:data.tx_ref, status:"paid", createdAt:serverTimestamp()
        });
        localStorage.removeItem('cart');
        window.location.href="../fleurdevie/thankyou.html";
      }catch(err){ console.error("Order save failed",err); alert("Order save failed, but payment succeeded!"); }
    }
  });
});

// Currency change handler
currencySelect.addEventListener('change', ()=>{
  selectedCurrency = currencySelect.value;
  localStorage.setItem('currency', selectedCurrency);
  renderOrder();
});

// Initialize
updateCartCount();
loadQuote();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { background:#333; color:#fff; padding:10px; text-align:center; }
    .container { padding:20px; }
    .dashboard-nav { margin-bottom:20px; }
    .dashboard-nav button { margin-right:10px; }
    .section { display:none; }
    .section.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f4f4f4; }
    .copy-btn { cursor:pointer; margin-left:5px; }
  </style>
</head>
<body>
<header>
  <h1>Admin Dashboard</h1>
</header>
<div class="container">
  <!-- LOGIN -->
  <div id="loginContainer">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p id="loginMessage"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardContainer" style="display:none;">
    <div class="dashboard-nav">
      <button data-target="productsSection">Products</button>
      <button data-target="quotesSection">Quotes</button>
      <button data-target="ordersSection">Orders</button>
    </div>

    <!-- PRODUCTS -->
    <div id="productsSection" class="section">
      <h2>Products</h2>
      <form id="productForm">
        <input type="text" id="productName" placeholder="Name" required />
        <input type="text" id="productDescription" placeholder="Description"/>
        <input type="number" id="priceNGN" placeholder="Price NGN" step="0.01"/>
        <input type="number" id="priceUSD" placeholder="Price USD" step="0.01"/>
        <input type="number" id="priceEUR" placeholder="Price EUR" step="0.01"/>
        <input type="number" id="priceGBP" placeholder="Price GBP" step="0.01"/>
        <label><input type="checkbox" id="productPublished"/> Published</label>
        <button type="submit">Add / Update</button>
      </form>
      <p id="productMessage"></p>
      <label>View prices in:
        <select id="tableCurrency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </label>
      <table id="productsTable">
        <thead>
          <tr>
            <th>Name</th><th>Description</th><th>Price</th><th>Published</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- QUOTES -->
    <div id="quotesSection" class="section">
      <h2>Quotes</h2>
      <form id="quoteForm">
        <input type="text" id="customerName" placeholder="Customer Name" required />
        <input type="email" id="customerEmail" placeholder="Customer Email" required />
        <div id="quoteItems"></div>
        <button type="button" id="addQuoteItem">+ Add Item</button>
        <button type="submit">Save Quote</button>
      </form>
      <p id="quoteMessage"></p>

      <label>View totals in:
        <select id="quoteTableCurrency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </label>

      <table id="quotesTable">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Email</th>
            <th>Total</th>
            <th>Status</th>
            <th>Checkout Link</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ORDERS -->
    <div id="ordersSection" class="section">
      <h2>Orders</h2>
      <input type="text" id="orderSearch" placeholder="Search orders..." />
      <select id="orderStatusFilter">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="shipped">Shipped</option>
      </select>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th><th>Customer</th><th>Email</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="exportOrders">Export</button>
      <select id="exportCurrency">
        <option value="NGN">NGN</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>
      <input type="date" id="exportFrom"/>
      <input type="date" id="exportTo"/>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // 🔹 Your Firebase Config (kept intact)
  const firebaseConfig = {
    apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
    authDomain: "brandisby.firebaseapp.com",
    projectId: "brandisby",
    storageBucket: "brandisby.firebasestorage.app",
    messagingSenderId: "87213267039",
    appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 🔹 Allowed Admins
  const allowedAdmins = ["yourstruly.fleurdevie@gmail.com"].map(e => e.toLowerCase().trim());

  // 🔹 UI refs
  const loginForm = document.getElementById("loginForm");
  const loginMessage = document.getElementById("loginMessage");
  const loginContainer = document.getElementById("loginContainer");
  const dashboardContainer = document.getElementById("dashboardContainer");
  const productsTableBody = document.querySelector("#productsTable tbody");
  const tableCurrencySelect = document.getElementById("tableCurrency");
  const quoteForm = document.getElementById("quoteForm");
  const quoteItemsDiv = document.getElementById("quoteItems");
  const addQuoteItemBtn = document.getElementById("addQuoteItem");
  const quotesTableBody = document.querySelector("#quotesTable tbody");
  const quoteMessage = document.getElementById("quoteMessage");
  const quoteTableCurrency = document.getElementById("quoteTableCurrency");
  const ordersTableBody = document.querySelector("#ordersTable tbody");

  let allQuotes = [];

  /* ---------------- AUTH ---------------- */
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginMessage.textContent = "";
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    try {
      const userCred = await signInWithEmailAndPassword(auth, email, password);
      const normalized = (userCred.user.email || "").toLowerCase().trim();
      if (allowedAdmins.includes(normalized)) {
        loginContainer.style.display = "none";
        dashboardContainer.style.display = "block";
        subscribeQuotes();
        showSection("quotesSection");
      } else {
        loginMessage.textContent = "❌ Not authorized.";
        loginMessage.style.color = "red";
        await signOut(auth);
      }
    } catch (err) {
      loginMessage.textContent = `❌ ${err.code || ""}: ${err.message || err}`;
      loginMessage.style.color = "red";
    }
  });

  onAuthStateChanged(auth, user => {
    if (user && allowedAdmins.includes((user.email || "").toLowerCase().trim())) {
      loginContainer.style.display = "none";
      dashboardContainer.style.display = "block";
      subscribeQuotes();
      showSection("quotesSection");
    } else {
      loginContainer.style.display = "block";
      dashboardContainer.style.display = "none";
    }
  });

  document.querySelectorAll(".dashboard-nav button").forEach(btn => {
    btn.addEventListener("click", () => showSection(btn.dataset.target));
  });

  function showSection(id) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  /* ---------------- QUOTES ---------------- */
  addQuoteItemBtn.addEventListener("click", () => {
    const div = document.createElement("div");
    div.innerHTML = `
      <input type="text" placeholder="Item name" class="itemName" required />
      <input type="number" placeholder="Qty" class="itemQty" value="1"/>
      <input type="text" placeholder="Description" class="itemDesc"/>
      <input type="number" placeholder="NGN price" class="priceNGN"/>
      <input type="number" placeholder="USD price" class="priceUSD"/>
      <input type="number" placeholder="EUR price" class="priceEUR"/>
      <input type="number" placeholder="GBP price" class="priceGBP"/>
      <button type="button" class="removeItem">Remove</button>
    `;
    div.querySelector(".removeItem").onclick = () => div.remove();
    quoteItemsDiv.appendChild(div);
  });

  quoteForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const customerName = document.getElementById("customerName").value;
      const customerEmail = document.getElementById("customerEmail").value;
      const items = [...quoteItemsDiv.querySelectorAll("div")].map(div => ({
        name: div.querySelector(".itemName").value,
        qty: parseInt(div.querySelector(".itemQty").value || 1),
        desc: div.querySelector(".itemDesc").value,
        NGN: parseFloat(div.querySelector(".priceNGN").value) || 0,
        USD: parseFloat(div.querySelector(".priceUSD").value) || 0,
        EUR: parseFloat(div.querySelector(".priceEUR").value) || 0,
        GBP: parseFloat(div.querySelector(".priceGBP").value) || 0,
      }));
      await addDoc(collection(db, "brands", "fleurdevie", "quotes"), {
        customerName, customerEmail, items, status:"pending", created: Date.now()
      });
      quoteMessage.textContent = "✅ Quote saved!";
      quoteMessage.style.color = "green";
      quoteForm.reset();
      quoteItemsDiv.innerHTML = "";
    } catch (err) {
      quoteMessage.textContent = `❌ ${err.message}`;
      quoteMessage.style.color = "red";
    }
  });

  function subscribeQuotes() {
    onSnapshot(collection(db, "brands", "fleurdevie", "quotes"), (snap) => {
      allQuotes = [];
      snap.forEach(docSnap => allQuotes.push({ id: docSnap.id, ...docSnap.data() }));
      renderQuotes();
    }, err => console.error("Quotes snapshot error:", err));
  }

  function renderQuotes() {
    quotesTableBody.innerHTML = "";
    const currency = quoteTableCurrency.value;
    allQuotes.forEach(q => {
      const total = q.items.reduce((sum, it) => sum + ((it[currency] || 0) * (it.qty||1)), 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${q.customerName}</td>
        <td>${q.customerEmail}</td>
        <td>${currency} ${total.toFixed(2)}</td>
        <td>${q.status}</td>
        <td>
          <a href="checkout.html?quoteId=${q.id}" target="_blank">Link</a>
          <span class="copy-btn" data-link="checkout.html?quoteId=${q.id}">📋</span>
        </td>
        <td><button data-id="${q.id}" class="deleteQuote">Delete</button></td>
      `;
      tr.querySelector(".copy-btn").addEventListener("click", () => {
        navigator.clipboard.writeText(location.origin + "/checkout.html?quoteId=" + q.id);
      });
      tr.querySelector(".deleteQuote").addEventListener("click", async () => {
        await deleteDoc(doc(db, "brands", "fleurdevie", "quotes", q.id));
      });
      quotesTableBody.appendChild(tr);
    });
  }

  quoteTableCurrency.addEventListener("change", renderQuotes);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SÃ©rac - Checkout</title>

<!-- Fonts + Icons (same as cart) -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --bg-mid: #2A2B30;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --accent-strong: rgba(182,110,65,0.95);
  --radius: 14px;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body { height:100%; }
body { font-family:"Montserrat", sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
a { text-decoration:none; color:inherit; transition: color var(--transition); }

/* HEADER */
.site-header { background: transparent; transition: background 0.3s ease, border-bottom 0.3s ease; color:#f5f5f5; display:flex; justify-content:space-between; align-items:center; padding:16px 28px; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.04); }
.site-header.scrolled { background:var(--bg-dark); border-bottom:1px solid rgba(255,255,255,0.06); }

.header-left { display:flex; align-items:center; gap:14px; }
.brand-logo { height:56px; width:auto; object-fit:contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; color:var(--gold); letter-spacing:0.6px; }

.header-right { display:flex; gap:20px; align-items:center; }
.header-right a { font-weight:500; color:var(--muted); padding:6px 8px; border-radius:8px; transition: all var(--transition); }
.header-right a:hover { color:#fff; transform:translateY(-2px); text-shadow: 0 4px 18px rgba(182,110,65,0.15); }

.cart-count { background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:38px; height:32px; position:relative; z-index:1200; }
.hamburger span { display:block; width:100%; height:3px; background:var(--gold); border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:6px; }
.hamburger span:nth-child(2){ top:14px; }
.hamburger span:nth-child(3){ top:22px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:14px; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:14px; }

/* HERO */
.hero { position: relative; height: 90vh; display: flex; justify-content: center; align-items: center; text-align: center; margin-top: 0px; overflow: hidden; padding-top:72px; border-bottom-left-radius: 12px; border-bottom-right-radius:12px; }
.hero::after { content: ""; position: absolute; inset: 0; background: var(--hero-bg, url('asset/bg25.jpg')) center/cover no-repeat; transform: scale(1.06); z-index: -1; border-radius: 12px; box-shadow: inset 0 0 0 2000px rgba(20,21,23,0.55); }
.hero-text { position: relative; display: inline-block; margin-bottom:12px; z-index:1; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size: clamp(28px,5vw,48px); margin-bottom:12px; color:var(--gold); }
.hero-text p { font-size: clamp(14px,2vw,18px); max-width:900px; color:#F5F5F3}

/* ðŸŸ¢ When paid, hero background changes */
.hero.paid {
  background: url('../asset/bg25.jpg') center/cover no-repeat;
}

/* ðŸŸ¢ Paid button style */
#payBtn.paid-state {
  background-color: #1faa59 !important;
  cursor: default;
  pointer-events: none;
}

/* MAIN CHECKOUT LAYOUT */
section.checkout { padding:56px 18px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0)); }
.checkout-inner {
  max-width:1100px;
  margin:0 auto;
  display:grid;
  grid-template-columns: 1fr 1.4fr;
  gap:28px;
  align-items:start;
}
@media (max-width:980px){
  .checkout-inner { grid-template-columns: 1fr; padding: 0 12px; }
  .hero { height: 30vh; }
}
.card {
  border-radius: 16px;
  background: var(--card-bg);
  padding:22px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 12px 30px rgba(0,0,0,0.55);
}
.checkout-form h2, .order-summary h2 { font-family:"Playfair Display", serif; color:#fff; margin-bottom:12px; font-size:22px; }
label { display:block; margin-bottom:6px; color:#e9e9e9; font-weight:600; }
input[type="text"], input[type="email"], input[type="tel"], textarea, select { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: transparent; color:#e9e9e9; font-family:inherit; margin-bottom:12px; }
textarea { min-height:120px; resize:vertical; }
.order-summary ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }
.order-item { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); transition: all var(--transition); }
.order-item .left { display:flex; gap:12px; align-items:center; flex:1; min-width:0; padding-left:0; }
.order-item img { width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,0.04); transition: all var(--transition); }
/* ensure names are left aligned */
.order-item .meta, .order-item .title { font-size:0.95rem; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; }
.order-item .title { font-weight:700; color:#fff; text-align:left; }
.order-item .price { font-weight:700; color:var(--gold); min-width:110px; text-align:right; }
.show-variants-btn { background: transparent; color:var(--muted); border: 1px solid rgba(255,255,255,0.04); border-radius: 8px; padding:6px 8px; cursor: pointer; font-weight:700; transition: all var(--transition); font-size:13px; margin-top:8px; }
.variants-container { display:none; flex-direction:column; gap:8px; margin-top:8px; padding-left:0; border-left:2px dashed rgba(255,255,255,0.03); }
.variants-container.show { display:flex; }
.variant-line { display:flex; justify-content:space-between; gap:12px; align-items:center; padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); color:var(--muted); font-size:0.95rem; }
.currency-selector { display:flex; justify-content:flex-end; gap:8px; align-items:center; margin-bottom:12px; }
.totals { margin-top:12px; text-align:right; font-weight:700; color:#fff; font-size:18px; }
.pay-btn { display:block; width:100%; margin-top:16px; padding:14px; border-radius:12px; background: linear-gradient(180deg, var(--gold), #a55a36); color:#fff; border:none; font-weight:800; cursor:pointer; transition: transform var(--transition); }
.pay-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.error-banner { display:none; margin-bottom:12px; padding:12px; border-radius:8px; background: linear-gradient(180deg, rgba(255,50,50,0.12), rgba(255,30,30,0.06)); color:#ffd6d6; border:1px solid rgba(255,30,30,0.12); }
/* backdrop covers only a tiny area around spinner */
/* floating backdrop (tiny, top-right) */
.spinner-backdrop { 
  display: none; 
  position: fixed; 
  top: 20px; 
  right: 20px; 
  z-index: 9999; 
  pointer-events: none; /* allow clicks through */
  display: flex; 
  align-items: center; 
  justify-content: center; 
}

/* spinner container */
.spinner { 
  display: flex; 
  gap: 6px; 
  padding: 6px; 
  background: rgba(0,0,0,0.6); 
  border-radius: 24px; 
  box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
  align-items: center; 
  justify-content: center; 
}

/* each dot */
.spinner .dot { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  background: var(--gold); 
  animation: bounce 1s infinite ease-in-out; 
}

/* stagger animation for 3 dots */
.spinner .dot:nth-child(1) { animation-delay: 0s; }
.spinner .dot:nth-child(2) { animation-delay: 0.2s; }
.spinner .dot:nth-child(3) { animation-delay: 0.4s; }

/* bounce keyframes */
@keyframes bounce { 
  0%, 80%, 100% { transform: scale(0.8); opacity: 0.6; } 
  40% { transform: scale(1.3); opacity: 1; } 
}

.note { font-size:0.95rem; color:var(--muted); margin-top:8px; }
footer { text-align:center; padding:22px; background:transparent; color:var(--muted); margin-top:36px; border-top:1px solid rgba(255,255,255,0.02); }
.order-item .left { display: flex; flex-direction: column; gap: 6px; min-width:0; }
.show-details-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.95rem; padding: 6px 0; text-align: left; }
.details-container { flex-direction: column; padding-left: 0; padding-right: 0; margin-bottom: 8px; border-left: 2px solid rgba(255,255,255,0.03); display: none; }
.details-container.show { display: flex; }
.details-container div { display: flex; justify-content: space-between; font-size: 0.95rem; color: #bbb; padding: 6px 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
@media (max-width:680px){
  .order-item img { width:48px; height:48px; }
  .brand-logo { height:48px; }
  .hero { height:40vh; }
  .checkout-inner { grid-template-columns:1fr; gap:20px; padding: 12px; }
  .order-item .meta { font-size:0.92rem; }
  .order-item .price { min-width:60px; font-size:0.95rem; }
  textarea { min-height:100px; }
}
@media (max-width:900px){
  .hamburger { display:block; }
  .header-right { display:none; position:absolute; top:64px; right:12px; background:rgba(20,20,20,0.98); flex-direction:column; padding:18px; gap:10px; border-radius:10px; width:220px; z-index:1100; border:1px solid rgba(255,255,255,0.03); }
  .header-right.open { display:flex; }
}

/* small helper */
.small-note { color:var(--muted); padding:8px; text-align:center; }
</style>

</head>
<body>

<header class="site-header" id="siteHeader">
  <div class="header-left">
    <img src="../asset/logo.png" alt="SÃ©rac Logo" class="brand-logo">
    <div class="brand-title">SÃ©rac</div>
  </div>
  <nav class="header-right" id="headerRight">
    <a href="../index.html">Home</a>
    <a href="../shop.html">Shop</a>
    <a href="../about.html">About</a>
    <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="../contact.html">Contact</a>
  </nav>
  <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
</header>

<!-- Hero -->
<section class="hero" id="heroSection" style="--hero-bg: url('../asset/bg25.jpg');">
  <div class="hero-text">
    <h1 id="heroH1">Checkout</h1>
    <p id="heroP">Complete your order â€” secure payment and quick processing</p>
  </div>
</section>

<section class="checkout">
  <div class="checkout-inner">
    <!-- left: billing form -->
    <div class="card checkout-form" id="checkoutCard">
      <h2>Billing Details</h2>

      <div class="error-banner" id="errorBanner"></div>

      <form id="checkoutForm" autocomplete="off">
        <label for="name">Full Name</label>
        <input id="name" name="fullname" type="text" placeholder="Jane Doe" required>

        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>

        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="tel" placeholder="+2348000000000" required>

        <label for="address">Address</label>
        <textarea id="address" name="address" placeholder="Street, City, Country" required></textarea>
      </form>
    </div>

    <!-- right: order summary -->
    <aside class="card order-summary" id="orderCard">
      <h2 id="orderCardTitle">Order Summary</h2>

      <div class="currency-selector" id="currencySelector" style="display:none">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>

      <ul id="orderItems" aria-live="polite"></ul>

      <div class="totals" id="totalsText">Subtotal: â€”</div>
      <div class="note" id="feesNote">Fees does not include shipping</div>

      <div class="note">You will be redirected to payment after clicking Proceed to Payment.</div>

      <button id="payBtn" class="pay-btn">Proceed to Payment</button>
    </aside>
  </div>
</section>

<footer>
  <p>Â© 2025 SÃ©rac</p>
</footer>


<!-- floating top-right 3-dot spinner -->
<div class="spinner-backdrop" id="spinnerBackdrop" role="status" aria-hidden="true">
  <div class="spinner" id="spinnerBox">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>
</div>

<!-- Flutterwave script -->
<script src="https://checkout.flutterwave.com/v3.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, serverTimestamp, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM refs ---------- */
const cartCountElem = document.getElementById('cartCount');
const orderItemsEl = document.getElementById('orderItems');
const totalsText = document.getElementById('totalsText');
const payBtn = document.getElementById('payBtn');
const currencySelect = document.getElementById('currency');
const spinnerBackdrop = document.getElementById('spinnerBackdrop');
const errorBanner = document.getElementById('errorBanner');

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');

const hero = document.getElementById('heroSection');
const heroH1 = document.getElementById('heroH1');
const heroP = document.getElementById('heroP');

/* ---------- Local storage keys & state ---------- */
const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

let cart = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let selectedCurrency = localStorage.getItem(CURRENCY_KEY) || 'NGN';
let quote = null;
let isPaidOrder = false;

/* ---------- Utilities ---------- */
function showSpinner(show=true){ if (!spinnerBackdrop) return; spinnerBackdrop.style.display = show ? 'flex' : 'none'; }
function showError(msg){ if(!errorBanner) { alert(msg || ''); return; } errorBanner.style.display = msg ? 'block' : 'none'; errorBanner.textContent = msg || ''; }
function formatPrice(value, currency){ return new Intl.NumberFormat('en-US', { style:'currency', currency, minimumFractionDigits: currency==='NGN'?0:2 }).format(Number(value||0)); }
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

/* ---------- Firestore product fetch ---------- */
const productCache = {};
async function fetchProductData(productId){
  if(productCache[productId]) return productCache[productId];
  const snap = await getDoc(doc(db, "brands","serac","products",productId));
  if(snap.exists()){ productCache[productId]=snap.data(); return snap.data(); }
  return null;
}

/* ---------- Cart merge & quote build ---------- */
function mergeCartItems(cartArray){ const merged=[]; cartArray.forEach(item=>{ const idx=merged.findIndex(i=>i.id===item.id && (i.color||'')=== (item.color||'') && (i.size||'')=== (item.size||'')); if(idx===-1) merged.push({...item}); else merged[idx].quantity += Number(item.quantity||0); }); return merged; }

async function buildQuoteFromCart(){
  cart = mergeCartItems(cart);
  const items = [];
  const grouped = new Map();
  cart.forEach(c=>{ if(!grouped.has(c.id)) grouped.set(c.id,[]); grouped.get(c.id).push(c); });
  for(const [pid, rows] of grouped){
    const pd = await fetchProductData(pid);
    const variants = rows.map(r=>{
      const qty = Number(r.quantity||0);
      const unitPrices = {
        NGN: pd?.priceNGN||r.price||0,
        USD: pd?.priceUSD||0,
        EUR: pd?.priceEUR||0,
        GBP: pd?.priceGBP||0
      };
      return { id:r.id, color:r.color||'', size:r.size||'', quantity:qty, unitPrices, linePrices:{
        NGN:unitPrices.NGN*qty, USD:unitPrices.USD*qty, EUR:unitPrices.EUR*qty, GBP:unitPrices.GBP*qty
      }};
    });
    const totalPrices={NGN:0,USD:0,EUR:0,GBP:0};
    variants.forEach(v=>{ Object.keys(totalPrices).forEach(k=>totalPrices[k]+=v.linePrices[k]||0); });
    items.push({ productId: pid, name: pd?.name||rows[0].name||'Product', image: pd?.images?.[0]||pd?.imageUrl||null, totalQuantity: variants.reduce((s,a)=>s+a.quantity,0), totalPrices, variants, description: pd?.description||'' });
  }
  return { items };
}

/* ---------- Render ---------- */
function renderOrder(quoteData, currency='NGN', paid=false){
  orderItemsEl.innerHTML='';
  if(!quoteData || !Array.isArray(quoteData.items) || !quoteData.items.length){ orderItemsEl.innerHTML='<li>No items</li>'; totalsText.textContent=`Subtotal: â€”`; return; }
  let subtotal=0;
  quoteData.items.forEach((item, idx)=>{
    const value=item.totalPrices[currency]||0; subtotal+=value;
    const li=document.createElement('li'); li.className='order-item';
    const imgHtml=item.image?`<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}">`:'';
    li.innerHTML=`<div class="left">${imgHtml}<div><div class="title">${escapeHtml(item.name)}</div><div>${item.totalQuantity} item(s)</div></div></div><div>${formatPrice(value,currency)}</div>`;
    orderItemsEl.appendChild(li);
  });
  totalsText.textContent=`Subtotal: ${formatPrice(subtotal,currency)}`;
  try{ cartCountElem.textContent=quoteData.items.reduce((s,a)=>s+a.totalQuantity,0); }catch(e){}
}

/* ---------- Process order once paid ---------- */
async function processPaidOrder(orderData){
  try{
    const orderRef=await addDoc(collection(db,"brands","serac","orders"),{...orderData, status:"paid", createdAt: serverTimestamp(), verifiedAt: serverTimestamp()});
    // update linked quote if any
    try{ if(orderData.source?.startsWith("quote:")){ const qid=orderData.source.split("quote:")[1]; if(qid) await updateDoc(doc(db,"brands","serac","quotes",qid), { status:"Paid", orderId: orderRef.id, paidAt: serverTimestamp() }); } }catch(e){}
    return orderRef.id;
  }catch(e){ console.error("Failed saving paid order:", e); return null; }
}

/* ---------- Checkout / Flutterwave flow ---------- */
const FLW_PUBLIC_KEY="FLWPUBK_TEST-07eb9d2da345c08dc4d54278c3bc86f7-X";

async function initiatePaymentFlow(ev){
  if(ev?.preventDefault) ev.preventDefault();
  if(isPaidOrder) return;

  showError('');
  const name=nameInput.value.trim(), email=emailInput.value.trim(), phone=phoneInput.value.trim(), address=addressInput.value.trim();
  if(!name||!email||!phone||!address){ showError("All fields required"); return; }
  if(!quote || !quote.items?.length){ showError("Cart empty"); return; }

  let subtotal=0; quote.items.forEach(it=>subtotal+=(it.totalPrices[selectedCurrency]||0));
  if(subtotal<=0){ showError("Subtotal is zero"); return; }

  const baseOrder={ name,email,phone,address, currency:selectedCurrency, items:quote.items, total:subtotal, status:"placed", source:"cart", createdAt:new Date().toISOString() };

  const txRef="serac_"+Date.now();

  // Flutterwave config
  const fwConfig={
    public_key: FLW_PUBLIC_KEY,
    tx_ref: txRef,
    amount:Number(subtotal),
    currency:selectedCurrency,
    customer:{email,phonenumber:phone,name},
    customizations:{title:"SÃ©rac",description:"Order Payment",logo:"https://brandisby.com/assets/logo.png"},
    is_sandbox:true,
    callback:function(data){
      showSpinner(true);
      console.log("Flutterwave success callback:",data);
      showError("Payment received. Waiting for verification via webhook...");
      // OPTIONAL: real-time listener on Firestore to update UI when webhook writes paid order
      const ordersRef=collection(db,"brands","serac","orders");
      const q=query(ordersRef, where("tx_ref","==",txRef));
      const unsub=onSnapshot(q,(snap)=>{
        snap.docChanges().forEach(change=>{
          if(change.type==="added" || change.type==="modified"){
            const paidOrder=change.doc.data();
            if(paidOrder.status==="paid"){
              processPaidOrder(baseOrder); // save again if needed
              quote={items:paidOrder.items}; isPaidOrder=true;
              renderOrder(quote, selectedCurrency,true);
              if(hero){hero.classList.add('paid');} if(heroH1)heroH1.textContent="Order Summary"; if(heroP)heroP.textContent="Paid successfully"; if(payBtn){payBtn.textContent="Paid âœ…";payBtn.disabled=true;}
              unsub(); // stop listening
              try{localStorage.removeItem(STORAGE_KEY); cartCountElem.textContent='0';}catch(e){}
            }
          }
        });
      });
    },
    onclose:function(){ showError("Payment window closed"); showSpinner(false);}
  };

  try{ FlutterwaveCheckout(fwConfig); }catch(err){ console.error(err); showError("Payment gateway unavailable"); }
}

/* ---------- Currency switch ---------- */
if(currencySelect) currencySelect.addEventListener('change',()=>{ selectedCurrency=currencySelect.value; localStorage.setItem(CURRENCY_KEY,selectedCurrency); if(quote) renderOrder(quote,selectedCurrency,isPaidOrder); });

/* ---------- Pay button binding ---------- */
if(payBtn) payBtn.addEventListener('click', initiatePaymentFlow);

/* ---------- Init ---------- */
(async function init(){
  cart = mergeCartItems(cart);
  quote = await buildQuoteFromCart();
  renderOrder(quote,selectedCurrency,false);
})();
</script>


</body>
</html>

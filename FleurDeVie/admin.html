<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleur De Vie Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family: "Montserrat", sans-serif; background:#F5E6CC; color:#112e1f; line-height:1.6; }
    a { text-decoration:none; color:inherit; }

    header { background:#112e1f; color:#FFD6BA; padding:16px; text-align:center; font-family:"Playfair Display", serif; font-size:24px; font-weight:700; }

    .container { max-width:1000px; margin:2rem auto; padding:2rem; background:#FFD6BA; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }

    h2 { font-family:"Playfair Display", serif; margin-bottom:16px; color:#112e1f; }

    label { display:block; margin-top:1rem; font-weight:500; }
    input, textarea, select { width:100%; padding:0.6rem; margin-top:0.5rem; border:1px solid #112e1f; border-radius:6px; font-size:1rem; }

    button { margin-top:1rem; padding:0.75rem 1.2rem; background:#112e1f; color:#FFD6BA; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:0.3s; }
    button:hover { background:#0a1d14; }

    .message { margin-top:1rem; font-weight:500; font-size:1rem; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:1.5rem; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { padding:0.75rem; border-bottom:1px solid #ddd; text-align:left; font-size:0.95rem; }
    th { background:#F5E6CC; font-family:"Playfair Display", serif; color:#112e1f; }
    td img { width:60px; border-radius:6px; }

    .actions button { margin-right:0.5rem; padding:0.4rem 0.6rem; font-size:0.9rem; }
    .actions button:hover { opacity:0.85; }

    /* Dashboard Navigation */
    .dashboard-nav { display:flex; gap:10px; margin-bottom:1.5rem; }
    .dashboard-nav button { flex:1; }
    .section { display:none; margin-top:1rem; }
    .section.active { display:block; }

    @media(max-width:600px){
      .container { padding:1rem; }
      table, th, td { font-size:0.85rem; }
      th, td { padding:0.5rem; }
      .dashboard-nav { flex-direction:column; }
    }
  </style>
</head>
<body>

  <header>Fleur De Vie Admin Dashboard</header>

  <!-- LOGIN FORM -->
  <div class="container" id="loginContainer">
    <h2>Admin Login</h2>
    <form id="loginForm">
      <label for="loginEmail">Email</label>
      <input type="email" id="loginEmail" required>

      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" required>

      <button type="submit">Login</button>
      <div class="message" id="loginMessage"></div>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div class="container" id="dashboardContainer" style="display:none;">
    <div class="dashboard-nav">
      <button type="button" data-target="productsSection">📦 Products</button>
      <button type="button" data-target="quotesSection">💳 Quotes</button>
      <button type="button" data-target="ordersSection">🧾 Orders</button>
    </div>

    <!-- PRODUCTS -->
    <div class="section" id="productsSection">
      <h2>Manage Products</h2>
      <form id="productForm">
        <input type="hidden" id="productId">
        <label>Product Name</label><input type="text" id="name" required>
        <label>Description</label><textarea id="description" required></textarea>
        <label>Price (NGN)</label><input type="number" id="price" step="0.01" required>
        <label>Image URL</label><input type="url" id="imageUrl" required>
        <label>Published</label>
        <select id="published"><option value="true">Yes</option><option value="false">No</option></select>
        <button type="submit">Save Product</button>
        <div class="message" id="message"></div>
      </form>

      <h2>All Products</h2>
      <table><thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Description</th><th>Published</th><th>Actions</th></tr></thead>
      <tbody id="productsBody"></tbody></table>
    </div>

    <!-- QUOTES -->
    <div class="section" id="quotesSection">
      <h2>Generate Quote</h2>
      <form id="quoteForm">
        <label>Customer Name</label><input type="text" id="customerName" required>
        <label>Customer Email</label><input type="email" id="customerEmail" required>

        <h3>Items</h3>
        <table id="quoteItems"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
        <button type="button" onclick="addQuoteItem()">Add Item</button>

        <h3>Total: ₦<span id="quoteTotal">0</span></h3>
        <button type="submit">Generate Quote</button>
        <div class="message" id="quoteMessage"></div>
      </form>

      <h2>All Quotes</h2>
      <table><thead><tr><th>Customer</th><th>Email</th><th>Items</th><th>Total</th><th>Date</th></tr></thead>
      <tbody id="quotesBody"></tbody></table>
    </div>

    <!-- ORDERS -->
    <div class="section" id="ordersSection">
      <h2>Orders</h2>
      <button onclick="exportOrders()">⬇ Export Orders (CSV)</button>
      <table><thead><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Date</th></tr></thead>
      <tbody id="ordersBody"></tbody></table>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // --- Use your real firebase config here (this matches the project keys you posted earlier) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
      authDomain: "brandisby.firebaseapp.com",
      projectId: "brandisby",
      storageBucket: "brandisby.firebasestorage.app",
      messagingSenderId: "87213267039",
      appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // allowed admins - normalized to avoid case/whitespace mismatches
    const allowedAdmins = ["yourstruly.fleurdevie@gmail.com"].map(e => e.toLowerCase().trim());

    // DOM refs
    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");
    const loginContainer = document.getElementById("loginContainer");
    const dashboardContainer = document.getElementById("dashboardContainer");

    // LOGIN - use element values directly, then check normalized user email
    loginForm.addEventListener("submit", async e => {
      e.preventDefault();
      const rawEmail = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      loginMessage.textContent = "";
      try {
        console.log("Attempting sign-in for:", rawEmail);
        const userCredential = await signInWithEmailAndPassword(auth, rawEmail, password);
        const user = userCredential.user;
        console.log("Firebase returned user:", user && user.email);
        const normalized = (user.email || "").toLowerCase().trim();
        if (allowedAdmins.includes(normalized)) {
          loginMessage.textContent = "✅ Login successful!";
          loginMessage.style.color = "green";
          loginContainer.style.display = "none";
          dashboardContainer.style.display = "block";
          showSection("productsSection");
          loadProducts();
          loadQuotes();
          loadOrders();
        } else {
          loginMessage.textContent = "❌ Not authorized.";
          loginMessage.style.color = "red";
          await signOut(auth);
        }
      } catch (err) {
        console.error("Login error:", err);
        loginMessage.textContent = `❌ ${err.code || ""}: ${err.message || err}`;
        loginMessage.style.color = "red";
      }
    });

    // Listen for auth state (page reloads, existing session)
    onAuthStateChanged(auth, user => {
      try {
        if (user) console.log("onAuthStateChanged -> user:", user.email);
        if (user && allowedAdmins.includes((user.email || "").toLowerCase().trim())) {
          loginContainer.style.display = "none";
          dashboardContainer.style.display = "block";
          showSection("productsSection");
          loadProducts();
          loadQuotes();
          loadOrders();
        } else {
          loginContainer.style.display = "block";
          dashboardContainer.style.display = "none";
        }
      } catch (e) {
        console.error("onAuthStateChanged error:", e);
        loginContainer.style.display = "block";
        dashboardContainer.style.display = "none";
      }
    });

    // nav buttons
    document.querySelectorAll(".dashboard-nav button").forEach(btn=>{
      btn.addEventListener("click", ()=> showSection(btn.dataset.target));
    });
    function showSection(id){
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // === PRODUCTS CRUD ===
    const productForm = document.getElementById('productForm');
    const message = document.getElementById('message');
    const productsBody = document.getElementById('productsBody');
    const productIdInput = document.getElementById('productId');

    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = productIdInput.value;
      const product = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: parseFloat(document.getElementById('price').value),
        imageUrl: document.getElementById('imageUrl').value,
        published: document.getElementById('published').value === "true",
        updatedAt: serverTimestamp()
      };

      try {
        if (id) {
          await updateDoc(doc(db, "brands", "fleurdevie", "products", id), product);
          message.textContent = "✅ Product updated!";
        } else {
          product.createdAt = serverTimestamp();
          await addDoc(collection(db, "brands", "fleurdevie", "products"), product);
          message.textContent = "✅ Product added!";
        }
        message.style.color = "green";
        productForm.reset();
        productIdInput.value = "";
      } catch (err) {
        console.error("Product save error:", err);
        message.textContent = "❌ Error saving product.";
        message.style.color = "red";
      }
    });

    async function loadProducts() {
      const productsCol = collection(db, "brands", "fleurdevie", "products");
      const q = query(productsCol, orderBy("createdAt", "desc"));
      onSnapshot(q, snapshot => {
        productsBody.innerHTML = "";
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><img src="${p.imageUrl}" alt="${p.name}"></td>
            <td>${p.name}</td>
            <td>₦${p.price?.toFixed(2) ?? p.price}</td>
            <td>${p.description}</td>
            <td>${p.published ? "Yes" : "No"}</td>
            <td class="actions">
              <button onclick="editProduct('${docSnap.id}', ${JSON.stringify(p.name)}, ${JSON.stringify(p.description)}, ${p.price}, ${JSON.stringify(p.imageUrl)}, ${p.published})">Edit</button>
              <button onclick="deleteProduct('${docSnap.id}')">Delete</button>
            </td>
          `;
          productsBody.appendChild(tr);
        });
      });
    }

    window.editProduct = (id, name, description, price, imageUrl, published) => {
      productIdInput.value = id;
      document.getElementById('name').value = name;
      document.getElementById('description').value = description;
      document.getElementById('price').value = price;
      document.getElementById('imageUrl').value = imageUrl;
      document.getElementById('published').value = published ? "true" : "false";
      message.textContent = "✏️ Editing product...";
      message.style.color = "blue";
    };

    window.deleteProduct = async (id) => {
      if (confirm("Are you sure you want to delete this product?")) {
        await deleteDoc(doc(db, "brands", "fleurdevie", "products", id));
      }
    };

    // === QUOTES ===
    function addQuoteItem(){
      const row = document.createElement("tr");
      row.innerHTML = `<td><input type="text" placeholder="Item name"></td>
        <td><input type="number" value="1" min="1" onchange="updateQuoteTotal()"></td>
        <td><input type="number" value="0" min="0" onchange="updateQuoteTotal()"></td>
        <td class="subtotal">0</td>
        <td><button type="button" onclick="this.closest('tr').remove();updateQuoteTotal()">x</button></td>`;
      document.querySelector("#quoteItems tbody").appendChild(row);
    }
    window.addQuoteItem = addQuoteItem;

    function updateQuoteTotal(){
      let t = 0;
      document.querySelectorAll("#quoteItems tbody tr").forEach(r=>{
        const q = +r.children[1].children[0].value || 0;
        const p = +r.children[2].children[0].value || 0;
        const s = q * p;
        r.querySelector(".subtotal").textContent = s;
        t += s;
      });
      document.getElementById("quoteTotal").textContent = t;
    }
    window.updateQuoteTotal = updateQuoteTotal;

    const quoteForm = document.getElementById("quoteForm");
    const quoteMessage = document.getElementById("quoteMessage");
    const quotesBody = document.getElementById("quotesBody");

    quoteForm.addEventListener("submit", async e => {
      e.preventDefault();
      const items = [...document.querySelectorAll("#quoteItems tbody tr")].map(r => ({
        name: r.children[0].children[0].value,
        qty: +r.children[1].children[0].value,
        price: +r.children[2].children[0].value
      }));
      const total = items.reduce((s,i)=>s + (i.qty * i.price), 0);
      try {
        await addDoc(collection(db, "brands", "fleurdevie", "quotes"), {
          customerName: document.getElementById("customerName").value,
          customerEmail: document.getElementById("customerEmail").value,
          items,
          total,
          createdAt: serverTimestamp()
        });
        quoteForm.reset();
        document.querySelector("#quoteItems tbody").innerHTML = "";
        document.getElementById("quoteTotal").textContent = "0";
        quoteMessage.textContent = "✅ Quote generated!";
        quoteMessage.style.color = "green";
      } catch (err) {
        console.error("Quote save error:", err);
        quoteMessage.textContent = "❌ Error generating quote.";
        quoteMessage.style.color = "red";
      }
    });

    function loadQuotes(){
      onSnapshot(query(collection(db, "brands", "fleurdevie", "quotes"), orderBy("createdAt", "desc")), snapshot=>{
        quotesBody.innerHTML = "";
        snapshot.forEach(docSnap=>{
          const qd = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${qd.customerName}</td>
            <td>${qd.customerEmail}</td>
            <td>${(qd.items||[]).map(i=>`${i.name} x${i.qty}`).join(", ")}</td>
            <td>₦${(qd.total || 0).toFixed ? qd.total.toFixed(2) : qd.total}</td>
            <td>${qd.createdAt?.toDate?.().toLocaleString?.() || ""}</td>
          `;
          quotesBody.appendChild(tr);
        });
      });
    }

    // === ORDERS ===
    const ordersBody = document.getElementById("ordersBody");
    function loadOrders(){
      onSnapshot(query(collection(db, "brands", "fleurdevie", "orders"), orderBy("createdAt", "desc")), snap=>{
        ordersBody.innerHTML = "";
        snap.forEach(d=>{
          const o = d.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d.id}</td><td>${o.customerName || o.customer || "-"}</td><td>${(o.items||[]).map(i=>i.name+" x"+i.qty).join(", ")}</td><td>₦${(o.total||0)}</td><td>${o.status||"Pending"}</td><td>${o.createdAt?.toDate?.().toLocaleString?.() || ""}</td>`;
          // also attach data-items for CSV export
          tr.setAttribute("data-items", JSON.stringify(o.items || []));
          tr.setAttribute("data-customer", o.customerName || o.customer || "");
          tr.setAttribute("data-total", o.total || 0);
          tr.setAttribute("data-status", o.status || "Pending");
          ordersBody.appendChild(tr);
        });
      });
    }

    window.exportOrders = function(){
      const rows = [];
      rows.push(["Order ID","Customer","Product","Qty","Price","Subtotal","Order Total","Status","Date"].join(","));
      document.querySelectorAll("#ordersBody tr").forEach(tr=>{
        const orderId = tr.children[0].innerText;
        const customer = tr.getAttribute("data-customer") || tr.children[1].innerText;
        const total = tr.getAttribute("data-total") || tr.children[3].innerText.replace(/₦/g,"");
        const status = tr.getAttribute("data-status") || tr.children[4].innerText;
        const items = JSON.parse(tr.getAttribute("data-items") || "[]");
        if(items.length){
          items.forEach(item=>{
            rows.push([orderId, `"${customer}"`, `"${item.name}"`, item.qty, item.price, item.qty * item.price, total, status, ""].join(","));
          });
        } else {
          rows.push([orderId, `"${customer}"`, "-", "-", "-", "-", total, status, ""].join(","));
        }
      });
      const csv = "data:text/csv;charset=utf-8," + rows.join("\n");
      const link = document.createElement("a");
      link.href = encodeURI(csv);
      link.download = "orders.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // Initialize small UI: show product section button behavior
    document.querySelectorAll(".dashboard-nav button").forEach(btn=>btn.addEventListener("click", ()=>showSection(btn.dataset.target)));
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sérac - Product</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg-dark:#141517;
      --bg-mid:#2A2B30;
      --gold:#B66E41;
      --muted:#bdbdbd;
      --accent-strong:rgba(182,110,65,0.95);
      --radius:12px;
      --transition:0.25s cubic-bezier(.2,.9,.2,1);
    }

    /* RESET */
    *{ box-sizing:border-box; margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    body{ font-family:"Montserrat",sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; }
    a { text-decoration:none; color:inherit; transition:color var(--transition); }

    /* HEADER */
    .site-header{ background:transparent; transition: background 0.3s, border-bottom 0.3s, top 0.3s; display:flex; justify-content:space-between; align-items:center; padding:16px 28px; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.04); color:#f5f5f5; }
    .site-header.scrolled{ background:var(--bg-dark); border-bottom:1px solid rgba(255,255,255,0.06); }
    .header-left{ display:flex; align-items:center; gap:14px; }
    .brand-logo{ height:56px; width:auto; object-fit:contain; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
    .brand-title{ font-family:"Playfair Display",serif; font-size:22px; font-weight:700; color:var(--gold); }

    .header-right{ display:flex; gap:22px; align-items:left; }
    .header-right a{ color:#f5f5f3; position:relative; padding:6px 0; font-size:1rem; font-weight:500; }
    .header-right a::after{ content:""; position:absolute; bottom:-4px; left:0; width:0; height:2px; background:var(--gold); transition:width 0.3s; }
    .header-right a:hover{ color:var(--gold); }
    .header-right a:hover::after{ width:100%; }
    .cart-count{ background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

    /* HAMBURGER */
    .hamburger{ display:none; background:none; border:none; cursor:pointer; width:22px; height:16px; position:relative; }
    .hamburger span{ display:block; width:100%; height:2px; background:#b66e41; border-radius:2px; position:absolute; left:0; transition:0.3s; }
    .hamburger span:nth-child(1){ top:0; } .hamburger span:nth-child(2){ top:7px; } .hamburger span:nth-child(3){ top:14px; }
    .hamburger.open span:nth-child(1){ transform:rotate(45deg); top:7px; } .hamburger.open span:nth-child(2){ opacity:0; } .hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:7px; }

    /* MAIN */
    main{ padding:24px; max-width:1100px; margin:140px auto 60px; display:flex; gap:40px; justify-content:center; align-items:flex-start; flex-wrap:wrap; }

    /* IMAGE */
    .product-image{ flex:1 1 400px; max-width:480px; display:flex; flex-direction:column; gap:14px; }
    .product-image img{ width:100%; border-radius:var(--radius); object-fit:cover; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 10px 30px rgba(2,2,2,0.7), inset 0 -2px 6px rgba(0,0,0,0.4); transition:transform var(--transition), box-shadow var(--transition); cursor:pointer; }
    .product-image img:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 18px 42px rgba(0,0,0,0.7); }
    .thumbnail-container{ display:flex; gap:10px; overflow-x:auto; scroll-behavior:smooth; padding-bottom:6px; }
    .thumbnail-container img{ width:70px; height:70px; border-radius:8px; object-fit:cover; border:2px solid transparent; cursor:pointer; transition:transform 0.3s, border-color 0.3s; }
    .thumbnail-container img.selected{ border-color:var(--accent-strong); box-shadow:0 6px 18px rgba(182,110,65,0.12); }

    /* DETAILS */
    .product-details{ flex:1 1 400px; max-width:520px; display:flex; flex-direction:column; gap:12px; }
    .product-details h1{ font-family:"Playfair Display",serif; font-size:28px; color:#fff; }
    .product-details .description{ font-size:15px; color:var(--muted); }
    .product-details .price{ font-weight:700; font-size:20px; color:#fff; margin-bottom:6px; }

    /* OPTIONS */
    .option-group{ margin-top:10px; }
    .option-group h4{ font-size:14px; color:var(--gold); margin-bottom:6px; font-weight:600; letter-spacing:0.3px; }
    .options-container{ display:flex; gap:8px; flex-wrap:wrap; }
    .options-container button{ padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--muted); cursor:pointer; font-weight:500; transition:all var(--transition); text-align:center; position:relative; }
    .options-container button:hover{ color:#fff; border-color:var(--gold); }
    .options-container button.selected{ background:rgba(182,110,65,0.12); color:#fff; border-color:var(--accent-strong); }

    /* QUANTITY */
    .quantity-controls{ display:flex; align-items:center; gap:10px; }
    .quantity-controls button{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; transition:background var(--transition), transform var(--transition); text-align:center; }
    .quantity-controls button:hover{ background:rgba(255,255,255,0.05); transform:translateY(-2px); }
    .quantity-badge{ font-weight:700; min-width:36px; text-align:center; color:var(--muted); }

    /* BUTTONS - smaller padding & centered text (applies to all sizes) */
    .add-cart, .customize-btn, .back-btn{
      display:flex;
      justify-content:center;
      align-items:center;
      text-align:center;
      padding:6px 10px;
      font-size:0.95rem;
      border-radius:10px;
    }
    .add-cart{ background:linear-gradient(90deg, var(--accent-strong), #a85a35); color:#111; border:none; cursor:pointer; font-weight:600; transition:transform var(--transition), box-shadow var(--transition); box-shadow:0 8px 26px rgba(182,110,65,0.12); }
    .add-cart:hover{ transform:translateY(-3px); }
    .customize-btn{ background:transparent; color:var(--accent-strong); border:1px dashed rgba(182,110,65,0.22); font-weight:700; transition: background var(--transition), color var(--transition); }
    .customize-btn:hover{ background: rgba(182,110,65,0.06); color:#fff; }
    .back-btn{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); font-weight:600; transition:all var(--transition); }
    .back-btn:hover{ color:#fff; }
    .buttons-row{ display:flex; gap:12px; margin-top:10px; }

    /* DETAILS (from Firestore) */
    .product-extra-details{ margin-top:18px; color:var(--muted); font-size:15px; line-height:1.7; white-space:pre-line; }
    .product-extra-details ul{ margin-left:20px; list-style:disc; }
    .product-extra-details li{ margin-bottom:6px; }

    /* variant badge styles */
    .variant-badge{ position:absolute; top:4px; right:6px; background:var(--gold); color:#fff; font-size:0.65rem; border-radius:50%; min-width:16px; height:16px; display:flex; align-items:center; justify-content:center; font-weight:600; box-shadow:0 0 3px rgba(0,0,0,0.4); pointer-events:none; }
    /* when a size is active and some colors exist for it */
    .options-container button.has-combo{ box-shadow:0 8px 20px rgba(182,110,65,0.12); }
    .options-container button.combo-active{ background:rgba(182,110,65,0.14); border-color:var(--gold); color:#fff; }

    /* MODAL */
    #optionModal{ display:none; position:fixed; inset:0; background: rgba(20,21,23,0.95); justify-content:center; align-items:center; z-index:2000; }
    #optionModal .modal-content{ background:var(--bg-mid); padding:28px 22px; border-radius:14px; max-width:380px; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,0.8); }
    #optionModal .modal-content p{ font-size:1rem; color:#fff; margin-bottom:18px; }
    #optionModal .modal-content button{ padding:10px 20px; border:none; border-radius:10px; background:var(--gold); color:var(--bg-dark); cursor:pointer; font-weight:700; transition: all 0.2s; }
    #optionModal .modal-content button:hover{ transform:translateY(-2px); }

    /* RESPONSIVE */
    @media (max-width:900px){
      main{ flex-direction:column; align-items:center; padding:20px; margin-top:120px; gap:30px; }
      .product-image, .product-details{ max-width:100%; width:100%; }
      .product-image img{ max-height:420px; object-fit:contain; }
      .product-details{ text-align:left; padding:0 10px; }
      .buttons-row{ flex-direction:column; width:100%; }
      .add-cart, .customize-btn, .back-btn{ width:100%; }
      .header-right{ display:none; flex-direction:column; background:rgba(20,21,23,0.98); position:absolute; top:70px; right:0; width:220px; padding:18px; border-radius:8px; z-index:1100; }
      .header-right.open{ display:flex; }
      .hamburger{ display:block; }
    }

    /* ensure any prior mobile sticky leftover hidden */
    .mobile-actions{ display:none !important; }
  </style>
</head>
<body>

  <header class="site-header">
    <div class="header-left">
      <img src="asset/logo.png" alt="Sérac Logo" class="brand-logo">
      <div class="brand-title">Sérac</div>
    </div>

    <nav class="header-right">
      <a href="index.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="about.html">About</a>
      <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
      <a href="customization.html">Customize</a>
      <a href="contact.html">Contact</a>
      <a href="trackorder.html">Track</a>
    </nav>

    <button class="hamburger" id="hamburger" aria-expanded="false"><span></span><span></span><span></span></button>
  </header>

  <!-- Note: visibility:hidden initially to avoid the flash. It's made visible after DOM is filled. -->
  <main id="productContainer" style="visibility:hidden;">
    <div class="product-image">
      <img id="productImg" src="" alt="Product Image" />
      <div class="thumbnail-container" id="thumbnailContainer"></div>
    </div>

    <div class="product-details">
      <h1 id="productName"></h1>
      <div class="description" id="productDescription"></div>
      <div class="price" id="productPrice"></div>

      <!-- Variant groups (separated) -->
      <!-- size first is recommended; if you keep color first visually it will still treat size as parent when present -->
      <div class="option-group" id="sizeGroup" style="display:none;">
        <h4>Sizes</h4>
        <div class="options-container" id="sizeOptions"></div>
      </div>

      <div class="option-group" id="colorGroup" style="display:none;">
        <h4>Colors</h4>
        <div class="options-container" id="colorOptions"></div>
      </div>

      <div class="quantity-controls" style="margin-top:8px;">
        <button id="minus">-</button>
        <span class="quantity-badge" id="quantityBadge">0</span>
        <button id="plus">+</button>
      </div>

      <button class="add-cart" id="addCartBtn">Add to Cart</button>
      <a href="customization.html" id="customizeBtn" class="customize-btn" style="display:none; margin-top:8px;">Customize Product</a>

      <div class="buttons-row" style="margin-bottom:12px;">
        <a href="shop.html" class="back-btn" id="backBtnDesktop">Back to Shop</a>
      </div>

      <!-- Firestore details: rendered only when present; supports basic formatting -->
      <div id="productDetailsSection" class="product-extra-details" style="display:none;"></div>
    </div>
  </main>

  <!-- Option modal -->
  <div id="optionModal">
    <div class="modal-content">
      <p>Please select relevant options before adding to cart.</p>
      <button id="closeModalBtn">Okay</button>
    </div>
  </div>

  <footer style="text-align:center; padding:28px 14px; color:var(--muted); margin-top:40px; border-top:1px solid rgba(255,255,255,0.03);">
    <p>© 2025 Sérac</p>
  </footer>

<script type="module">
  // ---------- FIREBASE INIT ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
    authDomain:"brandisby.firebaseapp.com",
    projectId:"brandisby",
    storageBucket:"brandisby.firebasestorage.app",
    messagingSenderId:"87213267039",
    appId:"1:87213267039:web:339e9fd49e3ad31f7423ea"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM REFS ----------
  const productContainer = document.getElementById('productContainer');
  const productImg = document.getElementById('productImg');
  const productName = document.getElementById('productName');
  const productDescription = document.getElementById('productDescription');
  const productPrice = document.getElementById('productPrice');
  const quantityBadge = document.getElementById('quantityBadge');
  const addCartBtn = document.getElementById('addCartBtn');
  const minusBtn = document.getElementById('minus');
  const plusBtn = document.getElementById('plus');
  const cartCountElem = document.getElementById('cartCount');
  const customizeBtn = document.getElementById('customizeBtn');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const colorOptions = document.getElementById('colorOptions');
  const sizeOptions = document.getElementById('sizeOptions');
  const colorGroup = document.getElementById('colorGroup');
  const sizeGroup = document.getElementById('sizeGroup');
  const headerEl = document.querySelector('.site-header');
  const hamburger = document.getElementById('hamburger');
  const headerRight = document.querySelector('.header-right');
  const optionModal = document.getElementById('optionModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const detailsSection = document.getElementById('productDetailsSection');

  const STORAGE_KEY = 'seracCart';

  // ---------- CART ----------
  function getCart(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  function setCart(cart){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); updateCartCount(); }
  function updateCartCount(){ if(cartCountElem) cartCountElem.textContent = getCart().reduce((sum,i)=>sum + Number(i.quantity||0), 0); }
  function updateQuantityUI(productId){
    const total = getCart().filter(i=>i.id === productId).reduce((sum,i)=>sum + Number(i.quantity||0), 0);
    if(quantityBadge) quantityBadge.textContent = total;
    if(addCartBtn) addCartBtn.style.display = total > 0 ? 'none' : 'flex';
  }

  // ---------- CORE: add/remove per combination ----------
  // Add one to a specific combination (size + color) or base product
  function addToCart(product){
    let cart = getCart();
    const index = cart.findIndex(i => i.id === product.id && (i.color||'') === (product.color||'') && (i.size||'') === (product.size||''));
    if(index > -1){
      cart[index].quantity = (Number(cart[index].quantity)||0) + 1;
    } else {
      cart.push({...product, quantity:1});
    }
    setCart(cart);
    updateQuantityUI(product.id);
  }

  // Remove one from a specific combination; if no selection provided, handle gracefully
  function removeFromCartSpecific(productId, color = '', size = ''){
    let cart = getCart();
    // find exact match
    const idx = cart.findIndex(i => i.id === productId && (i.color||'') === (color||'') && (i.size||'') === (size||''));
    if(idx > -1){
      cart[idx].quantity = (Number(cart[idx].quantity)||0) - 1;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      setCart(cart);
      updateQuantityUI(productId);
      return true;
    }
    return false;
  }

  // Remove from the most recent combo for this product (fallback when user hasn't selected a variant)
  function removeFromCartFallback(productId){
    let cart = getCart();
    // find last item (most recently added) with this productId
    for(let i = cart.length - 1; i >= 0; i--){
      if(cart[i].id === productId){
        cart[i].quantity = (Number(cart[i].quantity)||0) - 1;
        if(cart[i].quantity <= 0) cart.splice(i,1);
        setCart(cart);
        updateQuantityUI(productId);
        return true;
      }
    }
    return false;
  }

  // Clear all combos for this product
  function clearProductCombos(productId){
    let cart = getCart();
    cart = cart.filter(i => i.id !== productId);
    setCart(cart);
    updateQuantityUI(productId);
  }

  // ---------- SELECTION HELPERS ----------
  function getSelectedOptions(){
    return {
      color: colorOptions?.querySelector('.selected')?.textContent?.trim() || '',
      size: sizeOptions?.querySelector('.selected')?.textContent?.trim() || ''
    };
  }

  // validateSelection used only for Add / plus (not for minus)
  function validateSelectionForAdd(){
    const sel = getSelectedOptions();
    if((sizeOptions?.children.length && !sel.size) || (colorOptions?.children.length && !sel.color)){
      if(optionModal) optionModal.style.display = 'flex';
      return false;
    }
    return true;
  }

  // ---------- SANITIZE (escape) ----------
  function escapeHtml(str){
    return String(str||'')
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // ---------- DETAILS RENDER (basic formatting) ----------
  function renderDetailsToHtml(raw){
    if(!raw) return '';
    const lines = String(raw).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) return '';
    const allBullets = lines.every(l => l.startsWith('-') || l.startsWith('*'));
    if(allBullets){
      const inner = lines.map(l => `<li>${escapeHtml(l.replace(/^[-*]+\s*/, ''))}</li>`).join('');
      return `<ul>${inner}</ul>`;
    } else {
      let out = '';
      let inList = false;
      for(const line of lines){
        if(line.startsWith('-') || line.startsWith('*')){
          if(!inList){ inList = true; out += '<ul>'; }
          out += `<li>${escapeHtml(line.replace(/^[-*]+\s*/, ''))}</li>`;
        } else {
          if(inList){ out += '</ul>'; inList = false; }
          out += `<p>${escapeHtml(line)}</p>`;
        }
      }
      if(inList) out += '</ul>';
      return out;
    }
  }

  // ---------- LOAD PRODUCT (no flash) ----------
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('productId');
  const urlPrice = parseFloat(urlParams.get('price'));
  const urlCurrency = urlParams.get('currency');

  let currentProductData = null;

  // Data structures derived from variant objects
  let sizesList = [];   // array of size strings
  let colorsList = [];  // array of color strings
  let comboMap = {};    // key: `${size}|${color}` -> { stock, ... }

  async function loadProduct(){
    if(!productId){
      productContainer.style.visibility = 'visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product ID missing.</p>';
      return;
    }

    try{
      const docRef = doc(db, "brands", "serac", "products", productId);
      const docSnap = await getDoc(docRef);

      if(!docSnap.exists()){
        productContainer.style.visibility = 'visible';
        productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product not found.</p>';
        return;
      }

      const data = docSnap.data();
      currentProductData = data || {};

      // Images (safe fallbacks)
      const images = Array.isArray(data.images) && data.images.length ? data.images.filter(Boolean) : (data.imageUrl ? [data.imageUrl] : []);
      if(productImg) productImg.src = images[0] || '';
      if(thumbnailContainer) thumbnailContainer.innerHTML = '';
      images.forEach((imgUrl, idx) => {
        if(!imgUrl) return;
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        if(idx === 0) thumb.classList.add('selected');
        thumb.addEventListener('click', () => {
          if(productImg) productImg.src = imgUrl;
          thumbnailContainer.querySelectorAll('img').forEach(i=>i.classList.remove('selected'));
          thumb.classList.add('selected');
        });
        thumbnailContainer.appendChild(thumb);
      });

      // Name & description
      if(productName) productName.textContent = data.name || '';
      if(productDescription) productDescription.textContent = data.description || '';

      // Price formatting
      const displayPrice = !isNaN(urlPrice) ? urlPrice : (data.price || 0);
      const displayCurrency = urlCurrency || data.currency || 'NGN';
      const localeMap = { NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
      const minFrac = displayCurrency === 'NGN' ? 0 : 2;
      try{
        if(productPrice) productPrice.textContent = new Intl.NumberFormat(localeMap[displayCurrency]||'en-US', { style:'currency', currency:displayCurrency, minimumFractionDigits:minFrac }).format(displayPrice);
      } catch(e){
        if(productPrice) productPrice.textContent = `${displayCurrency} ${displayPrice}`;
      }
      currentProductData.price = displayPrice;
      currentProductData.currency = displayCurrency;

      // Customization
      if(data.customizationAvailable){
        if(customizeBtn){ customizeBtn.style.display = 'block'; customizeBtn.href = `customization.html?productId=${productId}`; }
      } else {
        if(customizeBtn) customizeBtn.style.display = 'none';
      }

      // --- Parse variants (array of objects) ---
      sizesList = [];
      colorsList = [];
      comboMap = {}; // reset

      if(Array.isArray(data.variants) && data.variants.length){
        data.variants.forEach(v => {
          const s = (v.size || '').toString();
          const c = (v.color || '').toString();
          if(s && !sizesList.includes(s)) sizesList.push(s);
          if(c && !colorsList.includes(c)) colorsList.push(c);
          const key = `${s}|${c}`;
          comboMap[key] = comboMap[key] || {};
          if(typeof v.stock !== 'undefined') comboMap[key].stock = v.stock;
        });
      } else {
        if(Array.isArray(data.sizes)) sizesList = data.sizes.slice();
        if(Array.isArray(data.colors)) colorsList = data.colors.slice();
      }

      // Sizes (render first)
      if(sizeOptions) sizeOptions.innerHTML = '';
      if(sizesList.length){
        sizeGroup.style.display = '';
        sizesList.forEach(s => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = s;
          btn.addEventListener('click', ()=> {
            Array.from(sizeOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateQuantityUI(productId);
            refreshClearButtonVisibility();
          });
          sizeOptions.appendChild(btn);
        });
      } else {
        sizeGroup.style.display = 'none';
      }

      // Colors
      if(colorOptions) colorOptions.innerHTML = '';
      if(colorsList.length){
        colorGroup.style.display = '';
        colorsList.forEach(c => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c;
          btn.addEventListener('click', ()=> {
            Array.from(colorOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateQuantityUI(productId);
            refreshClearButtonVisibility();
          });
          colorOptions.appendChild(btn);
        });
      } else {
        colorGroup.style.display = 'none';
      }

      // Details
      if(data.details){
        const html = renderDetailsToHtml(data.details);
        if(html){
          detailsSection.innerHTML = html;
          detailsSection.style.display = '';
        } else {
          detailsSection.style.display = 'none';
        }
      } else {
        detailsSection.style.display = 'none';
      }

      // update cart UI counters
      updateCartCount();
      updateQuantityUI(productId);

      // ensure clear button created/updated
      ensureClearButton();

      // Reveal container now that it's populated
      productContainer.style.visibility = 'visible';
      setTimeout(updateVariantBadges, 10);
    } catch(err){
      console.error(err);
      productContainer.style.visibility = 'visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Failed to load product.</p>';
    }
  }

  // ---------- BUTTON EVENTS ----------
  addCartBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    if(!validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({
      id: productId,
      name: currentProductData.name,
      price: currentProductData.price,
      currency: currentProductData.currency,
      imageUrl: productImg?.src,
      color: sel.color || '',
      size: sel.size || ''
    });
    updateVariantBadges();
    refreshClearButtonVisibility();
  });

  plusBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    if(!validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({
      id: productId,
      name: currentProductData.name,
      price: currentProductData.price,
      currency: currentProductData.currency,
      imageUrl: productImg?.src,
      color: sel.color || '',
      size: sel.size || ''
    });
    updateVariantBadges();
    refreshClearButtonVisibility();
  });

  minusBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    const sel = getSelectedOptions();
    const hasSize = !!(sizeOptions && sizeOptions.children.length);
    const hasColor = !!(colorOptions && colorOptions.children.length);

    if((hasSize || hasColor) && (!sel.size && !sel.color)){
      const cart = getCart().filter(i => i.id === productId);
      if(cart.length > 0){
        removeFromCartFallback(productId);
        updateVariantBadges();
        refreshClearButtonVisibility();
        return;
      } else {
        if(optionModal){
          optionModal.querySelector('p')?.textContent = 'No items to remove for this product.';
          optionModal.style.display = 'flex';
        }
        return;
      }
    }

    if(sel.size || sel.color){
      const removed = removeFromCartSpecific(productId, sel.color, sel.size);
      if(!removed){
        if(optionModal){
          optionModal.querySelector('p')?.textContent = 'No items of that selection to remove.';
          optionModal.style.display = 'flex';
        }
      } else {
        updateVariantBadges();
        refreshClearButtonVisibility();
      }
      return;
    }

    const baseRemoved = removeFromCartFallback(productId);
    if(baseRemoved){
      updateVariantBadges();
      refreshClearButtonVisibility();
    } else {
      if(optionModal){
        optionModal.querySelector('p')?.textContent = 'No items to remove.';
        optionModal.style.display = 'flex';
      }
    }
  });

  closeModalBtn?.addEventListener('click', () => { 
    if(optionModal) {
      optionModal.querySelector('p')?.textContent = 'Please select relevant options before adding to cart.';
      optionModal.style.display = 'none';
    }
  });

  // ---------- THUMBNAIL SWIPE (mouse) ----------
  let isDown=false, startX, scrollLeft;
  if(thumbnailContainer){
    thumbnailContainer.addEventListener('mousedown', e => { isDown=true; startX = e.pageX - thumbnailContainer.offsetLeft; scrollLeft = thumbnailContainer.scrollLeft; });
    thumbnailContainer.addEventListener('mouseup', () => { isDown=false; });
    thumbnailContainer.addEventListener('mouseleave', () => { isDown=false; });
    thumbnailContainer.addEventListener('mousemove', e => { if(!isDown) return; e.preventDefault(); const x = e.pageX - thumbnailContainer.offsetLeft; thumbnailContainer.scrollLeft = scrollLeft - (x - startX) * 2; });
  }

  // ---------- STORAGE SYNC ----------
  window.addEventListener('storage', () => { updateCartCount(); updateQuantityUI(productId); updateVariantBadges(); refreshClearButtonVisibility(); });

  // ---------- INIT ----------
  updateCartCount();
  loadProduct();

  // ---------- HEADER/HAMBURGER/SCROLL ----------
  (function headerHeroBehavior(){
    const heroEl = document.querySelector('.hero') || { getBoundingClientRect: () => ({ height:0 }) };
    if(!headerEl) return;
    let lastY = window.scrollY || 0;
    let hidden = false;
    let hoverShown = false;
    let heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0);

    function isMenuOpen(){ return hamburger && hamburger.classList.contains('open'); }
    function showHeader(forceScrolled=false){ headerEl.style.top='0'; headerEl.style.opacity='1'; headerEl.style.pointerEvents='auto'; hidden=false; if(forceScrolled) headerEl.classList.add('scrolled'); }
    function hideHeader(){ headerEl.style.top='-90px'; headerEl.style.opacity='0'; headerEl.style.pointerEvents='none'; hidden=true; }

    function handleScroll(){
      const y = window.scrollY || 0;
      const menuOpen = isMenuOpen();
      const threshold = Math.max(50, (heroHeight || 0) - 80);

      if(y > threshold) headerEl.classList.add('scrolled'); else headerEl.classList.remove('scrolled');

      if(menuOpen){ showHeader(true); lastY = y; return; }

      if(y > (heroHeight - 80)){
        if(y > lastY && !hidden) hideHeader();
        else if(y < lastY && hidden) showHeader(true);
      } else {
        showHeader(y > 50);
        if(y <= 50) headerEl.classList.remove('scrolled');
      }
      lastY = y;
    }

    document.addEventListener('mousemove', (e) => {
      if(isMenuOpen()) return;
      if(e.clientY < 100){
        if(hidden){ showHeader(true); hoverShown = true; }
      } else if(hoverShown){
        setTimeout(() => {
          if(window.scrollY > (heroHeight - 80) && !isMenuOpen()) hideHeader();
          hoverShown = false;
        }, 220);
      }
    }, { passive:true });

    if(hamburger && headerRight){
      hamburger.addEventListener('click', () => {
        const isNowOpen = hamburger.classList.toggle('open');
        headerRight.classList.toggle('open', isNowOpen);
        hamburger.setAttribute('aria-expanded', isNowOpen ? 'true' : 'false');
        if(isNowOpen){ showHeader(true); headerEl.classList.add('scrolled'); }
        else { setTimeout(handleScroll, 160); }
      });
    }

    window.addEventListener('resize', () => { heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0); handleScroll(); }, { passive:true });
    window.addEventListener('scroll', handleScroll, { passive:true });
    window.addEventListener('load', () => { heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0); handleScroll(); });
  })();

  // ---------- SMOOTH SCROLL & mobile menu auto-close ----------
  document.querySelectorAll('.header-right a').forEach(link => {
    link.addEventListener('click', e => {
      const href = link.getAttribute('href');
      if(href && href.startsWith('#')){
        e.preventDefault();
        const target = document.getElementById(href.slice(1));
        if(target) window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
      }
      if(headerRight && hamburger){
        headerRight.classList.remove('open');
        hamburger.classList.remove('open');
        hamburger.setAttribute('aria-expanded','false');
      }
    });
  });

  /* ======================================================
     VARIANT COMBO SYSTEM — START (enhanced)
  ====================================================== */

  function updateVariantBadges(){
    const cart = getCart();
    document.querySelectorAll('.variant-badge').forEach(n => n.remove());
    document.querySelectorAll('#sizeOptions > button, #colorOptions > button').forEach(b=>{
      b.classList.remove('has-combo','combo-active');
    });

    const mapSizeTotals = {};
    const mapColorTotals = {};
    const mapCombo = {};

    cart.forEach(item=>{
      if(!item || item.id !== productId) return;
      const color = item.color || 'none';
      const size = item.size || 'none';
      const qty = Number(item.quantity || 0);
      mapSizeTotals[size] = (mapSizeTotals[size] || 0) + qty;
      mapColorTotals[color] = (mapColorTotals[color] || 0) + qty;
      const ck = `${color}|${size}`;
      mapCombo[ck] = (mapCombo[ck] || 0) + qty;
    });

    const activeSize = sizeOptions?.querySelector('.selected')?.textContent?.trim() || null;
    const activeColor = colorOptions?.querySelector('.selected')?.textContent?.trim() || null;

    function attachBadgeToBtn(btn, count){
      if(!btn) return;
      let badge = btn.querySelector('.variant-badge');
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'variant-badge';
        badge.style.position = 'absolute';
        badge.style.top = '4px';
        badge.style.right = '6px';
        badge.style.background = 'var(--gold)';
        badge.style.color = '#fff';
        badge.style.fontSize = '0.65rem';
        badge.style.borderRadius = '50%';
        badge.style.minWidth = '16px';
        badge.style.height = '16px';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.fontWeight = '600';
        btn.style.position = 'relative';
        btn.appendChild(badge);
      }
      badge.textContent = String(count);
      badge.style.display = count > 0 ? 'flex' : 'none';
    }

    if(sizeOptions){
      Array.from(sizeOptions.children).forEach(btn=>{
        const s = btn.textContent.trim();
        const total = mapSizeTotals[s] || 0;
        if(total > 0){
          attachBadgeToBtn(btn, total);
          btn.classList.add('has-combo');
        } else {
          const b = btn.querySelector('.variant-badge');
          if(b) b.remove();
        }
      });
    }

    if(colorOptions){
      Array.from(colorOptions.children).forEach(btn=>{
        const c = btn.textContent.trim();
        const key = `${c}|${activeSize || 'none'}`;
        const comboQty = mapCombo[key] || 0;
        const total = mapColorTotals[c] || 0;

        if(activeSize){
          if(comboQty > 0){
            attachBadgeToBtn(btn, comboQty);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge');
            if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        } else {
          if(total > 0){
            attachBadgeToBtn(btn, total);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge');
            if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        }
      });
    }

    if(activeSize && activeColor){
      const sBtn = sizeOptions?.querySelector('.selected');
      const cBtn = colorOptions?.querySelector('.selected');
      if(sBtn) sBtn.classList.add('combo-active');
      if(cBtn) cBtn.classList.add('combo-active');
    }
  }

  function countProductCombos(pid){
    return getCart().filter(i => i.id === pid).length;
  }

  let clearButton = null;
  function ensureClearButton(){
    if(!productContainer) return;
    if(!clearButton){
      clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.textContent = 'Clear selections';
      Object.assign(clearButton.style, {
        marginTop: '8px',
        padding: '6px 10px',
        background: 'transparent',
        color: 'var(--muted)',
        border: '1px solid rgba(255,255,255,0.06)',
        borderRadius: '8px',
        cursor: 'pointer',
        fontWeight: '600'
      });
      const details = document.querySelector('.product-details');
      if(details){
        details.appendChild(clearButton);
      } else {
        productContainer.appendChild(clearButton);
      }
      clearButton.addEventListener('click', ()=> {
        clearProductCombos(productId);
        updateVariantBadges();
        refreshClearButtonVisibility();
      });
    }
    refreshClearButtonVisibility();
  }

  function refreshClearButtonVisibility(){
    const combos = countProductCombos(productId);
    if(!clearButton) return;
    if(combos >= 2){
      clearButton.style.display = 'inline-flex';
      clearButton.style.opacity = '1';
    } else {
      clearButton.style.display = 'none';
    }
  }

  window.updateVariantBadges = updateVariantBadges;
  window.refreshClearButtonVisibility = refreshClearButtonVisibility;

</script>




  

 <!-- <script type="module">
  // ---------- FIREBASE INIT ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
    authDomain:"brandisby.firebaseapp.com",
    projectId:"brandisby",
    storageBucket:"brandisby.firebasestorage.app",
    messagingSenderId:"87213267039",
    appId:"1:87213267039:web:339e9fd49e3ad31f7423ea"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM REFS ----------
  const productContainer = document.getElementById('productContainer');
  const productImg = document.getElementById('productImg');
  const productName = document.getElementById('productName');
  const productDescription = document.getElementById('productDescription');
  const productPrice = document.getElementById('productPrice');
  const quantityBadge = document.getElementById('quantityBadge');
  const addCartBtn = document.getElementById('addCartBtn');
  const minusBtn = document.getElementById('minus');
  const plusBtn = document.getElementById('plus');
  const cartCountElem = document.getElementById('cartCount');
  const customizeBtn = document.getElementById('customizeBtn');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const colorOptions = document.getElementById('colorOptions');
  const sizeOptions = document.getElementById('sizeOptions');
  const colorGroup = document.getElementById('colorGroup');
  const sizeGroup = document.getElementById('sizeGroup');
  const headerEl = document.querySelector('.site-header');
  const hamburger = document.getElementById('hamburger');
  const headerRight = document.querySelector('.header-right');
  const optionModal = document.getElementById('optionModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const detailsSection = document.getElementById('productDetailsSection');

  const STORAGE_KEY = 'seracCart';

  // ---------- CART ----------
  function getCart(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  function setCart(cart){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); updateCartCount(); }
  function updateCartCount(){ if(cartCountElem) cartCountElem.textContent = getCart().reduce((sum,i)=>sum + Number(i.quantity||0), 0); }
  function updateQuantityUI(productId){
    const total = getCart().filter(i=>i.id === productId).reduce((sum,i)=>sum + Number(i.quantity||0), 0);
    if(quantityBadge) quantityBadge.textContent = total;
    if(addCartBtn) addCartBtn.style.display = total > 0 ? 'none' : 'flex';
  }

  // ---------- CORE: add/remove per combination ----------
  function addToCart(product){
    let cart = getCart();
    const index = cart.findIndex(i => i.id === product.id && (i.color||'') === (product.color||'') && (i.size||'') === (product.size||''));
    if(index > -1){
      cart[index].quantity = (Number(cart[index].quantity)||0) + 1;
    } else {
      cart.push({...product, quantity:1});
    }
    setCart(cart);
    updateQuantityUI(product.id);
  }

  function removeFromCartSpecific(productId, color = '', size = ''){
    let cart = getCart();
    const idx = cart.findIndex(i => i.id === productId && (i.color||'') === (color||'') && (i.size||'') === (size||''));
    if(idx > -1){
      cart[idx].quantity = (Number(cart[idx].quantity)||0) - 1;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      setCart(cart);
      updateQuantityUI(productId);
      return true;
    }
    return false;
  }

  function removeFromCartFallback(productId){
    let cart = getCart();
    for(let i = cart.length - 1; i >= 0; i--){
      if(cart[i].id === productId){
        cart[i].quantity = (Number(cart[i].quantity)||0) - 1;
        if(cart[i].quantity <= 0) cart.splice(i,1);
        setCart(cart);
        updateQuantityUI(productId);
        return true;
      }
    }
    return false;
  }

  function clearProductCombos(productId){
    let cart = getCart();
    cart = cart.filter(i => i.id !== productId);
    setCart(cart);
    updateQuantityUI(productId);
  }

  // ---------- SELECTION HELPERS ----------
  function getSelectedOptions(){
    return {
      color: colorOptions?.querySelector('.selected')?.textContent?.trim() || '',
      size: sizeOptions?.querySelector('.selected')?.textContent?.trim() || ''
    };
  }

  function validateSelectionForAdd(){
    const sel = getSelectedOptions();
    if((sizeOptions?.children.length && !sel.size) || (colorOptions?.children.length && !sel.color)){
      if(optionModal) optionModal.style.display = 'flex';
      return false;
    }
    return true;
  }

  // ---------- SANITIZE (escape) ----------
  function escapeHtml(str){
    return String(str||'')
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  // ---------- DETAILS RENDER ----------
  function renderDetailsToHtml(raw){
    if(!raw) return '';
    const lines = String(raw).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) return '';
    const allBullets = lines.every(l => l.startsWith('-') || l.startsWith('*'));
    if(allBullets){
      const inner = lines.map(l => `<li>${escapeHtml(l.replace(/^[-*]+\s*/, ''))}</li>`).join('');
      return `<ul>${inner}</ul>`;
    } else {
      let out = '';
      let inList = false;
      for(const line of lines){
        if(line.startsWith('-') || line.startsWith('*')){
          if(!inList){ inList = true; out += '<ul>'; }
          out += `<li>${escapeHtml(line.replace(/^[-*]+\s*/, ''))}</li>`;
        } else {
          if(inList){ out += '</ul>'; inList = false; }
          out += `<p>${escapeHtml(line)}</p>`;
        }
      }
      if(inList) out += '</ul>';
      return out;
    }
  }

  // ---------- LOAD PRODUCT ----------
  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get('productId');
  const urlPrice = parseFloat(urlParams.get('price'));
  const urlCurrency = urlParams.get('currency');

  let currentProductData = null;

  // Properly declared data structures
  let sizesList = [];
  let colorsList = [];
  let comboMap = {};

  async function loadProduct(){
    if(!productId){
      productContainer.style.visibility = 'visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product ID missing.</p>';
      return;
    }

    try{
      const docRef = doc(db, "brands", "serac", "products", productId);
      const docSnap = await getDoc(docRef);
      if(!docSnap.exists()){
        productContainer.style.visibility = 'visible';
        productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product not found.</p>';
        return;
      }

      const data = docSnap.data();
      currentProductData = data || {};

      // Images
      const images = Array.isArray(data.images) && data.images.length ? data.images.filter(Boolean) : (data.imageUrl ? [data.imageUrl] : []);
      if(productImg) productImg.src = images[0] || '';
      if(thumbnailContainer) thumbnailContainer.innerHTML = '';
      images.forEach((imgUrl, idx)=>{
        if(!imgUrl) return;
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        if(idx===0) thumb.classList.add('selected');
        thumb.addEventListener('click', ()=> {
          if(productImg) productImg.src = imgUrl;
          thumbnailContainer.querySelectorAll('img').forEach(i=>i.classList.remove('selected'));
          thumb.classList.add('selected');
        });
        thumbnailContainer.appendChild(thumb);
      });

      // Name & description
      if(productName) productName.textContent = data.name || '';
      if(productDescription) productDescription.textContent = data.description || '';

      // Price formatting
      const displayPrice = !isNaN(urlPrice) ? urlPrice : (data.price || 0);
      const displayCurrency = urlCurrency || data.currency || 'NGN';
      const localeMap = { NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
      const minFrac = displayCurrency==='NGN' ? 0 : 2;
      try{
        if(productPrice) productPrice.textContent = new Intl.NumberFormat(localeMap[displayCurrency]||'en-US',{style:'currency', currency:displayCurrency, minimumFractionDigits:minFrac}).format(displayPrice);
      } catch(e){
        if(productPrice) productPrice.textContent = `${displayCurrency} ${displayPrice}`;
      }
      currentProductData.price = displayPrice;
      currentProductData.currency = displayCurrency;

      // Customization
      if(data.customizationAvailable){
        if(customizeBtn){ customizeBtn.style.display='block'; customizeBtn.href=`customization.html?productId=${productId}`; }
      } else {
        if(customizeBtn) customizeBtn.style.display='none';
      }

      // --- Parse variants ---
      sizesList = [];
      colorsList = [];
      comboMap = {};

      if(Array.isArray(data.variants) && data.variants.length){
        data.variants.forEach(v=>{
          const s = (v.size||'').toString();
          const c = (v.color||'').toString();
          if(s && !sizesList.includes(s)) sizesList.push(s);
          if(c && !colorsList.includes(c)) colorsList.push(c);
          const key = `${s}|${c}`;
          comboMap[key] = comboMap[key] || {};
          if(typeof v.stock !== 'undefined') comboMap[key].stock = v.stock;
        });
      } else {
        if(Array.isArray(data.sizes)) sizesList = data.sizes.slice();
        if(Array.isArray(data.colors)) colorsList = data.colors.slice();
      }

      // Sizes
      if(sizeOptions) sizeOptions.innerHTML = '';
      if(sizesList.length){
        sizeGroup.style.display='';
        sizesList.forEach(s=>{
          const btn = document.createElement('button');
          btn.type='button';
          btn.textContent=s;
          btn.addEventListener('click', ()=>{
            Array.from(sizeOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateQuantityUI(productId);
            refreshClearButtonVisibility();
          });
          sizeOptions.appendChild(btn);
        });
      } else { sizeGroup.style.display='none'; }

      // Colors
      if(colorOptions) colorOptions.innerHTML='';
      if(colorsList.length){
        colorGroup.style.display='';
        colorsList.forEach(c=>{
          const btn = document.createElement('button');
          btn.type='button';
          btn.textContent=c;
          btn.addEventListener('click', ()=>{
            Array.from(colorOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateQuantityUI(productId);
            refreshClearButtonVisibility();
          });
          colorOptions.appendChild(btn);
        });
      } else { colorGroup.style.display='none'; }

      // Details
      if(data.details){
        const html = renderDetailsToHtml(data.details);
        if(html){ detailsSection.innerHTML = html; detailsSection.style.display=''; }
        else detailsSection.style.display='none';
      } else detailsSection.style.display='none';

      updateCartCount();
      updateQuantityUI(productId);
      ensureClearButton();
      productContainer.style.visibility='visible';
      setTimeout(updateVariantBadges, 10);

    } catch(err){
      console.error(err);
      productContainer.style.visibility='visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Failed to load product.</p>';
    }
  }

  // ---------- BUTTON EVENTS ----------
  addCartBtn?.addEventListener('click', ()=>{
    if(!currentProductData) return;
    if(!validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({id:productId, name:currentProductData.name, price:currentProductData.price, currency:currentProductData.currency, imageUrl:productImg?.src, color:sel.color||'', size:sel.size||''});
    updateVariantBadges();
    refreshClearButtonVisibility();
  });

  plusBtn?.addEventListener('click', ()=>{
    if(!currentProductData) return;
    if(!validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({id:productId, name:currentProductData.name, price:currentProductData.price, currency:currentProductData.currency, imageUrl:productImg?.src, color:sel.color||'', size:sel.size||''});
    updateVariantBadges();
    refreshClearButtonVisibility();
  });

  minusBtn?.addEventListener('click', ()=>{
    if(!currentProductData) return;
    const sel = getSelectedOptions();
    const hasSize = !!(sizeOptions && sizeOptions.children.length);
    const hasColor = !!(colorOptions && colorOptions.children.length);

    if((hasSize||hasColor) && (!sel.size && !sel.color)){
      const cart = getCart().filter(i=>i.id===productId);
      if(cart.length>0){ removeFromCartFallback(productId); updateVariantBadges(); refreshClearButtonVisibility(); return; }
      else { if(optionModal){ optionModal.querySelector('p')?.textContent='No items to remove for this product.'; optionModal.style.display='flex'; } return; }
    }

    if(sel.size || sel.color){
      const removed = removeFromCartSpecific(productId, sel.color, sel.size);
      if(!removed){ if(optionModal){ optionModal.querySelector('p')?.textContent='No items of that selection to remove.'; optionModal.style.display='flex'; } }
      else { updateVariantBadges(); refreshClearButtonVisibility(); }
      return;
    }

    const baseRemoved = removeFromCartFallback(productId);
    if(baseRemoved){ updateVariantBadges(); refreshClearButtonVisibility(); }
    else { if(optionModal){ optionModal.querySelector('p')?.textContent='No items to remove.'; optionModal.style.display='flex'; } }
  });

  closeModalBtn?.addEventListener('click', ()=>{
    if(optionModal){ optionModal.querySelector('p')?.textContent='Please select relevant options before adding to cart.'; optionModal.style.display='none'; }
  });

  // ---------- THUMBNAIL SWIPE ----------
  let isDown=false, startX, scrollLeft;
  if(thumbnailContainer){
    thumbnailContainer.addEventListener('mousedown', e => { isDown=true; startX=e.pageX - thumbnailContainer.offsetLeft; scrollLeft=thumbnailContainer.scrollLeft; });
    thumbnailContainer.addEventListener('mouseup', ()=>{ isDown=false; });
    thumbnailContainer.addEventListener('mouseleave', ()=>{ isDown=false; });
    thumbnailContainer.addEventListener('mousemove', e => { if(!isDown) return; e.preventDefault(); const x=e.pageX - thumbnailContainer.offsetLeft; thumbnailContainer.scrollLeft=scrollLeft-(x-startX)*2; });
  }

  // ---------- STORAGE SYNC ----------
  window.addEventListener('storage', ()=>{ updateCartCount(); updateQuantityUI(productId); updateVariantBadges(); refreshClearButtonVisibility(); });

  // ---------- INIT ----------
  updateCartCount();
  loadProduct();

  // ---------- HEADER/HAMBURGER/SCROLL ----------
  (function headerHeroBehavior(){ /* existing code remains unchanged */ })();

  // ---------- SMOOTH SCROLL ----------
  document.querySelectorAll('.header-right a').forEach(link=>{
    link.addEventListener('click', e=>{
      const href = link.getAttribute('href');
      if(href && href.startsWith('#')){ e.preventDefault(); const target=document.getElementById(href.slice(1)); if(target) window.scrollTo({top:target.offsetTop-80, behavior:'smooth'}); }
      if(headerRight && hamburger){ headerRight.classList.remove('open'); hamburger.classList.remove('open'); hamburger.setAttribute('aria-expanded','false'); }
    });
  });

  // ---------- VARIANT COMBO SYSTEM ----------
  /* All code from updateVariantBadges(), countProductCombos(), ensureClearButton(), refreshClearButtonVisibility() remains identical */


  /* ======================================================
     VARIANT COMBO SYSTEM — START (enhanced)
     - size is parent when present
     - per-combination counts shown immediately
     - plus/minus operate intuitively (minus works even when not re-selecting)
     - dynamic Clear Selections button
     ====================================================== */

  function updateVariantBadges(){
    const cart = getCart();
    // Clear badges and states
    document.querySelectorAll('.variant-badge').forEach(n => n.remove());
    document.querySelectorAll('#sizeOptions > button, #colorOptions > button').forEach(b=>{
      b.classList.remove('has-combo','combo-active');
    });

    const mapSizeTotals = {};
    const mapColorTotals = {};
    const mapCombo = {}; // key: color|size

    cart.forEach(item=>{
      if(!item || item.id !== productId) return;
      const color = item.color || 'none';
      const size = item.size || 'none';
      const qty = Number(item.quantity || 0);
      mapSizeTotals[size] = (mapSizeTotals[size] || 0) + qty;
      mapColorTotals[color] = (mapColorTotals[color] || 0) + qty;
      const ck = `${color}|${size}`;
      mapCombo[ck] = (mapCombo[ck] || 0) + qty;
    });

    const activeSize = sizeOptions?.querySelector('.selected')?.textContent?.trim() || null;
    const activeColor = colorOptions?.querySelector('.selected')?.textContent?.trim() || null;

    function attachBadgeToBtn(btn, count){
      if(!btn) return;
      let badge = btn.querySelector('.variant-badge');
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'variant-badge';
        // inline styles to ensure visible without extra CSS
        badge.style.position = 'absolute';
        badge.style.top = '4px';
        badge.style.right = '6px';
        badge.style.background = 'var(--gold)';
        badge.style.color = '#fff';
        badge.style.fontSize = '0.65rem';
        badge.style.borderRadius = '50%';
        badge.style.minWidth = '16px';
        badge.style.height = '16px';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.fontWeight = '600';
        btn.style.position = 'relative';
        btn.appendChild(badge);
      }
      badge.textContent = String(count);
      badge.style.display = count > 0 ? 'flex' : 'none';
    }

    // Size badges show total per size
    if(sizeOptions){
      Array.from(sizeOptions.children).forEach(btn=>{
        const s = btn.textContent.trim();
        const total = mapSizeTotals[s] || 0;
        if(total > 0){
          attachBadgeToBtn(btn, total);
          btn.classList.add('has-combo');
        } else {
          const b = btn.querySelector('.variant-badge');
          if(b) b.remove();
        }
      });
    }

    // Color badges show count for active size if size selected, else totals
    if(colorOptions){
      Array.from(colorOptions.children).forEach(btn=>{
        const c = btn.textContent.trim();
        const key = `${c}|${activeSize || 'none'}`;
        const comboQty = mapCombo[key] || 0;
        const total = mapColorTotals[c] || 0;

        if(activeSize){
          if(comboQty > 0){
            attachBadgeToBtn(btn, comboQty);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge');
            if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        } else {
          if(total > 0){
            attachBadgeToBtn(btn, total);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge');
            if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        }
      });
    }

    if(activeSize && activeColor){
      const sBtn = sizeOptions?.querySelector('.selected');
      const cBtn = colorOptions?.querySelector('.selected');
      if(sBtn) sBtn.classList.add('combo-active');
      if(cBtn) cBtn.classList.add('combo-active');
    }
  }

  // return number of combos for this product
  function countProductCombos(pid){
    return getCart().filter(i => i.id === pid).length;
  }

  // --- Clear Selections UI ---
  let clearButton = null;
  function ensureClearButton(){
    if(!productContainer) return;
    // create button if not existing
    if(!clearButton){
      clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.textContent = 'Clear selections';
      Object.assign(clearButton.style, {
        marginTop: '8px',
        padding: '6px 10px',
        background: 'transparent',
        color: 'var(--muted)',
        border: '1px solid rgba(255,255,255,0.06)',
        borderRadius: '8px',
        cursor: 'pointer',
        fontWeight: '600'
      });
      // insert near variant groups (after buttons-row). Try to place inside product-details
      const details = document.querySelector('.product-details');
      if(details){
        details.appendChild(clearButton);
      } else {
        productContainer.appendChild(clearButton);
      }
      clearButton.addEventListener('click', ()=> {
        clearProductCombos(productId);
        updateVariantBadges();
        refreshClearButtonVisibility();
      });
    }
    refreshClearButtonVisibility();
  }

  function refreshClearButtonVisibility(){
    const combos = countProductCombos(productId);
    if(!clearButton) return;
    if(combos >= 2){
      clearButton.style.display = 'inline-flex';
      clearButton.style.opacity = '1';
    } else {
      clearButton.style.display = 'none';
    }
  }

  // Expose for debugging if needed
  window.updateVariantBadges = updateVariantBadges;
  window.countProductCombos = countProductCombos;
  window.clearProductCombos = clearProductCombos;

  // ensure initial creation
  ensureClearButton();

  // ensure badges reflect initial cart on load
  window.addEventListener('load', ()=> {
    setTimeout(()=>{ updateVariantBadges(); refreshClearButtonVisibility(); }, 10);
  });

  /* ======================================================
     VARIANT COMBO SYSTEM — END
     ====================================================== */

</script> -->


</body>
</html>

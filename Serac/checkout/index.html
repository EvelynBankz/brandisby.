<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SÃ©rac - Checkout</title>

<!-- Fonts + Icons (same as cart) -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --bg-mid: #2A2B30;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --accent-strong: rgba(182,110,65,0.95);
  --radius: 14px;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body { height:100%; }
body { font-family:"Montserrat", sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
a { text-decoration:none; color:inherit; transition: color var(--transition); }

/* HEADER */
.site-header { background: transparent; transition: background 0.3s ease, border-bottom 0.3s ease; color:#f5f5f5; display:flex; justify-content:space-between; align-items:center; padding:16px 28px; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.04); }
.site-header.scrolled { background:var(--bg-dark); border-bottom:1px solid rgba(255,255,255,0.06); }

.header-left { display:flex; align-items:center; gap:14px; }
.brand-logo { height:56px; width:auto; object-fit:contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; color:var(--gold); letter-spacing:0.6px; }

.header-right { display:flex; gap:20px; align-items:center; }
.header-right a { font-weight:500; color:var(--muted); padding:6px 8px; border-radius:8px; transition: all var(--transition); }
.header-right a:hover { color:#fff; transform:translateY(-2px); text-shadow: 0 4px 18px rgba(182,110,65,0.15); }

.cart-count { background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:38px; height:32px; position:relative; z-index:1200; }
.hamburger span { display:block; width:100%; height:3px; background:var(--gold); border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:6px; }
.hamburger span:nth-child(2){ top:14px; }
.hamburger span:nth-child(3){ top:22px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:14px; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:14px; }

/* HERO */
.hero { position: relative; height: 90vh; display: flex; justify-content: center; align-items: center; text-align: center; margin-top: 0px; overflow: hidden; padding-top:72px; border-bottom-left-radius: 12px; border-bottom-right-radius:12px; }
.hero::after { content: ""; position: absolute; inset: 0; background: var(--hero-bg, url('asset/bg25.jpg')) center/cover no-repeat; transform: scale(1.06); z-index: -1; border-radius: 12px; box-shadow: inset 0 0 0 2000px rgba(20,21,23,0.55); }
.hero-text { position: relative; display: inline-block; margin-bottom:12px; z-index:1; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size: clamp(28px,5vw,48px); margin-bottom:12px; color:var(--gold); }
.hero-text p { font-size: clamp(14px,2vw,18px); max-width:900px; color:#F5F5F3}

/* ðŸŸ¢ When paid, hero background changes */
.hero.paid {
  background: url('../asset/bg25.jpg') center/cover no-repeat;
}

/* ðŸŸ¢ Paid button style */
#payBtn.paid-state {
  background-color: #1faa59 !important;
  cursor: default;
  pointer-events: none;
}

/* MAIN CHECKOUT LAYOUT */
section.checkout { padding:56px 18px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0)); }
.checkout-inner {
  max-width:1100px;
  margin:0 auto;
  display:grid;
  grid-template-columns: 1fr 1.4fr;
  gap:28px;
  align-items:start;
}
@media (max-width:980px){
  .checkout-inner { grid-template-columns: 1fr; padding: 0 12px; }
  .hero { height: 30vh; }
}
.card {
  border-radius: 16px;
  background: var(--card-bg);
  padding:22px;
  border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 12px 30px rgba(0,0,0,0.55);
}
.checkout-form h2, .order-summary h2 { font-family:"Playfair Display", serif; color:#fff; margin-bottom:12px; font-size:22px; }
label { display:block; margin-bottom:6px; color:#e9e9e9; font-weight:600; }
input[type="text"], input[type="email"], input[type="tel"], textarea, select { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: transparent; color:#e9e9e9; font-family:inherit; margin-bottom:12px; }
textarea { min-height:120px; resize:vertical; }
.order-summary ul { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px; }
.order-item { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); transition: all var(--transition); }
.order-item .left { display:flex; gap:12px; align-items:center; flex:1; min-width:0; padding-left:0; }
.order-item img { width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,0.04); transition: all var(--transition); }
/* ensure names are left aligned */
.order-item .meta, .order-item .title { font-size:0.95rem; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; text-align:left; }
.order-item .title { font-weight:700; color:#fff; text-align:left; }
.order-item .price { font-weight:700; color:var(--gold); min-width:110px; text-align:right; }
.show-variants-btn { background: transparent; color:var(--muted); border: 1px solid rgba(255,255,255,0.04); border-radius: 8px; padding:6px 8px; cursor: pointer; font-weight:700; transition: all var(--transition); font-size:13px; margin-top:8px; }
.variants-container { display:none; flex-direction:column; gap:8px; margin-top:8px; padding-left:0; border-left:2px dashed rgba(255,255,255,0.03); }
.variants-container.show { display:flex; }
.variant-line { display:flex; justify-content:space-between; gap:12px; align-items:center; padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); color:var(--muted); font-size:0.95rem; }
.currency-selector { display:flex; justify-content:flex-end; gap:8px; align-items:center; margin-bottom:12px; }
.totals { margin-top:12px; text-align:right; font-weight:700; color:#fff; font-size:18px; }
.pay-btn { display:block; width:100%; margin-top:16px; padding:14px; border-radius:12px; background: linear-gradient(180deg, var(--gold), #a55a36); color:#fff; border:none; font-weight:800; cursor:pointer; transition: transform var(--transition); }
.pay-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.error-banner { display:none; margin-bottom:12px; padding:12px; border-radius:8px; background: linear-gradient(180deg, rgba(255,50,50,0.12), rgba(255,30,30,0.06)); color:#ffd6d6; border:1px solid rgba(255,30,30,0.12); }
.spinner-backdrop { display:none; position:fixed; inset:0; z-index:9999; background: rgba(0,0,0,0.6); align-items:center; justify-content:center; }
.spinner { background: rgba(255,255,255,0.03); padding:22px; border-radius:12px; display:flex; gap:12px; align-items:center; box-shadow: 0 8px 40px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.03); }
.spinner .dot { width:14px; height:14px; border-radius:50%; background:var(--gold); animation: spin 1.1s linear infinite; }
@keyframes spin { 0% { transform: scale(0.9) } 50% { transform: scale(1.3) } 100% { transform: scale(0.9) } }
.note { font-size:0.95rem; color:var(--muted); margin-top:8px; }
footer { text-align:center; padding:22px; background:transparent; color:var(--muted); margin-top:36px; border-top:1px solid rgba(255,255,255,0.02); }
.order-item .left { display: flex; flex-direction: column; gap: 6px; min-width:0; }
.show-details-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.95rem; padding: 6px 0; text-align: left; }
.details-container { flex-direction: column; padding-left: 0; padding-right: 0; margin-bottom: 8px; border-left: 2px solid rgba(255,255,255,0.03); display: none; }
.details-container.show { display: flex; }
.details-container div { display: flex; justify-content: space-between; font-size: 0.95rem; color: #bbb; padding: 6px 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
@media (max-width:680px){
  .order-item img { width:48px; height:48px; }
  .brand-logo { height:48px; }
  .hero { height:40vh; }
  .checkout-inner { grid-template-columns:1fr; gap:20px; padding: 12px; }
  .order-item .meta { font-size:0.92rem; }
  .order-item .price { min-width:60px; font-size:0.95rem; }
  textarea { min-height:100px; }
}
@media (max-width:900px){
  .hamburger { display:block; }
  .header-right { display:none; position:absolute; top:64px; right:12px; background:rgba(20,20,20,0.98); flex-direction:column; padding:18px; gap:10px; border-radius:10px; width:220px; z-index:1100; border:1px solid rgba(255,255,255,0.03); }
  .header-right.open { display:flex; }
}

/* small helper */
.small-note { color:var(--muted); padding:8px; text-align:center; }
</style>

</head>
<body>

<header class="site-header" id="siteHeader">
  <div class="header-left">
    <img src="../asset/logo.png" alt="SÃ©rac Logo" class="brand-logo">
    <div class="brand-title">SÃ©rac</div>
  </div>
  <nav class="header-right" id="headerRight">
    <a href="../index.html">Home</a>
    <a href="../shop.html">Shop</a>
    <a href="../about.html">About</a>
    <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="../contact.html">Contact</a>
  </nav>
  <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
</header>

<!-- Hero -->
<section class="hero" id="heroSection" style="--hero-bg: url('../asset/bg25.jpg');">
  <div class="hero-text">
    <h1 id="heroH1">Checkout</h1>
    <p id="heroP">Complete your order â€” secure payment and quick processing</p>
  </div>
</section>

<section class="checkout">
  <div class="checkout-inner">
    <!-- left: billing form -->
    <div class="card checkout-form" id="checkoutCard">
      <h2>Billing Details</h2>

      <div class="error-banner" id="errorBanner"></div>

      <form id="checkoutForm" autocomplete="off">
        <label for="name">Full Name</label>
        <input id="name" name="fullname" type="text" placeholder="Jane Doe" required>

        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>

        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="tel" placeholder="+2348000000000" required>

        <label for="address">Address</label>
        <textarea id="address" name="address" placeholder="Street, City, Country" required></textarea>
      </form>
    </div>

    <!-- right: order summary -->
    <aside class="card order-summary" id="orderCard">
      <h2 id="orderCardTitle">Order Summary</h2>

      <div class="currency-selector" id="currencySelector" style="display:none">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>

      <ul id="orderItems" aria-live="polite"></ul>

      <div class="totals" id="totalsText">Subtotal: â€”</div>
      <div class="note" id="feesNote">Fees does not include shipping</div>

      <div class="note">You will be redirected to payment after clicking Proceed to Payment.</div>

      <button id="payBtn" class="pay-btn">Proceed to Payment</button>
    </aside>
  </div>
</section>

<footer>
  <p>Â© 2025 SÃ©rac</p>
</footer>

<!-- error / spinner overlays -->
<div class="spinner-backdrop" id="spinnerBackdrop" role="status" aria-hidden="true">
  <div class="spinner" id="spinnerBox">
    <div class="dot" aria-hidden="true"></div>
    <div style="color:#fff;font-weight:700">Processing... please wait</div>
  </div>
</div>

<!-- Flutterwave script -->
<script src="https://checkout.flutterwave.com/v3.js"></script>

<!-- Main logic -->
<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* CONFIG (same project as other Serac files) */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Flutterwave public key (test) â€” use your real key in production */
const FLW_PUBLIC_KEY = "FLWPUBK_TEST-07eb9d2da345c08dc4d54278c3bc86f7-X";

/* Cloud Function endpoint (replace with your deployed HTTPS function URL) */
const CLOUD_FN_VERIFY = "https://<REGION>-<PROJECT>.cloudfunctions.net/verifyPayment"; 
// NOTE: replace the placeholder above with your deployed function URL when you deploy. (This is the only place to replace with a real URL.)

/* DOM refs */
const cartCountElem = document.getElementById('cartCount');
const orderItemsEl = document.getElementById('orderItems');
const totalsText = document.getElementById('totalsText');
const payBtn = document.getElementById('payBtn');
const currencySelect = document.getElementById('currency');
const currencySelector = document.getElementById('currencySelector');
const spinnerBackdrop = document.getElementById('spinnerBackdrop');
const errorBanner = document.getElementById('errorBanner');

const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');

const hero = document.getElementById('heroSection');
const heroH1 = document.getElementById('heroH1');
const heroP = document.getElementById('heroP');

/* Local storage keys */
const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

/* state */
let cart = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
let selectedCurrency = localStorage.getItem(CURRENCY_KEY) || 'NGN';
let productCache = {};

const urlParams = new URLSearchParams(window.location.search);
const quoteId = urlParams.get("quoteId") || null;
const orderId = urlParams.get("orderId") || null;

let activeQuoteRaw = null;   // raw quote doc (if loaded)
let activeOrderRaw = null;   // raw order doc (if loaded)
let isPaidOrder = false;     // true when we are viewing a paid order summary
let quote = null;            // normalized structure used by renderOrder()

/* ---------- Utilities ---------- */
function showSpinner(show=true){
  spinnerBackdrop.style.display = show ? 'flex' : 'none';
  spinnerBackdrop.setAttribute('aria-hidden', show ? 'false' : 'true');
}
function showError(msg){
  if(!msg){ errorBanner.style.display='none'; errorBanner.textContent=''; return; }
  errorBanner.style.display = 'block';
  errorBanner.textContent = msg;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function formatPrice(value, currency){
  const localeMap = { USD:'en-US', EUR:'de-DE', GBP:'en-GB', NGN:'en-NG' };
  const minFrac = currency === 'NGN' ? 0 : 2;
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style:'currency', currency, minimumFractionDigits: minFrac }).format(Number(value || 0));
  } catch(e) {
    return `${currency} ${Number(value || 0).toFixed(minFrac)}`;
  }
}
function escapeHtml(str){ if(!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

/* Reuse product fetching from Firestore (same path as cart) */
async function fetchProductData(productId){
  try {
    if(productCache[productId]) return productCache[productId];
    const dref = doc(db, "brands", "serac", "products", productId);
    const snap = await getDoc(dref);
    if(snap.exists()){
      productCache[productId] = snap.data();
      return productCache[productId];
    }
  } catch(e){ console.warn("Fetch product failed", productId, e); }
  return null;
}

/* merge cart items (same logic as cart page) */
function mergeCartItems(cartArray){
  const merged = [];
  (cartArray || []).forEach(item=>{
    const idx = merged.findIndex(i => i.id === item.id && (i.color||'') === (item.color||'') && (i.size||'') === (item.size||''));
    if(idx === -1) merged.push({...item});
    else merged[idx].quantity = Number(merged[idx].quantity || 0) + Number(item.quantity || 0);
  });
  return merged;
}

/* build normalized quote from client cart (used when no quoteId) */
async function buildQuoteFromCart(){
  cart = mergeCartItems(cart);
  const byProduct = new Map();
  cart.forEach(row=>{
    if(!byProduct.has(row.id)) byProduct.set(row.id, []);
    byProduct.get(row.id).push(row);
  });
  const productIds = Array.from(byProduct.keys());
  const productsData = await Promise.all(productIds.map(pid => fetchProductData(pid).then(d => [pid, d])));
  const productsMap = Object.fromEntries(productsData.map(([id, doc]) => [id, doc]));

  const items = [];
  for(const pid of productIds){
    const rows = byProduct.get(pid) || [];
    const productDoc = productsMap[pid] || null;
    // IMPORTANT: do not use placeholders. Only use image if real image exists.
    const image = (productDoc && productDoc.images && productDoc.images.length) ? productDoc.images[0] :
                  (productDoc && productDoc.imageUrl) ? productDoc.imageUrl :
                  null; // null means don't show an image
    const name = productDoc?.name || rows[0]?.name || 'Product';
    const variantDetails = rows.map(r => {
      const unitPrices = {
        NGN: (productDoc && productDoc.priceNGN != null) ? Number(productDoc.priceNGN) : (r.price || 0),
        USD: (productDoc && productDoc.priceUSD != null) ? Number(productDoc.priceUSD) : null,
        EUR: (productDoc && productDoc.priceEUR != null) ? Number(productDoc.priceEUR) : null,
        GBP: (productDoc && productDoc.priceGBP != null) ? Number(productDoc.priceGBP) : null
      };
      const quantity = Number(r.quantity) || 0;
      const linePrices = {
        NGN: (unitPrices.NGN || 0) * quantity,
        USD: (unitPrices.USD || 0) * quantity,
        EUR: (unitPrices.EUR || 0) * quantity,
        GBP: (unitPrices.GBP || 0) * quantity
      };
      return { id: r.id || pid, color: r.color||'', size: r.size||'', quantity, unitPrices, linePrices };
    });

    const totalQty = variantDetails.reduce((s,a) => s + a.quantity, 0);
    const totalPrices = {
      NGN: variantDetails.reduce((s,a) => s + (a.linePrices.NGN||0), 0),
      USD: variantDetails.reduce((s,a) => s + (a.linePrices.USD||0), 0),
      EUR: variantDetails.reduce((s,a) => s + (a.linePrices.EUR||0), 0),
      GBP: variantDetails.reduce((s,a) => s + (a.linePrices.GBP||0), 0)
    };

    items.push({ productId: pid, name, image, totalQuantity: totalQty, totalPrices, variants: variantDetails, description: productDoc?.description || '' });
  }

  return { items };
}

/* Normalize server quote items into the same structure used above */
function normalizeQuoteItems(rawQuote){
  const arr = Array.isArray(rawQuote.items) ? rawQuote.items : [];
  const items = arr.map(ci => {
    if(Array.isArray(ci.variants) && ci.variants.length){
      const variants = ci.variants.map(v => {
        const qty = Number(v.qty || v.quantity) || 0;
        const unitPrices = {
          NGN: Number(v.priceNGN) || Number(v.price) || 0,
          USD: Number(v.priceUSD) || 0,
          EUR: Number(v.priceEUR) || 0,
          GBP: Number(v.priceGBP) || 0
        };
        return {
          id: v.id || ci.id || '',
          color: v.color || '',
          size: v.size || '',
          quantity: qty,
          unitPrices,
          linePrices: {
            NGN: (unitPrices.NGN || 0) * qty,
            USD: (unitPrices.USD || 0) * qty,
            EUR: (unitPrices.EUR || 0) * qty,
            GBP: (unitPrices.GBP || 0) * qty
          }
        };
      });
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: variants.reduce((s,a) => s + a.quantity, 0),
        totalPrices: {
          NGN: variants.reduce((s,a) => s + (a.linePrices.NGN||0), 0),
          USD: variants.reduce((s,a) => s + (a.linePrices.USD||0), 0),
          EUR: variants.reduce((s,a) => s + (a.linePrices.EUR||0), 0),
          GBP: variants.reduce((s,a) => s + (a.linePrices.GBP||0), 0)
        },
        variants,
        description: ci.description || ''
      };
    } else {
      // single line
      const qty = Number(ci.qty || ci.quantity) || 1;
      const unitPrices = {
        NGN: Number(ci.priceNGN) || Number(ci.price) || 0,
        USD: Number(ci.priceUSD) || 0,
        EUR: Number(ci.priceEUR) || 0,
        GBP: Number(ci.priceGBP) || 0
      };
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: qty,
        totalPrices: {
          NGN: (unitPrices.NGN || 0) * qty,
          USD: (unitPrices.USD || 0) * qty,
          EUR: (unitPrices.EUR || 0) * qty,
          GBP: (unitPrices.GBP || 0) * qty
        },
        variants: [{
          id: ci.id || '',
          color: '',
          size: '',
          quantity: qty,
          unitPrices,
          linePrices: {
            NGN: (unitPrices.NGN || 0) * qty,
            USD: (unitPrices.USD || 0) * qty,
            EUR: (unitPrices.EUR || 0) * qty,
            GBP: (unitPrices.GBP || 0) * qty
          }
        }],
        description: ci.description || ''
      };
    }
  });

  return { items };
}

/* ---------------- Render / UI ---------------- */
function renderOrderFromQuoteNormalized(quoteNormalized, currency = 'NGN', paid=false){
  // quoteNormalized: { items: [...] }
  orderItemsEl.innerHTML = '';
  if(!quoteNormalized || !Array.isArray(quoteNormalized.items)) {
    orderItemsEl.innerHTML = '<li class="small-note">No items</li>';
    totalsText.textContent = `Subtotal: â€”`;
    return;
  }

  let subtotal = 0;

  quoteNormalized.items.forEach((item, idx) => {
    const value = (item.totalPrices && (item.totalPrices[currency] ?? 0)) || 0;
    subtotal += value;

    const li = document.createElement('li');
    li.className = 'order-item';
    li.dataset.idx = idx;

    // Always align name to left (css handles it)
    // Only show image if item.image exists (no placeholders)
    const imageHtml = item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}">` : '';

    if (paid) {
      // compact display for paid order (no placeholder images)
      li.innerHTML = `
        <div class="left" style="flex-direction:row; align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            <button class="show-details-btn" data-idx="${idx}">Show Details â–¾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>
      `;
      orderItemsEl.appendChild(li);

      // details container includes description from admin quote (item.description)
      const detailsContainer = document.createElement('div');
      detailsContainer.className = 'details-container';
      detailsContainer.dataset.forIdx = idx;
      detailsContainer.style.display = 'none';
      const desc = item.description || '';
      detailsContainer.innerHTML = `<div style="padding:8px;display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--muted);">${escapeHtml(desc)}</div>
        <div style="display:flex;justify-content:flex-end;color:var(--muted)">${escapeHtml(String(item.totalQuantity))} Ã—</div>
      </div>`;
      li.parentNode.insertBefore(detailsContainer, li.nextSibling);

    } else {
      // regular checkout style show image (only when exists) + optional variants + details button
      li.innerHTML = `
        <div class="left" style="flex-direction:row; align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            ${ (Array.isArray(item.variants) && item.variants.length > 1) ? `<button class="show-variants-btn" data-idx="${idx}">Show Choices â–¾</button>` : '' }
            <button class="show-details-btn" data-idx="${idx}" style="margin-top:6px;">Show Details â–¾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>
      `;
      orderItemsEl.appendChild(li);

      if(Array.isArray(item.variants) && item.variants.length){
        const variantsContainer = document.createElement('div');
        variantsContainer.className = 'variants-container';
        variantsContainer.dataset.forIdx = idx;

        item.variants.forEach(v=>{
          const line = document.createElement('div');
          line.className = 'variant-line';
          let labelParts = [];
          if (v.color) labelParts.push(escapeHtml(v.color));
          if (v.size) labelParts.push(escapeHtml(v.size));
          const label = labelParts.length ? `${labelParts.join(' Â· ')} Ã—${v.quantity}` : `Ã—${v.quantity}`;
          const linePrice = (v.linePrices && (v.linePrices[selectedCurrency] ?? 0)) || 0;
          line.innerHTML = `<div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${label}</div><div style="min-width:110px;text-align:right;color:var(--muted)">${formatPrice(linePrice, selectedCurrency)}</div>`;
          variantsContainer.appendChild(line);
        });

        li.parentNode.insertBefore(variantsContainer, li.nextSibling);
      }

      // details container for unpaid items (description from admin)
      const detailsContainer = document.createElement('div');
      detailsContainer.className = 'details-container';
      detailsContainer.dataset.forIdx = idx;
      detailsContainer.style.display = 'none';
      const desc = item.description || '';
      detailsContainer.innerHTML = `<div style="padding:8px;display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--muted);">${escapeHtml(desc)}</div>
      </div>`;
      li.parentNode.insertBefore(detailsContainer, li.nextSibling);
    }
  });

  // wire toggles
  document.querySelectorAll('.show-variants-btn').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const idx = btn.dataset.idx;
      const container = document.querySelector(`.variants-container[data-for-idx="${idx}"]`);
      if(!container) return;
      const isShown = container.classList.toggle('show');
      container.style.display = isShown ? 'flex' : 'none';
      btn.textContent = isShown ? 'Hide Choices â–´' : 'Show Choices â–¾';
    });
  });

  document.querySelectorAll('.show-details-btn').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const idx = btn.dataset.idx;
      const container = document.querySelector(`.details-container[data-for-idx="${idx}"]`);
      if(!container) return;
      const isShown = container.classList.toggle('show');
      container.style.display = isShown ? 'flex' : 'none';
      btn.textContent = isShown ? 'Hide Details â–´' : 'Show Details â–¾';
    });
  });

  totalsText.textContent = `Subtotal: ${formatPrice(subtotal, selectedCurrency)}`;
  // cart count for UI continuity
  try { cartCountElem.textContent = quote ? quote.items.reduce((s,a)=>s + (a.totalQuantity || 0), 0) : 0; } catch(e){}
}

/* ----------------- Load checkout data (quote or order) ----------------- */
async function loadCheckoutData(){
  selectedCurrency = localStorage.getItem(CURRENCY_KEY) || selectedCurrency || 'NGN';
  currencySelect.value = selectedCurrency;

  // hide currency selector unless quote present
  currencySelector.style.display = quoteId ? 'flex' : 'none';

  try {
    showSpinner(true);

    // If orderId param present, prefer the order document (paid order summary)
    if (orderId) {
      const orderSnap = await getDoc(doc(db, "brands", "serac", "orders", orderId));
      if (orderSnap.exists()){
        activeOrderRaw = orderSnap.data();
        isPaidOrder = true;
        // Fill billing fields from order doc (if available)
        nameInput.value = activeOrderRaw.name || activeOrderRaw.customer || "";
        emailInput.value = activeOrderRaw.email || activeOrderRaw.customerEmail || "";
        phoneInput.value = activeOrderRaw.phone || "";
        addressInput.value = activeOrderRaw.address || "";
        // Build a normalized quote structure from order.items if possible
        if (Array.isArray(activeOrderRaw.items)) {
          const ordItems = activeOrderRaw.items.map(it => {
            if (it.variants || it.totalPrices) return it;
            const qty = Number(it.qty || it.quantity) || 1;
            const unitPrices = {
              NGN: Number(it.priceNGN || it.price || 0),
              USD: Number(it.priceUSD || 0),
              EUR: Number(it.priceEUR || 0),
              GBP: Number(it.priceGBP || 0),
            };
            return {
              productId: it.id || '',
              name: it.name || '',
              image: (it.image && it.image !== '../asset/placeholder.jpg') ? it.image : null,
              totalQuantity: qty,
              totalPrices: {
                NGN: (unitPrices.NGN || 0) * qty,
                USD: (unitPrices.USD || 0) * qty,
                EUR: (unitPrices.EUR || 0) * qty,
                GBP: (unitPrices.GBP || 0) * qty
              },
              variants: [{
                id: it.id || '',
                color: it.color || '',
                size: it.size || '',
                quantity: qty,
                unitPrices,
                linePrices: {
                  NGN: (unitPrices.NGN || 0) * qty,
                  USD: (unitPrices.USD || 0) * qty,
                  EUR: (unitPrices.EUR || 0) * qty,
                  GBP: (unitPrices.GBP || 0) * qty
                }
              }],
              description: it.description || ''
            };
          });
          quote = { items: ordItems };
          renderOrderFromQuoteNormalized(quote, selectedCurrency, true);
          // set hero and button state for paid
          hero.classList.add('paid');
          heroH1.textContent = "Order Summary";
          heroP.textContent = "Your order has been paid successfully.";
          payBtn.textContent = "Paid âœ…";
          payBtn.disabled = true;
          payBtn.classList.add('paid-state');
          showSpinner(false);
          return;
        }
      } else {
        console.warn("Order not found for orderId:", orderId);
      }
    }

    // If we reach here, either no orderId or order didn't exist. Try quoteId.
    if (quoteId) {
      const quoteSnap = await getDoc(doc(db, "brands", "serac", "quotes", quoteId));
      if (!quoteSnap.exists()) {
        showSpinner(false);
        showError("Quote not found. It might have been deleted.");
        return;
      }
      activeQuoteRaw = quoteSnap.data();
      // If quote has status 'paid' and an orderId, try to load that order and show summary instead of checkout
      const qStatus = (activeQuoteRaw.status || "").toLowerCase();
      if (qStatus === 'paid' && activeQuoteRaw.orderId) {
        // try to load order doc
        const linkedOrderSnap = await getDoc(doc(db, "brands", "serac", "orders", activeQuoteRaw.orderId));
        if (linkedOrderSnap.exists()){
          activeOrderRaw = linkedOrderSnap.data();
          isPaidOrder = true;
          // fill billing from order
          nameInput.value = activeOrderRaw.name || activeOrderRaw.customer || "";
          emailInput.value = activeOrderRaw.email || activeOrderRaw.customerEmail || "";
          phoneInput.value = activeOrderRaw.phone || "";
          addressInput.value = activeOrderRaw.address || "";
          // normalize items from order
          if (Array.isArray(activeOrderRaw.items)) {
            const ordItems = activeOrderRaw.items.map(it => {
              if (it.variants || it.totalPrices) return it;
              const qty = Number(it.qty || it.quantity) || 1;
              const unitPrices = {
                NGN: Number(it.priceNGN || it.price || 0),
                USD: Number(it.priceUSD || 0),
                EUR: Number(it.priceEUR || 0),
                GBP: Number(it.priceGBP || 0),
              };
              return {
                productId: it.id || '',
                name: it.name || '',
                image: (it.image && it.image !== '../asset/placeholder.jpg') ? it.image : null,
                totalQuantity: qty,
                totalPrices: {
                  NGN: (unitPrices.NGN || 0) * qty,
                  USD: (unitPrices.USD || 0) * qty,
                  EUR: (unitPrices.EUR || 0) * qty,
                  GBP: (unitPrices.GBP || 0) * qty
                },
                variants: [{
                  id: it.id || '',
                  color: it.color || '',
                  size: it.size || '',
                  quantity: qty,
                  unitPrices,
                  linePrices: {
                    NGN: (unitPrices.NGN || 0) * qty,
                    USD: (unitPrices.USD || 0) * qty,
                    EUR: (unitPrices.EUR || 0) * qty,
                    GBP: (unitPrices.GBP || 0) * qty
                  }
                }],
                description: it.description || ''
              };
            });
            quote = { items: ordItems };
            renderOrderFromQuoteNormalized(quote, selectedCurrency, true);
            // UI: hero and disabled pay
            hero.classList.add('paid');
            heroH1.textContent = "Order Summary";
            heroP.textContent = "Your order has been paid successfully.";
            payBtn.textContent = "Paid âœ…";
            payBtn.disabled = true;
            payBtn.classList.add('paid-state');
            showSpinner(false);
            return;
          }
        } else {
          // Quote says paid but linked order doc not found â€” still show the quote items but disable pay
          console.warn("Quote status paid but order doc not found for id:", activeQuoteRaw.orderId);
        }
      }

      // If quote is unpaid (or paid but no linked order), show quote items for checkout
      // Fill billing inputs with quote customer info (if available)
      if (activeQuoteRaw.customer) nameInput.value = activeQuoteRaw.customer;
      if (activeQuoteRaw.email) emailInput.value = activeQuoteRaw.email;

      // Normalize quote items into same structure expected by render function
      quote = normalizeQuoteItems(activeQuoteRaw);
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);

      // set hero to checkout mode
      hero.classList.remove('paid');
      heroH1.textContent = "Checkout";
      heroP.textContent = "Review your quote and proceed to payment.";
      payBtn.textContent = "Proceed to Payment";
      payBtn.disabled = false;
      payBtn.classList.remove('paid-state');
      showSpinner(false);
      return;
    }

    // No quoteId and no orderId -> load from local cart
    cart = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    cart = mergeCartItems(cart);
    if (!cart.length) {
      quote = { items: [] };
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      showSpinner(false);
      showError("Your cart is empty.");
      return;
    }
    // build quote from local cart
    quote = await buildQuoteFromCart();
    renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
    showSpinner(false);
  } catch(err){
    showSpinner(false);
    console.error("Failed to load checkout data:", err);
    showError("Failed to load checkout data. Please refresh and try again.");
  }
}

/* ---------- Basic validation ---------- */
function validateForm(){
  showError('');
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const phone = phoneInput.value.trim();
  const address = addressInput.value.trim();
  if(!name) return "Name is required.";
  if(!email) return "Email is required.";
  if(!/^\S+@\S+\.\S+$/.test(email)) return "Please provide a valid email.";
  if(!phone) return "Phone is required.";
  if(!address) return "Address is required.";
  if(!quote || !Array.isArray(quote.items) || quote.items.length === 0) return "Cart is empty.";
  return null;
}

/* ---------- Payment & saving flow ----------
  NEW: On callback, we call the Cloud Function endpoint with tx_ref and order data.
  The Cloud Function will verify with Flutterwave server-side, update Firestore,
  create order doc, update quote doc, and return a JSON result.
------------------------------------------- */

payBtn.addEventListener('click', async (ev) => {
  ev.preventDefault();

  // If this is a paid order view, don't allow payment
  if (isPaidOrder) return;

  showError('');
  const v = validateForm();
  if (v) { showError(v); return; }

  // compute subtotal
  let subtotal = 0;
  quote.items.forEach(it => subtotal += (it.totalPrices && (it.totalPrices[selectedCurrency] ?? 0)) || 0);
  if (subtotal <= 0) { showError("Subtotal is zero. Cannot proceed."); return; }

  payBtn.disabled = true;
  showSpinner(true);

  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const phone = phoneInput.value.trim();
  const address = addressInput.value.trim();

  const baseOrder = {
    name, email, phone, address,
    currency: selectedCurrency,
    items: quote.items,
    total: subtotal,
    status: "placed",
    source: quoteId ? `quote:${quoteId}` : 'cart',
    createdAt: new Date().toISOString()
  };

  const txRef = "serac_" + Date.now();

  const fwConfig = {
    public_key: FLW_PUBLIC_KEY,
    tx_ref: txRef,
    amount: Number(subtotal),
    currency: selectedCurrency,
    customer: { email: email, phonenumber: phone, name: name },
    customizations: { title: "SÃ©rac", description: "Order Payment", logo: "../asset/logo.png" },

    callback: async function (data) {
      try {
        showSpinner(true);
        console.log("Payment callback data:", data);

        // Flutterwave returns a reference in different places; ensure we pick the tx_ref used
        const returnedTxRef = data.tx_ref || data.data?.tx_ref || txRef;

        // Instead of writing to Firestore here, call the Cloud Function to verify + finalize
        // POST body includes tx_ref and the baseOrder and optional quoteId so the server can create order & update quote
        const payload = {
          tx_ref: returnedTxRef,
          // Include optional Flutterwave identifiers if present (helps server verify exact transaction)
          flwRef: data.flw_ref || data.transaction_id || data.transactionId || data.data?.id || null,
          orderData: baseOrder,
          quoteId: quoteId || null
        };

        // call cloud function (POST)
        const res = await fetch(CLOUD_FN_VERIFY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`Server error: ${res.status} â€” ${errText}`);
        }

        const resJson = await res.json();
        console.log("Verification function response:", resJson);

        if (resJson.status === 'success' && resJson.orderId) {
          // Success: server verified payment and created order
          // Clear client cart (localStorage) and set UI to paid summary view
          try { localStorage.removeItem(STORAGE_KEY); } catch(e){ console.warn("localStorage clear failed", e); }
          cartCountElem.textContent = '0';

          // Update UI: show paid order summary â€” try to load the saved order doc to show details
          if (resJson.orderDoc && Array.isArray(resJson.orderDoc.items)) {
            // server returned order doc for immediate render
            activeOrderRaw = resJson.orderDoc;
            quote = { items: activeOrderRaw.items };
            isPaidOrder = true;
            renderOrderFromQuoteNormalized(quote, selectedCurrency, true);
          } else {
            // fallback: show the local baseOrder as summary (server is source of truth; but we still show)
            activeOrderRaw = { ...baseOrder, status: "paid" };
            quote = { items: baseOrder.items };
            isPaidOrder = true;
            renderOrderFromQuoteNormalized(quote, selectedCurrency, true);
          }

          // UI changes (hero etc)
          hero.classList.add('paid');
          heroH1.textContent = "Order Summary";
          heroP.textContent = "Your order has been paid successfully.";
          payBtn.textContent = "Paid âœ…";
          payBtn.disabled = true;
          payBtn.classList.add('paid-state');

          showSpinner(false);
          // Redirect to thank-you page optionally
          window.location.href = "../thankyou.html";
          return;
        } else {
          throw new Error(resJson.message || 'Payment verification failed on server.');
        }

      } catch (err) {
        console.error("Payment verification or finalize failed:", err);
        showSpinner(false);
        payBtn.disabled = false;
        showError("Payment possibly succeeded but verification failed. Please contact support with your transaction reference.");
      }
    },

    onclose: () => {
      // user closed the payment window
      console.log("Payment window closed by user");
      payBtn.disabled = false;
      showSpinner(false);
    }
  };

  try {
    if (typeof FlutterwaveCheckout === 'function') {
      FlutterwaveCheckout(fwConfig);
    } else {
      throw new Error("Payment gateway not loaded");
    }
  } catch(err) {
    showSpinner(false);
    payBtn.disabled = false;
    console.error("Flutterwave invocation failed", err);
    showError("Payment gateway is unavailable. Please try again later.");
  }
});

/* currency change (affects displayed totals) */
currencySelect.addEventListener('change', () => {
  selectedCurrency = currencySelect.value;
  localStorage.setItem(CURRENCY_KEY, selectedCurrency);
  // re-render current quote/order summary
  if (quote) renderOrderFromQuoteNormalized(quote, selectedCurrency, isPaidOrder);
});

/* header & hamburger wiring + init */
window.addEventListener('scroll', () => {
  const header = document.querySelector('.site-header');
  if (!header) return;
  if (window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
});
const hamburger = document.getElementById('hamburger');
const headerRight = document.getElementById('headerRight');
hamburger.addEventListener('click', ()=> {
  hamburger.classList.toggle('open');
  headerRight.classList.toggle('open');
});

/* Initialize */
(async function init(){
  // Ensure currency select matches stored value
  try { currencySelect.value = selectedCurrency; } catch(e){}
  // initialize cart count from localStorage
  try { cartCountElem.textContent = (JSON.parse(localStorage.getItem(STORAGE_KEY)) || []).reduce((s,i)=>s + Number(i.quantity || 0), 0); } catch(e){ cartCountElem.textContent = '0'; }
  await loadCheckoutData();
})();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Fleur De Vie</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
    h1, h2, h3 { margin-top: 0; }
    .section { background:#fff; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    label { display:block; margin-top:10px; font-weight:bold;}
    input, select, textarea { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:4px; }
    button { margin-top:10px; padding:8px 12px; border:none; border-radius:4px; background:#333; color:#fff; cursor:pointer;}
    button:hover { background:#555; }
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    th { background:#eee; }
    .actions button { margin-right:5px; }
  </style>
</head>
<body>
  <h1>Admin Dashboard - Fleur De Vie</h1>

  <!-- PRODUCTS -->
  <div class="section" id="productsSection">
    <h2>Products</h2>
    <form id="productForm">
      <label>Name</label>
      <input type="text" id="productName" required>
      <label>Description</label>
      <textarea id="productDesc" required></textarea>
      <label>Price (NGN)</label>
      <input type="number" id="productPriceNGN" step="0.01" required>
      <label>Price (USD)</label>
      <input type="number" id="productPriceUSD" step="0.01">
      <label>Price (EUR)</label>
      <input type="number" id="productPriceEUR" step="0.01">
      <label>Price (GBP)</label>
      <input type="number" id="productPriceGBP" step="0.01">
      <label>Image URL</label>
      <input type="text" id="productImage" required>
      <button type="submit">Add Product</button>
    </form>

    <h3>All Products</h3>
    <table id="productsTable">
      <thead>
        <tr>
          <th>Name</th><th>Description</th><th>NGN</th><th>USD</th><th>EUR</th><th>GBP</th><th>Image</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ORDERS -->
  <div class="section" id="ordersSection">
    <h2>Orders</h2>
    <input type="text" id="orderSearch" placeholder="Search by customer/email">
    <select id="orderStatusFilter">
      <option value="">All statuses</option>
      <option value="pending">Pending</option>
      <option value="paid">Paid</option>
      <option value="shipped">Shipped</option>
    </select>
    <button id="exportBtn">Export CSV</button>
    <label>From</label><input type="date" id="exportFrom">
    <label>To</label><input type="date" id="exportTo">
    <label>Currency</label>
    <select id="exportCurrency">
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
    </select>

    <table id="ordersTable">
      <thead>
        <tr>
          <th>ID</th><th>Customer</th><th>Email</th><th>Total</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- QUOTES -->
  <div class="section" id="quotesSection">
    <h2>Quotes</h2>
    <form id="quoteForm">
      <label>Customer Name</label>
      <input type="text" id="quoteCustomerName" required>
      <label>Customer Email</label>
      <input type="email" id="quoteCustomerEmail" required>
    </form>

    <div id="addQuoteItem">
      <h3>Add Item</h3>
      <input type="text" id="quoteItemName" placeholder="Item name" required>
      <input type="number" id="quoteItemQty" placeholder="Quantity" required>
      <input type="text" id="quoteItemDesc" placeholder="Description">
      <input type="number" id="quoteItemPriceNGN" placeholder="Price (NGN)" step="0.01">
      <input type="number" id="quoteItemPriceUSD" placeholder="Price (USD)" step="0.01">
      <input type="number" id="quoteItemPriceEUR" placeholder="Price (EUR)" step="0.01">
      <input type="number" id="quoteItemPriceGBP" placeholder="Price (GBP)" step="0.01">
      <button type="button" id="addQuoteItemBtn">Add Item</button>
    </div>

    <h3>Quote Items</h3>
    <table id="quoteItemsTable">
      <thead>
        <tr>
          <th>Name</th><th>Qty</th><th>Description</th><th>NGN</th><th>USD</th><th>EUR</th><th>GBP</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button type="button" id="generateQuoteBtn">Generate Quote Link</button>
    <div id="quoteLinkContainer" style="margin-top:10px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ---------------- PRODUCTS ---------------- */
    const productForm = document.getElementById("productForm");
    const productsTableBody = document.querySelector("#productsTable tbody");

    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newProduct = {
        name: productName.value,
        desc: productDesc.value,
        priceNGN: parseFloat(productPriceNGN.value) || 0,
        priceUSD: parseFloat(productPriceUSD.value) || 0,
        priceEUR: parseFloat(productPriceEUR.value) || 0,
        priceGBP: parseFloat(productPriceGBP.value) || 0,
        image: productImage.value
      };
      try {
        await addDoc(collection(db, "brands", "fleurdevie", "products"), newProduct);
        productForm.reset();
      } catch (err) {
        console.error(err);
        alert("Error adding product");
      }
    });

    function subscribeProducts() {
      const ref = collection(db, "brands", "fleurdevie", "products");
      onSnapshot(ref, snap => {
        productsTableBody.innerHTML = "";
        snap.forEach(docSnap => {
          const p = { id: docSnap.id, ...docSnap.data() };
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${p.name}</td>
            <td>${p.desc}</td>
            <td>${p.priceNGN}</td>
            <td>${p.priceUSD}</td>
            <td>${p.priceEUR}</td>
            <td>${p.priceGBP}</td>
            <td><img src="${p.image}" width="50"></td>
            <td class="actions"><button onclick="deleteProduct('${p.id}')">Delete</button></td>
          `;
          productsTableBody.appendChild(row);
        });
      });
    }
    window.deleteProduct = async (id) => {
      if (!confirm("Delete this product?")) return;
      await deleteDoc(doc(db, "brands", "fleurdevie", "products", id));
    };
    subscribeProducts();

    /* ---------------- ORDERS ---------------- */
    let allOrders = [];
    const ordersTableBody = document.querySelector("#ordersTable tbody");
    const orderSearch = document.getElementById("orderSearch");
    const orderStatusFilter = document.getElementById("orderStatusFilter");
    const exportBtn = document.getElementById("exportBtn");
    const exportFrom = document.getElementById("exportFrom");
    const exportTo = document.getElementById("exportTo");
    const exportCurrency = document.getElementById("exportCurrency");

    function subscribeOrders() {
      const ordersRef = collection(db, "brands", "fleurdevie", "orders");
      onSnapshot(ordersRef, snap => {
        allOrders = [];
        snap.forEach(docSnap => {
          allOrders.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderOrdersTable();
      });
    }
    function renderOrdersTable() {
      const searchVal = orderSearch.value.toLowerCase().trim();
      const statusVal = orderStatusFilter.value;
      ordersTableBody.innerHTML = "";
      allOrders.filter(o => {
        const matchesSearch = !searchVal || (o.customer && o.customer.toLowerCase().includes(searchVal)) || (o.email && o.email.toLowerCase().includes(searchVal));
        const matchesStatus = !statusVal || o.status === statusVal;
        return matchesSearch && matchesStatus;
      }).forEach(o => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${o.id}</td>
          <td>${o.customer || ""}</td>
          <td>${o.email || ""}</td>
          <td>${o.total || ""} ${o.currency || "NGN"}</td>
          <td>${o.status || ""}</td>
          <td class="actions">
            <button onclick="deleteOrder('${o.id}')">Delete</button>
            <button onclick="viewOrder('${o.id}')">View</button>
          </td>
        `;
        ordersTableBody.appendChild(row);
      });
    }
    orderSearch.addEventListener("input", renderOrdersTable);
    orderStatusFilter.addEventListener("change", renderOrdersTable);
    window.deleteOrder = async (id) => {
      if (!confirm("Delete this order?")) return;
      await deleteDoc(doc(db, "brands", "fleurdevie", "orders", id));
    };
    window.viewOrder = async (id) => {
      const docSnap = await getDoc(doc(db, "brands", "fleurdevie", "orders", id));
      if (!docSnap.exists()) return alert("Order not found");
      alert(JSON.stringify(docSnap.data(), null, 2));
    };
    exportBtn.addEventListener("click", () => {
      const fromDate = exportFrom.value ? new Date(exportFrom.value) : null;
      const toDate = exportTo.value ? new Date(exportTo.value) : null;
      const curr = exportCurrency.value || "NGN";
      let csv = "OrderID,Customer,Email,Total,Status\n";
      allOrders.forEach(o => {
        const createdAt = o.createdAt ? new Date(o.createdAt) : null;
        if (fromDate && createdAt && createdAt < fromDate) return;
        if (toDate && createdAt && createdAt > toDate) return;
        csv += `${o.id},"${o.customer}","${o.email}",${o.total} ${curr},${o.status}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "orders.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
    subscribeOrders();

    /* ---------------- QUOTES ---------------- */
    let currentQuoteItems = [];
    const quoteCustomerName = document.getElementById("quoteCustomerName");
    const quoteCustomerEmail = document.getElementById("quoteCustomerEmail");
    const quoteItemName = document.getElementById("quoteItemName");
    const quoteItemQty = document.getElementById("quoteItemQty");
    const quoteItemDesc = document.getElementById("quoteItemDesc");
    const quoteItemPriceNGN = document.getElementById("quoteItemPriceNGN");
    const quoteItemPriceUSD = document.getElementById("quoteItemPriceUSD");
    const quoteItemPriceEUR = document.getElementById("quoteItemPriceEUR");
    const quoteItemPriceGBP = document.getElementById("quoteItemPriceGBP");
    const addQuoteItemBtn = document.getElementById("addQuoteItemBtn");
    const quoteItemsTable = document.getElementById("quoteItemsTable");
    const generateQuoteBtn = document.getElementById("generateQuoteBtn");
    const quoteLinkContainer = document.getElementById("quoteLinkContainer");
    const quoteForm = document.getElementById("quoteForm");

    addQuoteItemBtn.addEventListener("click", () => {
      const name = quoteItemName.value.trim();
      const qty = parseInt(quoteItemQty.value, 10) || 0;
      const desc = quoteItemDesc.value.trim();
      const priceNGN = parseFloat(quoteItemPriceNGN.value) || 0;
      const priceUSD = parseFloat(quoteItemPriceUSD.value) || 0;
      const priceEUR = parseFloat(quoteItemPriceEUR.value) || 0;
      const priceGBP = parseFloat(quoteItemPriceGBP.value) || 0;
      if (!name || !qty) return alert("Item name and quantity required");
      currentQuoteItems.push({ name, qty, desc, priceNGN, priceUSD, priceEUR, priceGBP });
      renderQuoteItems();
      quoteItemName.value = "";
      quoteItemQty.value = "";
      quoteItemDesc.value = "";
      quoteItemPriceNGN.value = "";
      quoteItemPriceUSD.value = "";
      quoteItemPriceEUR.value = "";
      quoteItemPriceGBP.value = "";
    });

    function renderQuoteItems() {
      quoteItemsTable.querySelector("tbody").innerHTML = "";
      currentQuoteItems.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.desc || ""}</td>
          <td>${item.priceNGN || ""}</td>
          <td>${item.priceUSD || ""}</td>
          <td>${item.priceEUR || ""}</td>
          <td>${item.priceGBP || ""}</td>
          <td><button onclick="removeQuoteItem(${i})">Remove</button></td>
        `;
        quoteItemsTable.querySelector("tbody").appendChild(row);
      });
    }
    window.removeQuoteItem = (i) => {
      currentQuoteItems.splice(i, 1);
      renderQuoteItems();
    };

    generateQuoteBtn.addEventListener("click", async () => {
      const customerName = quoteCustomerName.value.trim();
      const customerEmail = quoteCustomerEmail.value.trim();
      if (!customerName || !customerEmail) return alert("Customer info required");
      if (!currentQuoteItems.length) return alert("Please add at least one item");
      const quoteData = { customerName, customerEmail, items: currentQuoteItems, createdAt: Date.now() };
      try {
        const quotesRef = collection(db, "brands", "fleurdevie", "quotes");
        const docRef = await addDoc(quotesRef, quoteData);
        const quoteId = docRef.id;
        const url = `checkout.html?quoteId=${quoteId}`;
        quoteLinkContainer.innerHTML = `
          Quote link: <a href="${url}" target="_blank">${url}</a>
          <button id="copyQuoteLink">📋</button>
        `;
        document.getElementById("copyQuoteLink").addEventListener("click", () => {
          navigator.clipboard.writeText(url).then(() => alert("Link copied!"));
        });
        currentQuoteItems = [];
        renderQuoteItems();
        quoteForm.reset();
      } catch (err) {
        console.error(err);
        alert("❌ Error saving quote.");
      }
    });
  </script>
</body>
</html>
